<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-visual">
<title>è¿´æ­¸ç·š v2.0</title>
<style>
:root {
  --primary-color: #5e35b1;
  --primary-light: #9162e4;
  --primary-dark: #280680;
  --primary-gradient: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
  background: linear-gradient(135deg, #9b8fa5 0%, #bdb3c3 100%);
  min-height: 100vh;
  min-height: 100dvh; /* Dynamic viewport height for mobile browsers */
  padding-bottom: max(80px, env(safe-area-inset-bottom));
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  transition: all 0.3s ease;
  /* Mobile optimizations */
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior-y: contain;
  touch-action: manipulation;
  position: relative;
}

/* æ˜Ÿç©ºæ•ˆæœ (åªåœ¨å¤œé–“é¡¯ç¤º) */
body::before {
  display: none; /* ç™½å¤©éš±è— */
}

@keyframes starTwinkle {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

/* === æš—é»‘æ¨¡å¼æ¨£å¼ === */
body.dark-mode {
  background: linear-gradient(135deg, #3a3348 0%, #4d4459 100%);
  color: #bdb3c3;
}

body.dark-mode::before {
  display: block; /* å¤œé–“é¡¯ç¤º */
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  background-image:
    radial-gradient(circle, rgba(255, 255, 255, 0.9) 2px, transparent 2px),
    radial-gradient(circle, rgba(255, 255, 200, 0.8) 1.5px, transparent 1.5px),
    radial-gradient(circle, rgba(200, 200, 255, 0.7) 1px, transparent 1px);
  background-size: 250px 250px, 350px 350px, 500px 500px;
  background-position: 0 0, 50px 80px, 150px 200px;
  animation: starTwinkle 6s ease-in-out infinite;
  z-index: 0;
}

body.dark-mode .header {
  background: linear-gradient(135deg, #4d4459 0%, #5d5469 100%);
}

body.dark-mode .section {
  background: rgba(61, 51, 66, 0.6);
  border-color: rgba(94, 53, 177, 0.3);
}

body.dark-mode .section-title {
  color: #ffffff;
}

body.dark-mode .leave-tag {
  background: linear-gradient(135deg, #c62828 0%, #e53935 100%);
}

body.dark-mode .empty-hint {
  color: rgba(255, 255, 255, 0.7);
}

body.dark-mode .time-slot {
  background: rgba(61, 51, 66, 0.6);
  border-color: rgba(189, 179, 195, 0.3);
}

body.dark-mode .time-slot-header {
  background: linear-gradient(135deg, #4d4459 0%, #5d5469 100%);
}

body.dark-mode .person-item {
  background: rgba(61, 51, 66, 0.6);
  border-color: rgba(189, 179, 195, 0.3);
}

body.dark-mode .person-checkbox {
  background: rgba(44, 36, 47, 0.8);
  border-color: rgba(189, 179, 195, 0.4);
}

body.dark-mode .person-checkbox.selected {
  background: linear-gradient(135deg, #4d4459 0%, #5d5469 100%);
}

body.dark-mode .person-card {
  background: linear-gradient(135deg, rgba(61, 51, 66, 0.7) 0%, rgba(44, 36, 47, 0.9) 100%);
  border-color: rgba(189, 179, 195, 0.3);
}

body.dark-mode .person-card.on-leave {
  background: linear-gradient(135deg, #4a2c2c 0%, #5d3535 100%);
  border-color: #c62828;
}

body.dark-mode .person-card-name,
body.dark-mode .person-name {
  color: #ffffff;
}

body.dark-mode .input-text {
  background: rgba(61, 51, 66, 0.6);
  border-color: rgba(189, 179, 195, 0.3);
  color: #d4cad9;
}

body.dark-mode .input-text::placeholder {
  color: #7f8c8d;
}

body.dark-mode .btn-primary {
  background: linear-gradient(135deg, #7a6b8f 0%, #8a7b9f 100%);
}

body.dark-mode .template-item {
  background: rgba(61, 51, 66, 0.7);
  border-color: #7a6f80;
}

body.dark-mode .template-name {
  color: #b39ddb;
}

body.dark-mode .template-desc {
  color: #9fa8b2;
}

body.dark-mode .modal-box {
  background: rgba(61, 51, 66, 0.6);
}

body.dark-mode .modal-title {
  color: #b39ddb;
}

/* æš—é»‘æ¨¡å¼ - æ‰¹æ¬¡æ“ä½œå€å¡Š */
body.dark-mode .collapsible-section {
  border-color: rgba(33, 150, 243, 0.4);
  background: rgba(61, 51, 66, 0.7);
}

body.dark-mode .collapsible-header {
  background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%) !important;
}

body.dark-mode .collapsible-title,
body.dark-mode .collapsible-title span {
  color: #2d1b3a !important;
}

body.dark-mode #batchSelectedCount {
  background: #2196f3 !important;
}

body.dark-mode .person-item {
  background: rgba(61, 51, 66, 0.6) !important;
  border-color: rgba(189, 179, 195, 0.3);
}

body.dark-mode .person-item:nth-child(even) {
  background: rgba(44, 36, 47, 0.8) !important;
}

/* æš—é»‘æ¨¡å¼ - æ‰¹æ¬¡é¸ä¸­çš„äººå“¡é …ç›® */
body.dark-mode .person-item[style*="linear-gradient(135deg, #e3f2fd"] {
  background: linear-gradient(135deg, rgba(85, 74, 95, 0.8) 0%, rgba(106, 95, 112, 0.8) 100%) !important;
  border-color: rgba(189, 179, 195, 0.5) !important;
}

.header {
  background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%);
  padding: 16px 20px;
  box-shadow: 0 4px 12px rgba(94, 53, 177, 0.3);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-title {
  font-size: 22px;
  color: #ffffff;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 700;
}

/* åœ–ç¤ºæŒ‰éˆ•ï¼ˆæš—è‰²æ¨¡å¼ã€å¤šæ—¥è¦åŠƒï¼‰ */
.icon-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: white;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.icon-btn:active {
  transform: scale(0.95);
}

.theme-toggle {
  transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.theme-toggle:hover {
  transform: rotate(180deg) scale(1.1);
}

/* æ—¥æœŸé¡¯ç¤ºå€å¡Š */
.date-section {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 12px;
}

.date-display {
  flex: 1;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 16px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.date-display:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-color: var(--primary-color);
}

.date-text {
  font-size: 15px;
  font-weight: 700;
  color: var(--primary-color);
  flex: 1;
}

.weekday-badge {
  background: var(--primary-gradient);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

.quick-date-nav {
  display: flex;
  gap: 6px;
}

.quick-date-nav button {
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid rgba(255, 255, 255, 0.4);
  border-radius: 10px;
  color: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.quick-date-nav button:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.quick-date-nav button:active {
  transform: translateY(0);
}

.date-input {
  display: none;
}

.tab-nav {
  display: flex;
  gap: 5px;
  margin-top: 12px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.tab-btn {
  padding: 12px 20px;
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.tab-btn.active {
  color: #ffffff;
  border-bottom-color: #ffc107;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.section {
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 16px rgba(94, 53, 177, 0.1);
  border: 2px solid rgba(94, 53, 177, 0.1);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: #5e35b1;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.collapsible-section {
  border: 2px solid rgba(94, 53, 177, 0.2);
  border-radius: 16px;
  margin-bottom: 16px;
  overflow: hidden;
  background: white;
  transition: all 0.3s ease;
}

.collapsible-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  min-height: 56px;
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
  cursor: pointer;
  user-select: none;
  transition: all 0.3s;
  -webkit-tap-highlight-color: transparent;
}

.collapsible-header:hover {
  background: linear-gradient(135deg, #e1bee7 0%, #ce93d8 100%);
}

.collapsible-header:active {
  transform: scale(0.99);
}

.collapsible-title {
  font-size: 16px;
  font-weight: 700;
  color: #5e35b1;
  display: flex;
  align-items: center;
  gap: 8px;
}

.collapsible-arrow {
  font-size: 18px;
  color: #5e35b1;
  transition: transform 0.3s;
}

.collapsible-arrow.expanded {
  transform: rotate(180deg);
}

.collapsible-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, padding 0.4s ease;
  padding: 0 20px;
}

.collapsible-content.expanded {
  max-height: 2000px;
  padding: 20px;
}

.leave-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  min-height: 40px;
  align-items: center;
}

.leave-tag {
  background: linear-gradient(135deg, #e53935 0%, #f44336 100%);
  color: white;
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(229, 57, 53, 0.3);
}

.empty-hint {
  color: #9575cd;
  font-size: 14px;
  font-weight: 600;
}

.time-slots {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.time-slot-badge {
  background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%);
  color: white;
  padding: 10px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 2px 6px rgba(94, 53, 177, 0.3);
}

.btn-sm {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  background: #ff9800;
  color: white;
}

.person-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.person-row {
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
  border: 2px solid #ce93d8;
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.person-row-header {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
}

.person-name {
  font-size: 15px;
  font-weight: 700;
  color: #5e35b1;
  min-width: 100px;
  flex: 1;
}


.time-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  flex: 1;
}

.time-btn {
  padding: 10px 16px;
  border: 2px solid #ce93d8;
  background: #ffffff;
  color: #5e35b1;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 100px;
  text-align: center;
}

.time-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(94, 53, 177, 0.2);
}

.time-btn:active {
  transform: scale(0.95);
}

.time-btn.completed:active {
  transform: scale(0.98);
  box-shadow: 0 2px 8px rgba(76, 175, 80, 0.6);
}

.time-btn.scheduled {
  background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
  color: #3e2723;
  border-color: #ffc107;
  box-shadow: 0 2px 6px rgba(255, 193, 7, 0.3);
}

.time-btn.completed {
  background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
  color: white;
  border-color: #4caf50;
  border-width: 3px;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.5);
  font-weight: 700;
  position: relative;
}

.time-btn.completed::before {
  content: 'âœ“ ';
  font-size: 16px;
  font-weight: 900;
  margin-right: 4px;
}

.person-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  margin-top: 12px;
}

.person-card {
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
  border: 2px solid #ce93d8;
  border-radius: 12px;
  padding: 12px;
  text-align: center;
  transition: all 0.3s;
  position: relative;
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
}

.person-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(94, 53, 177, 0.2);
}

.person-card.on-leave {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  border-color: #ef5350;
  opacity: 0.6;
}

.person-card-name {
  font-size: 14px;
  font-weight: 700;
  color: #5e35b1;
  margin-bottom: 8px;
}

.person-actions {
  display: flex;
  gap: 4px;
  justify-content: center;
}

.person-action-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-leave {
  background: #ffc107;
  color: #3e2723;
}

.btn-remove {
  background: #dc3545;
  color: white;
}

.input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
}

.input-text {
  flex: 1;
  padding: 12px;
  border: 2px solid #ce93d8;
  border-radius: 10px;
  font-size: 14px;
  background: #ffffff;
  font-weight: 600;
  color: #5e35b1;
}

.btn-primary {
  padding: 12px 20px;
  background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(94, 53, 177, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(94, 53, 177, 0.4);
}

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%);
  padding: 12px 20px;
  box-shadow: 0 -4px 12px rgba(94, 53, 177, 0.3);
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 14px;
  z-index: 99;
}

.footer-btn {
  padding: 14px;
  min-height: 52px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  color: white;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}

.footer-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.footer-btn:active {
  transform: translateY(0) scale(0.98);
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
}

.btn-preview {
  background: linear-gradient(135deg, #ffd54f 0%, #ffca28 100%);
  color: #3e2723;
}

.btn-copy {
  background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
  color: white;
}

.btn-line {
  background: linear-gradient(135deg, #06C755 0%, #00B900 100%);
  color: white;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(94, 53, 177, 0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.show { display: flex; }

.modal-box {
  background: #ffffff;
  border-radius: 20px;
  padding: 24px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  border: 3px solid #5e35b1;
  box-shadow: 0 10px 40px rgba(94, 53, 177, 0.3);
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
  color: #5e35b1;
}

.modal-content pre {
  background: #f3e5f5;
  padding: 16px;
  border-radius: 12px;
  white-space: pre-wrap;
  font-family: inherit;
  color: #5e35b1;
  line-height: 1.8;
}

.manage-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.manage-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f5f5f5;
  border-radius: 8px;
}

.manage-item-name {
  flex: 1;
  font-weight: 600;
  color: #5e35b1;
}

.btn-icon {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  font-weight: 600;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-edit {
  background: #ff9800;
  color: white;
}

.btn-delete {
  background: #dc3545;
  color: white;
}

.template-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.template-item {
  background: #f3e5f5;
  border: 2px solid #ce93d8;
  border-radius: 12px;
  padding: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.template-info {
  flex: 1;
}

.template-name {
  font-size: 16px;
  font-weight: 700;
  color: #5e35b1;
  margin-bottom: 4px;
}

.template-desc {
  font-size: 12px;
  color: #9575cd;
}

.template-actions {
  display: flex;
  gap: 6px;
}

.template-btn {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-apply {
  background: #7e57c2;
  color: white;
}

/* å¤šæ—¥æ¨¡å¼æ¨™ç±¤ */
.multi-day-tabs {
  margin-top: 12px;
  padding: 10px 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.tabs-label {
  color: white;
  font-size: 13px;
  font-weight: 700;
  white-space: nowrap;
}

.date-tabs {
  flex: 1;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.date-tab {
  padding: 6px 14px;
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 10px;
  color: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.date-tab:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-1px);
}

.date-tab.active {
  background: rgba(255, 255, 255, 0.35);
  border-color: rgba(255, 255, 255, 0.8);
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.exit-btn {
  padding: 6px 12px;
  background: rgba(255, 87, 87, 0.85);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}

.exit-btn:hover {
  background: rgba(255, 87, 87, 1);
  transform: scale(1.05);
}

.exit-btn:active {
  transform: scale(0.95);
}

@media (max-width: 768px) {
  .container {
    padding: 12px;
  }
  
  .person-grid {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
  }
  
  .footer {
    flex-direction: column;
    gap: 10px;
  }
  
  .footer-btn {
    padding: 16px;
    font-size: 16px;
  }
  
  .person-row {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .time-buttons {
    width: 100%;
  }
  
  .time-btn {
    flex: 1;
    min-width: 80px;
  }
}

/* === iOS é¢¨æ ¼é è¦½å½ˆçª— === */
.ios-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 10000;
  display: flex;
  align-items: flex-end;
  animation: iosFadeIn 0.3s ease;
}

.ios-modal {
  width: 100%;
  background: white;
  border-radius: 20px 20px 0 0;
  padding: 20px;
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  animation: iosSlideUp 0.3s ease;
}

.ios-modal-title {
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 16px;
  color: #333;
}

.ios-modal-content {
  background: #F5F5F5;
  padding: 16px;
  border-radius: 12px;
  max-height: 50vh;
  overflow-y: auto;
  margin-bottom: 16px;
  font-family: 'Courier New', 'Menlo', monospace;
  white-space: pre-wrap;
  line-height: 1.6;
  font-size: 14px;
  color: #333;
  -webkit-overflow-scrolling: touch;
}

.ios-btn-line {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #00B900 0%, #00E600 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  cursor: pointer;
  transition: transform 0.1s ease, opacity 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 185, 0, 0.3);
}

.ios-btn-copy {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #A1887F 0%, #BCAAA4 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  cursor: pointer;
  transition: transform 0.1s ease, opacity 0.2s ease;
  box-shadow: 0 2px 8px rgba(161, 136, 127, 0.3);
}

.ios-btn-line:active,
.ios-btn-copy:active {
  transform: scale(0.98);
  opacity: 0.9;
}

.ios-btn-cancel {
  width: 100%;
  padding: 12px;
  background: transparent;
  color: #999;
  border: none;
  font-size: 14px;
  cursor: pointer;
  transition: opacity 0.2s ease;
}

.ios-btn-cancel:active {
  opacity: 0.6;
}

@keyframes iosFadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes iosSlideUp {
  from {
    transform: translateY(100%);
  }
  to {
    transform: translateY(0);
  }
}

@keyframes iosFadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

/* Toast æç¤ºæ¨£å¼ */
.toast {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 12px 24px;
  border-radius: 24px;
  font-size: 14px;
  font-weight: 600;
  z-index: 10000;
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events: none;
  white-space: nowrap;
  max-width: 80%;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.toast.success {
  background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
}

.toast.error {
  background: linear-gradient(135deg, #ef5350 0%, #e57373 100%);
}

.toast.warning {
  background: linear-gradient(135deg, #ffa726 0%, #ffb74d 100%);
}

@keyframes iosSlideDown {
  from {
    transform: translateY(0);
  }
  to {
    transform: translateY(100%);
  }
}

/* æš—é»‘æ¨¡å¼ä¸‹çš„ iOS å½ˆçª— */
body.dark-mode .ios-modal {
  background: rgba(61, 51, 66, 0.6);
}

body.dark-mode .ios-modal-title {
  color: #e0e0e0;
}

body.dark-mode .ios-modal-content {
  background: #1a1f2e;
  color: #e0e0e0;
}

/* è¼‰å…¥ç•«é¢ */
#loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

#loading-screen.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(94, 53, 177, 0.2);
  border-top-color: #5e35b1;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 20px;
  font-size: 16px;
  font-weight: 600;
  color: #5e35b1;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">
    â° è¿´æ­¸ç·š
    <div style="display: flex; gap: 8px;">
      <a href="index.html" class="icon-btn" title="å›é¦–é " style="text-decoration: none; display: flex; align-items: center; justify-content: center;">
        ğŸ 
      </a>
      <button class="icon-btn theme-toggle" onclick="toggleTheme()" id="themeToggle" title="åˆ‡æ›ä¸»é¡Œ">
        <span id="themeIcon">ğŸŒ™</span>
      </button>
      <button class="icon-btn" onclick="openMultiDayPlanner()" title="å¤šæ—¥è¦åŠƒ">
        ğŸ“…
      </button>
      <button class="icon-btn" onclick="clearCache()" title="æ¸…é™¤æ”¶å‡è³‡æ–™">
        ğŸ—‘ï¸
      </button>
    </div>
  </div>

  <!-- éš±è—çš„åŸç”Ÿæ—¥æœŸè¼¸å…¥ -->
  <input type="date" class="date-input" id="dateInput">

  <!-- æ–°çš„æ—¥æœŸé¡¯ç¤ºUI -->
  <div class="date-section">
    <div class="date-display" id="dateDisplay" onclick="openDatePicker()">
      <span class="date-text" id="dateText">è¼‰å…¥ä¸­...</span>
      <span class="weekday-badge" id="weekdayBadge">-</span>
    </div>
    <div class="quick-date-nav">
      <button onclick="changeDate(-1)" title="å‰ä¸€å¤©">â—€</button>
      <button onclick="setToday()" title="å›åˆ°ä»Šå¤©">ä»Šå¤©</button>
      <button onclick="changeDate(1)" title="å¾Œä¸€å¤©">â–¶</button>
    </div>
  </div>

  <!-- å¤šæ—¥æ¨¡å¼æ¨™ç±¤ -->
  <div class="multi-day-tabs" id="dateTabsContainer" style="display: none;">
    <span class="tabs-label">ğŸ“… å¤šæ—¥æ¨¡å¼</span>
    <div class="date-tabs" id="dateTabs"></div>
    <button class="exit-btn" onclick="exitMultiDayMode()">âœ• é€€å‡º</button>
  </div>
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab(0)">ğŸ“… æ¯æ—¥æ”¶å‡</button>
    <button class="tab-btn" onclick="switchTab(1)">ğŸ“Š äº‹æ•…å›å ±</button>
    <button class="tab-btn" onclick="switchTab(2)">ğŸ‘¥ äººå“¡ç®¡ç†</button>
    <button class="tab-btn" onclick="switchTab(3)">ğŸ“ ç¯„æœ¬ç®¡ç†</button>
  </div>
</div>

<div class="container">
  <!-- Tab 1: ä¸»é é¢ -->
  <div class="tab-content active" id="tab0">
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('leave')">
        <div class="collapsible-title">ğŸ–ï¸ ä¼‘å‡äººå“¡</div>
        <div class="collapsible-arrow" id="arrow-leave">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-leave">
        <div class="leave-tags" id="leaveDisplay"></div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('timeslots')">
        <div class="collapsible-title" style="display: flex; align-items: center; gap: 8px; flex: 1;">
          â° æ”¶å‡æ™‚æ®µ
          <button class="btn-sm" onclick="event.stopPropagation(); manageTimeSlots()" style="margin-left: auto;">ç®¡ç†æ™‚æ®µ</button>
        </div>
        <div class="collapsible-arrow" id="arrow-timeslots">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-timeslots">
        <div class="time-slots" id="timeSlotDisplay"></div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('personlist')">
        <div class="collapsible-title">ğŸ“ äººå“¡é»é¸</div>
        <div class="collapsible-arrow" id="arrow-personlist">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-personlist">
        <div class="person-list" id="personList"></div>
      </div>
    </div>
  </div>

  <!-- Tab 2: äº‹æ•…å›å ± -->
  <div class="tab-content" id="tab1">
    <!-- åŸºæœ¬è³‡è¨Š - å¯æ”¶åˆ -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('basicInfo')">
        <div class="collapsible-title">
          <span>ğŸ“‹ åŸºæœ¬è³‡è¨Š</span>
        </div>
        <div class="collapsible-arrow" id="arrow-basicInfo">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-basicInfo">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; color: #666; margin-bottom: 4px;">å–®ä½åç¨±</label>
          <input type="text" id="incidentUnit" class="input-text" placeholder="å–®ä½åç¨±" value="" style="width: 100%;" onchange="saveIncidentUnit()">
        </div>

        <div style="margin-bottom: 12px;">
          <div style="font-size: 14px; font-weight: 600; color: #5e35b1; margin-bottom: 8px;">
            åˆ—å…¥çµ±è¨ˆ: <strong id="incidentPersonnelCount2">0 äºº</strong>
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 12px;">
            é¸æ“‡è¦åˆ—å…¥äº‹æ•…å›å ±çµ±è¨ˆçš„å›ºå®šäººå“¡åå–®
          </div>
        </div>

        <div style="margin-bottom: 12px;">
          <button onclick="selectAllIncidentPersonnel()" style="padding: 8px 16px; background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600;">å…¨é¸</button>
          <button onclick="deselectAllIncidentPersonnel()" style="padding: 8px 16px; background: linear-gradient(135deg, #757575 0%, #9e9e9e 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; margin-left: 8px;">å…¨ä¸é¸</button>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;" id="incidentPersonnelList"></div>
      </div>
    </div>

    <!-- äº‹æ•…é¡å‹ç®¡ç† - å¯æ”¶åˆ -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('incidentTypes')">
        <div class="collapsible-title">
          <span>ğŸ“Š äº‹æ•…é¡å‹ç®¡ç†</span>
        </div>
        <div class="collapsible-arrow" id="arrow-incidentTypes">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-incidentTypes">
        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">æ–°å¢äº‹æ•…é¡å‹</label>
          <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center;">
            <input type="text" id="newIncidentType" class="input-text" placeholder="äº‹æ•…é¡å‹åç¨±ï¼ˆä¾‹å¦‚ï¼šèˆªæµ·ã€ä¿®ç·´ã€åƒé£¯ï¼‰" style="width: 100%;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap; font-size: 13px;">
              <input type="checkbox" id="newIncidentCount" style="width: 24px; height: 24px;">
              <span>åˆ—å…¥çµ±è¨ˆ</span>
            </label>
            <button onclick="addIncidentType()" style="padding: 8px 16px; background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap;">
              â• æ–°å¢
            </button>
          </div>
          <div style="font-size: 12px; color: #666; margin-top: 6px;">
            ğŸ’¡ å‹¾é¸ã€Œåˆ—å…¥çµ±è¨ˆã€çš„é¡å‹æœƒè¨ˆå…¥ã€Œäº‹æ•…ã€äººæ•¸,æœªå‹¾é¸çš„æœƒè¨ˆå…¥ã€Œåœ¨ç‡Ÿã€äººæ•¸
          </div>
        </div>

        <div>
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">ç¾æœ‰äº‹æ•…é¡å‹</label>
          <div id="incidentTypesList"></div>
        </div>
      </div>
    </div>

    <!-- å¿«é€Ÿå¡«å¯«äº‹æ•… - å¯æ”¶åˆ -->
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('quickIncident')" style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);">
        <div class="collapsible-title">
          <span style="color: #6a1b9a;">ğŸ“Š å¿«é€Ÿå¡«å¯«äº‹æ•…</span>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button onclick="event.stopPropagation(); copyPreviousDayIncident();" style="padding: 8px 16px; background: linear-gradient(135deg, #42a5f5 0%, #64b5f6 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; white-space: nowrap; min-height: 40px;">
            ğŸ“‹ è¤‡è£½å‰æ—¥
          </button>
          <div class="collapsible-arrow" id="arrow-quickIncident">â–¼</div>
        </div>
      </div>
      <div class="collapsible-content expanded" id="content-quickIncident">

      <!-- æ‰¹æ¬¡æ“ä½œæ§åˆ¶å€ - å¯æ”¶åˆ(å·¢ç‹€) -->
      <div class="collapsible-section" style="border-color: #2196f3;">
        <div class="collapsible-header" onclick="toggleCollapse('batchControl')" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
          <div class="collapsible-title">
            <span style="color: #1976d2;">âš¡ æ‰¹æ¬¡æ“ä½œ</span>
            <span id="batchSelectedCount" style="background: #2196f3; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 8px;">0äºº</span>
          </div>
          <div class="collapsible-arrow" id="arrow-batchControl">â–¼</div>
        </div>
        <div class="collapsible-content" id="content-batchControl">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-size: 12px; color: #666;">é¸æ“‡äººå“¡å¾Œ,é»æ“Šäº‹æ•…é¡å‹æŒ‰éˆ•å³å¯æ‰¹æ¬¡è¨­å®š</div>
            <div>
              <button onclick="selectAllBatch()" style="padding: 6px 12px; background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; margin-right: 6px; min-height: 36px;">å…¨é¸</button>
              <button onclick="deselectAllBatch()" style="padding: 6px 12px; background: linear-gradient(135deg, #757575 0%, #9e9e9e 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; min-height: 36px;">å…¨ä¸é¸</button>
            </div>
          </div>
          <div id="batchIncidentTypes" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
        </div>
      </div>

      <div style="font-size: 13px; color: #666; margin-bottom: 12px;">
        ğŸ’¡ ç©ºç™½æˆ–é¸ã€Œåœ¨ç‡Ÿã€è¡¨ç¤ºè©²äººå“¡åœ¨ç‡Ÿã€‚åªæœ‰å‹¾é¸ã€Œåˆ—å…¥äº‹æ•…çµ±è¨ˆã€çš„é¡å‹æœƒè¨ˆå…¥äº‹æ•…äººæ•¸
      </div>
      <div id="incidentPersonnelForm"></div>
      </div> <!-- Close content-quickIncident -->
    </div> <!-- Close collapsible-section for å¿«é€Ÿå¡«å¯«äº‹æ•… -->

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('statistics')">
        <div class="collapsible-title">çµ±è¨ˆçµæœ</div>
        <div class="collapsible-arrow" id="arrow-statistics">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-statistics">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
          <div style="background: #e3f2fd; padding: 16px; border-radius: 12px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #1976d2;" id="incidentTotalCount">0</div>
            <div style="font-size: 13px; color: #666;">ç¾å“¡</div>
          </div>
          <div style="background: #e8f5e9; padding: 16px; border-radius: 12px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #388e3c;" id="incidentPresentCount">0</div>
            <div style="font-size: 13px; color: #666;">åœ¨ç‡Ÿ</div>
          </div>
          <div style="background: #fff3e0; padding: 16px; border-radius: 12px; text-align: center;">
            <div style="font-size: 28px; font-weight: 700; color: #f57c00;" id="incidentAwayCount">0</div>
            <div style="font-size: 13px; color: #666;">äº‹æ•…</div>
          </div>
        </div>
        <div id="incidentDetails" style="font-size: 14px; color: #666; padding: 12px; background: #f5f5f5; border-radius: 8px;"></div>
      </div>
    </div>

  </div>

  <!-- Tab 3: äººå“¡ç®¡ç† -->
  <div class="tab-content" id="tab2">
    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('addperson')">
        <div class="collapsible-title">æ–°å¢äººå“¡</div>
        <div class="collapsible-arrow" id="arrow-addperson">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-addperson">
        <div class="input-group">
          <input type="text" class="input-text" id="newPersonName" placeholder="è¼¸å…¥å§“å">
          <button class="voice-btn" onclick="startVoiceInput('newPersonName')">ğŸ¤ èªéŸ³</button>
          <button class="btn-primary" onclick="addPerson()">â• æ–°å¢</button>
        </div>
        <div class="input-group">
          <input type="text" class="input-text" id="batchPersonNames" placeholder="æ‰¹æ¬¡æ–°å¢ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰">
          <button class="voice-btn" onclick="startVoiceInput('batchPersonNames')">ğŸ¤ èªéŸ³</button>
          <button class="btn-primary" onclick="batchAddPersons()">ğŸ“¥ æ‰¹æ¬¡æ–°å¢</button>
        </div>
      </div>
    </div>

    <div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapse('persongrid')">
        <div class="collapsible-title">äººå“¡åˆ—è¡¨</div>
        <div class="collapsible-arrow" id="arrow-persongrid">â–¼</div>
      </div>
      <div class="collapsible-content" id="content-persongrid">
        <div class="person-grid" id="personGrid"></div>
      </div>
    </div>
  </div>

  <!-- Tab 4: ç¯„æœ¬ç®¡ç† -->
  <div class="tab-content" id="tab3">
    <div class="section">
      <div class="section-title">å„²å­˜ç•¶å‰æ™‚æ®µé…ç½®</div>
      <div class="input-group">
        <input type="text" class="input-text" id="templateName" placeholder="ç¯„æœ¬åç¨±ï¼ˆä¾‹å¦‚ï¼šå¹³æ—¥æ¨™æº–ï¼‰">
        <button class="btn-primary" onclick="saveTemplate()">ğŸ’¾ å„²å­˜</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">æˆ‘çš„ç¯„æœ¬</div>
      <div class="template-list" id="templateList"></div>
    </div>
  </div>
</div>

<div class="footer">
  <button class="footer-btn" onclick="preview()" style="background: linear-gradient(135deg, #FF9A56 0%, #FFD29D 100%);">
    æ”¶å‡ç‹€æ³
  </button>
  <button class="footer-btn" onclick="previewDetailReport()" style="background: linear-gradient(135deg, #E74C3C 0%, #EC7063 100%);">
    äººå“¡æ˜ç´°
  </button>
  <button class="footer-btn" onclick="previewSummaryReport()" style="background: linear-gradient(135deg, #F39C12 0%, #F8C471 100%);">
    çµ±è¨ˆå ±å‘Š
  </button>
  <button class="footer-btn" onclick="previewIncidentDetailReport()" style="background: linear-gradient(135deg, #E91E63 0%, #F48FB1 100%);">
    äº‹æ•…æ˜ç´°
  </button>
</div>

<div class="modal" id="modal" onclick="closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-title" id="modalTitle"></div>
    <div class="modal-content" id="modalContent"></div>
  </div>
</div>

<script>
// ========================================
// iOS é¢¨æ ¼é è¦½å½ˆçª—å‡½æ•¸
// ========================================

function showIOSPreview(title, content) {
  // ç§»é™¤èˆŠçš„å½ˆçª—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const existing = document.querySelector('.ios-modal-overlay');
  if (existing) existing.remove();

  // å‰µå»ºå½ˆçª—
  const overlay = document.createElement('div');
  overlay.className = 'ios-modal-overlay';

  const modal = document.createElement('div');
  modal.className = 'ios-modal';

  // è½‰ç¾©å…§å®¹ä¸­çš„ç‰¹æ®Šå­—ç¬¦
  const escapeContent = content.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');

  modal.innerHTML = `
    <div class="ios-modal-title">${title}</div>
    <div class="ios-modal-content">${content}</div>
    <button class="ios-btn-line" onclick="shareToLINE(\`${escapeContent}\`)">
      ğŸ“¤ è½‰å‚³åˆ° LINE
    </button>
    <button class="ios-btn-copy" onclick="copyToClipboard(\`${escapeContent}\`); closeIOSModal();">
      ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿
    </button>
    <button class="ios-btn-cancel" onclick="closeIOSModal()">å–æ¶ˆ</button>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  // é»æ“ŠèƒŒæ™¯é—œé–‰
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      closeIOSModal();
    }
  });
}

function closeIOSModal() {
  const overlay = document.querySelector('.ios-modal-overlay');
  if (overlay) {
    overlay.style.animation = 'iosFadeOut 0.3s ease';
    const modal = overlay.querySelector('.ios-modal');
    if (modal) {
      modal.style.animation = 'iosSlideDown 0.3s ease';
    }
    setTimeout(() => overlay.remove(), 300);
  }
}

function shareToLINE(text) {
  const url = `line://msg/text/${encodeURIComponent(text)}`;
  window.location.href = url;
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
  }).catch(err => {
    console.error('è¤‡è£½å¤±æ•—:', err);
    alert('âŒ è¤‡è£½å¤±æ•—');
  });
}

// ========================================
// åŸæœ‰ç¨‹å¼ç¢¼
// ========================================

let data = {
  personnel: [], // å°‡å¾ personnel_cache è¼‰å…¥
  onLeave: [], // æ ¼å¼ï¼š[{name: "ç‹å°æ˜", source: "auto"/"manual"}]
  timeSlots: ['2222', 'éš”å¤© 0555'],
  status: {},
  templates: {},
  // å¤šæ—¥è¦åŠƒç›¸é—œ
  statusByDate: {}, // { '2024-10-24': { timeSlots, status } }
  multiDayMode: false,
  selectedDates: [],
  currentDate: null
};

let draggedPersonIndex = null;
let recognition = null;
let currentVoiceInput = null;

// æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨ä¼‘å‡æœŸé–“å…§
function isDateInVacation(currentDate, vacationStart, vacationEnd) {
  if (!vacationStart || !vacationEnd) return false;

  // è§£æ MM/DD æ ¼å¼
  const parseDate = (dateStr) => {
    const [month, day] = dateStr.split('/').map(Number);
    return { month, day };
  };

  const current = {
    month: currentDate.getMonth() + 1,
    day: currentDate.getDate()
  };
  const start = parseDate(vacationStart);
  const end = parseDate(vacationEnd);

  // è™•ç†è·¨å¹´æƒ…æ³ï¼ˆä¾‹å¦‚ï¼š12/20 ~ 01/10ï¼‰
  if (start.month > end.month) {
    // è·¨å¹´ï¼šåœ¨é–‹å§‹æœˆä»½ä¹‹å¾Œï¼Œæˆ–åœ¨çµæŸæœˆä»½ä¹‹å‰
    return (current.month > start.month ||
            (current.month === start.month && current.day >= start.day) ||
            current.month < end.month ||
            (current.month === end.month && current.day <= end.day));
  } else {
    // åŒå¹´ï¼šåœ¨ç¯„åœå…§
    if (current.month < start.month || current.month > end.month) return false;
    if (current.month === start.month && current.day < start.day) return false;
    if (current.month === end.month && current.day > end.day) return false;
    return true;
  }
}

// ========== å¤šæ—¥è¦åŠƒåŠŸèƒ½ ==========

function openMultiDayPlanner() {
  const today = new Date();
  const html = `
    <div style="margin-bottom: 16px;">
      <div style="font-size: 14px; color: #666; margin-bottom: 12px;">é¸æ“‡è¦è¦åŠƒçš„æ—¥æœŸï¼ˆæœ€å¤š7å¤©ï¼‰</div>
      <div id="dateSelector" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
      </div>
      <div style="display: flex; gap: 8px; margin-top: 12px;">
        <button class="btn-primary" onclick="quickSelectDates(3)" style="flex: 1;">å¿«é¸3å¤©</button>
        <button class="btn-primary" onclick="quickSelectDates(7)" style="flex: 1;">å¿«é¸7å¤©</button>
      </div>
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="startMultiDayMode()">é–‹å§‹å¤šæ—¥è¦åŠƒ</button>
  `;

  showModal('å¤šæ—¥è¦åŠƒ', html);
  renderDateSelector();
}

function renderDateSelector() {
  const container = document.getElementById('dateSelector');
  if (!container) return;

  const today = new Date();
  const dates = [];

  // ç”Ÿæˆæœªä¾†14å¤©çš„æ—¥æœŸ
  for (let i = 0; i < 14; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    dates.push(date);
  }

  container.innerHTML = dates.map(date => {
    const dateStr = date.toISOString().split('T')[0];
    const isSelected = data.selectedDates.includes(dateStr);
    const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const weekday = weekdays[date.getDay()];
    const day = date.getDate();
    const month = date.getMonth() + 1;

    return `
      <div onclick="toggleDateSelection('${dateStr}')"
           id="date-${dateStr}"
           style="
             padding: 12px 8px;
             background: ${isSelected ? 'linear-gradient(135deg, #5e35b1 0%, #7e57c2 100%)' : '#f3e5f5'};
             color: ${isSelected ? 'white' : '#5e35b1'};
             border: 2px solid ${isSelected ? '#5e35b1' : '#ce93d8'};
             border-radius: 8px;
             cursor: pointer;
             text-align: center;
             font-size: 12px;
             font-weight: 600;
             transition: all 0.3s;
           "
           onmouseover="if(!this.id.includes('${data.selectedDates[0]}')) this.style.transform='translateY(-2px)'"
           onmouseout="this.style.transform='translateY(0)'">
        <div style="font-size: 11px; opacity: 0.8;">${month}/${day}</div>
        <div style="margin-top: 2px;">é€±${weekday}</div>
      </div>
    `;
  }).join('');
}

function toggleDateSelection(dateStr) {
  const index = data.selectedDates.indexOf(dateStr);

  if (index !== -1) {
    // å–æ¶ˆé¸æ“‡
    data.selectedDates.splice(index, 1);
  } else {
    // æ–°å¢é¸æ“‡
    if (data.selectedDates.length >= 7) {
      alert('æœ€å¤šåªèƒ½é¸æ“‡7å¤©');
      return;
    }
    data.selectedDates.push(dateStr);
  }

  // æ’åºæ—¥æœŸ
  data.selectedDates.sort();

  renderDateSelector();
}

function quickSelectDates(count) {
  const today = new Date();
  data.selectedDates = [];

  for (let i = 0; i < count; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    data.selectedDates.push(date.toISOString().split('T')[0]);
  }

  renderDateSelector();
}

function startMultiDayMode() {
  if (data.selectedDates.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ');
    return;
  }

  // åˆå§‹åŒ–æ¯å€‹æ—¥æœŸçš„è³‡æ–™çµæ§‹
  data.selectedDates.forEach(dateStr => {
    if (!data.statusByDate[dateStr]) {
      data.statusByDate[dateStr] = {
        timeSlots: JSON.parse(JSON.stringify(data.timeSlots)),
        status: {}
      };
    }
  });

  // è¨­å®šå¤šæ—¥æ¨¡å¼
  data.multiDayMode = true;
  data.currentDate = data.selectedDates[0];

  // å„²å­˜ç•¶å‰å–®æ—¥è³‡æ–™åˆ°ç¬¬ä¸€å€‹æ—¥æœŸï¼ˆå¦‚æœé‚„æ²’æœ‰çš„è©±ï¼‰
  if (Object.keys(data.statusByDate[data.currentDate].status).length === 0) {
    data.statusByDate[data.currentDate] = {
      timeSlots: JSON.parse(JSON.stringify(data.timeSlots)),
      status: JSON.parse(JSON.stringify(data.status))
    };
  }

  // è¼‰å…¥ç¬¬ä¸€å€‹æ—¥æœŸçš„è³‡æ–™
  loadDateData(data.currentDate);

  // é¡¯ç¤ºæ—¥æœŸæ¨™ç±¤
  renderDateTabs();
  document.getElementById('dateTabsContainer').style.display = 'block';

  save();
  closeModal();
  render();
}

function renderDateTabs() {
  const container = document.getElementById('dateTabs');
  if (!container) return;

  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

  container.innerHTML = data.selectedDates.map(dateStr => {
    const date = new Date(dateStr + 'T00:00:00');
    const [year, month, day] = dateStr.split('-');
    const weekday = weekdays[date.getDay()];
    const isActive = dateStr === data.currentDate;

    return `
      <button class="date-tab ${isActive ? 'active' : ''}" onclick="switchToDate('${dateStr}')">
        ${month}/${day} é€±${weekday}
      </button>
    `;
  }).join('');
}

function switchToDate(dateStr) {
  if (data.currentDate) {
    saveDateData(data.currentDate);
    // åŒæ™‚å„²å­˜äº‹æ•…å›å ±è³‡æ–™
    saveIncidentDateData(data.currentDate);
  }

  data.currentDate = dateStr;
  loadDateData(dateStr);

  // åŒæ­¥äº‹æ•…å›å ±çš„æ—¥æœŸ
  incidentData.currentDate = dateStr;
  // è¼‰å…¥è©²æ—¥æœŸçš„äº‹æ•…è³‡æ–™
  loadIncidentDateData(dateStr);

  // æ›´æ–°æ—¥æœŸè¼¸å…¥æ¡†
  document.getElementById('dateInput').value = dateStr;

  // æ›´æ–°æ—¥æœŸé¡¯ç¤º
  updateDateDisplay();

  renderDateTabs();
  render();

  // å¦‚æœç›®å‰åœ¨äº‹æ•…å›å ± Tabï¼Œé‡æ–°æ¸²æŸ“è¡¨å–®
  const activeTab = document.querySelector('.tab-btn.active');
  if (activeTab && activeTab.textContent.includes('äº‹æ•…å›å ±')) {
    renderIncidentForm();
  }
}

function saveDateData(dateStr) {
  if (!dateStr) return;

  data.statusByDate[dateStr] = {
    timeSlots: JSON.parse(JSON.stringify(data.timeSlots)),
    status: JSON.parse(JSON.stringify(data.status))
  };

  save();
}

function loadDateData(dateStr) {
  if (data.statusByDate[dateStr]) {
    data.timeSlots = JSON.parse(JSON.stringify(data.statusByDate[dateStr].timeSlots));
    data.status = JSON.parse(JSON.stringify(data.statusByDate[dateStr].status));
  } else {
    // å¦‚æœè©²æ—¥æœŸæ²’æœ‰è³‡æ–™ï¼Œåˆå§‹åŒ–ç‚ºç©º
    data.timeSlots = ['2030', '2400', 'éš”å¤© 0730'];
    data.status = {};
  }
}

// Toast æç¤ºå‡½æ•¸
function showToast(message, type = 'success', duration = 2000) {
  // ç§»é™¤ç¾æœ‰çš„ toast
  const existingToast = document.querySelector('.toast');
  if (existingToast) {
    existingToast.remove();
  }

  // å»ºç«‹æ–°çš„ toast
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);

  // é¡¯ç¤º toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);

  // è‡ªå‹•éš±è—
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, duration);
}

function exitMultiDayMode() {
  if (confirm('ç¢ºå®šè¦é€€å‡ºå¤šæ—¥æ¨¡å¼å—ï¼Ÿæ‰€æœ‰å¤šæ—¥è¦åŠƒçš„è³‡æ–™éƒ½æœƒä¿ç•™ã€‚')) {
    // å„²å­˜ç•¶å‰æ—¥æœŸçš„è³‡æ–™
    if (data.currentDate) {
      saveDateData(data.currentDate);
    }

    // é€€å‡ºå¤šæ—¥æ¨¡å¼
    data.multiDayMode = false;
    data.currentDate = null;
    data.selectedDates = [];

    // æ¢å¾©ç‚ºç©ºçš„å–®æ—¥è³‡æ–™
    data.timeSlots = ['2030', '2400', 'éš”å¤© 0730'];
    data.status = {};

    // éš±è—æ—¥æœŸæ¨™ç±¤
    document.getElementById('dateTabsContainer').style.display = 'none';

    // é‡è¨­æ—¥æœŸç‚ºä»Šå¤©
    document.getElementById('dateInput').valueAsDate = new Date();

    save();
    render();
  }
}

// ========== è‡ªå‹•åŒæ­¥ä¼‘å‡åŠŸèƒ½ ==========

// è‡ªå‹•åŒæ­¥ä¼‘å‡ç‹€æ…‹
function autoSyncVacations() {
  const dateInput = document.getElementById('dateInput');
  const currentDate = dateInput.valueAsDate || new Date();

  // ç§»é™¤æ‰€æœ‰è‡ªå‹•åŒæ­¥çš„ä¼‘å‡æ¨™è¨˜
  data.onLeave = data.onLeave.filter(item => item.source === 'manual');

  // æª¢æŸ¥æ¯å€‹äººå“¡æ˜¯å¦åœ¨ä¼‘å‡æœŸé–“å…§
  data.personnel.forEach(person => {
    if (isDateInVacation(currentDate, person.vacationStart, person.vacationEnd)) {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ‰‹å‹•æ¨™è¨˜
      const existing = data.onLeave.find(item => item.name === person.name);
      if (!existing) {
        data.onLeave.push({ name: person.name, source: 'auto' });
      }
    }
  });

  save();
}

function init() {
  // å¾ personnel_cache è¼‰å…¥å®Œæ•´äººå“¡ç‰©ä»¶ï¼Œä¸¦ç¯©é¸é©ç”¨æ–¼æœ¬ç³»çµ±çš„äººå“¡
  const personnelCache = localStorage.getItem('personnel_cache');
  if (personnelCache) {
    const allPersonnel = JSON.parse(personnelCache);
    data.personnel = allPersonnel.filter(p => p.systems && p.systems.includes('vacation'));
  }

  const saved = localStorage.getItem('return_v2_data');
  if (saved) {
    const savedData = JSON.parse(saved);
    // åªè¼‰å…¥æ¥­å‹™è³‡æ–™ï¼Œä¸è¼‰å…¥ personnelï¼ˆå·²å¾ cache è¼‰å…¥ï¼‰
    data.onLeave = savedData.onLeave || [];
    data.timeSlots = savedData.timeSlots || data.timeSlots;
    data.status = savedData.status || {};
    data.templates = savedData.templates || {};
    // è¼‰å…¥å¤šæ—¥è¦åŠƒè³‡æ–™
    data.statusByDate = savedData.statusByDate || {};
    data.multiDayMode = savedData.multiDayMode || false;
    data.selectedDates = savedData.selectedDates || [];
    data.currentDate = savedData.currentDate || null;
  }

  // è½‰æ›èˆŠæ ¼å¼çš„ onLeaveï¼ˆå­—ä¸²é™£åˆ—ï¼‰ç‚ºæ–°æ ¼å¼ï¼ˆç‰©ä»¶é™£åˆ—ï¼‰
  if (data.onLeave.length > 0 && typeof data.onLeave[0] === 'string') {
    data.onLeave = data.onLeave.map(name => ({ name, source: 'manual' }));
  }

  // è¼‰å…¥äº‹æ•…å›å ±è³‡æ–™
  loadIncidentData();

  // æ¢å¾©å¤šæ—¥æ¨¡å¼ç‹€æ…‹
  if (data.multiDayMode && data.currentDate) {
    loadDateData(data.currentDate);
    renderDateTabs();
    document.getElementById('dateTabsContainer').style.display = 'block';
    document.getElementById('dateInput').value = data.currentDate;
  } else {
    document.getElementById('dateInput').valueAsDate = new Date();
  }

  // åŸ·è¡Œè‡ªå‹•åŒæ­¥ (æš«æ™‚åœç”¨ä»¥ä¿®å¾©ç„¡é™å¾ªç’°å•é¡Œ)
  // setTimeout(() => autoSyncVacations(), 100);

  // åˆå§‹åŒ–æš—é»‘æ¨¡å¼
  const savedTheme = localStorage.getItem('return_theme');
  if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark-mode');
    document.getElementById('themeIcon').textContent = 'â˜€ï¸';
    document.getElementById('themeText').textContent = 'äº®è‰²';
  }

  // åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
  initVoiceRecognition();

  // æ—¥æœŸæ”¹è®Šæ™‚é‡æ–°åŒæ­¥ä¼‘å‡
  document.getElementById('dateInput').addEventListener('change', () => {
    // autoSyncVacations(); // æš«æ™‚åœç”¨
    updateDateDisplay();
    render();
  });

  // åˆå§‹åŒ–æ—¥æœŸé¡¯ç¤º
  updateDateDisplay();

  // å»¶é²æ¸²æŸ“,çµ¦æ‰‹æ©Ÿæ›´å¤šæ™‚é–“æº–å‚™
  setTimeout(() => render(), 500);

  // Soft keyboard handling - auto scroll to input on focus
  document.addEventListener('focusin', (e) => {
    if (e.target.matches('input, textarea, select')) {
      setTimeout(() => {
        e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300);
    }
  });

  // æ‰‹æ©Ÿå„ªåŒ–: é è¨­å±•é–‹åŸºæœ¬è³‡è¨Šå€å¡Š
  const basicInfoContent = document.getElementById('content-basicInfo');
  const basicInfoArrow = document.getElementById('arrow-basicInfo');
  if (basicInfoContent && basicInfoArrow) {
    basicInfoContent.classList.add('expanded');
    basicInfoArrow.classList.add('expanded');
  }
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('return_theme', isDark ? 'dark' : 'light');
}

function clearCache() {
  if (confirm('ğŸ—‘ï¸ æ¸…é™¤æ”¶å‡è³‡æ–™\n\nç¢ºå®šè¦æ¸…é™¤ç•¶å‰çš„æ”¶å‡ç™»è¨˜è³‡æ–™å—?\n\nâš ï¸ æ­¤æ“ä½œæœƒæ¸…ç©ºæ‰€æœ‰æ”¶å‡ç´€éŒ„,ä½†äººå“¡åå–®ã€äº‹æ•…é¡å‹ç­‰è¨­å®šæœƒä¿ç•™ã€‚')) {
    if (confirm('âš ï¸ å†æ¬¡ç¢ºèª\n\næ¸…é™¤å¾Œç„¡æ³•å¾©åŸ,ç¢ºå®šç¹¼çºŒå—?')) {
      localStorage.removeItem('return_v2_data');
      alert('âœ… å·²æ¸…é™¤æ”¶å‡è³‡æ–™!\n\né é¢å³å°‡é‡æ–°è¼‰å…¥');
      location.reload();
    }
  }
}

// === æ—¥æœŸUIç›¸é—œå‡½æ•¸ ===

function updateDateDisplay() {
  const dateInput = document.getElementById('dateInput');
  const date = dateInput.valueAsDate || new Date();
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekday = weekdays[date.getDay()];

  document.getElementById('dateText').textContent = `${month}æœˆ${day}æ—¥`;
  document.getElementById('weekdayBadge').textContent = `é€±${weekday}`;
}

function openDatePicker() {
  document.getElementById('dateInput').showPicker();
}

function changeDate(offset) {
  const dateInput = document.getElementById('dateInput');
  const currentDate = dateInput.valueAsDate || new Date();
  currentDate.setDate(currentDate.getDate() + offset);
  dateInput.valueAsDate = currentDate;
  dateInput.dispatchEvent(new Event('change'));
  updateDateDisplay();
}

function setToday() {
  const dateInput = document.getElementById('dateInput');
  dateInput.valueAsDate = new Date();
  dateInput.dispatchEvent(new Event('change'));
  updateDateDisplay();
}

function initVoiceRecognition() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'zh-TW';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      if (currentVoiceInput) {
        const input = document.getElementById(currentVoiceInput);
        if (input) {
          input.value = input.value ? input.value + ',' + transcript : transcript;
        }
      }
      stopVoiceInput();
    };
    
    recognition.onerror = (event) => {
      console.error('èªéŸ³è­˜åˆ¥éŒ¯èª¤:', event.error);
      stopVoiceInput();
      if (event.error === 'no-speech') {
        alert('æ²’æœ‰åµæ¸¬åˆ°èªéŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡');
      } else if (event.error === 'not-allowed') {
        alert('è«‹å…è¨±ä½¿ç”¨éº¥å…‹é¢¨æ¬Šé™');
      }
    };
    
    recognition.onend = () => {
      stopVoiceInput();
    };
  }
}

function startVoiceInput(inputId) {
  if (!recognition) {
    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
    return;
  }
  
  currentVoiceInput = inputId;
  const btn = event.target;
  btn.classList.add('listening');
  btn.textContent = 'ğŸ¤ è†è½ä¸­...';
  
  try {
    recognition.start();
  } catch (e) {
    console.error('èªéŸ³è­˜åˆ¥å•Ÿå‹•å¤±æ•—:', e);
    stopVoiceInput();
  }
}

function stopVoiceInput() {
  if (recognition) {
    try {
      recognition.stop();
    } catch (e) {
      console.error('åœæ­¢èªéŸ³è­˜åˆ¥å¤±æ•—:', e);
    }
  }
  
  document.querySelectorAll('.voice-btn').forEach(btn => {
    btn.classList.remove('listening');
    btn.textContent = 'ğŸ¤ èªéŸ³';
  });
  
  currentVoiceInput = null;
}

let saveTimer = null;

function save() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try {
      localStorage.setItem('return_v2_data', JSON.stringify(data));
    } catch (e) {
      if (e.name === 'QuotaExceededError') {
        alert('å„²å­˜ç©ºé–“ä¸è¶³ï¼Œè«‹æ¸…ç†èˆŠè³‡æ–™æˆ–åŒ¯å‡ºå‚™ä»½');
      }
      console.error('Save failed:', e);
    }
  }, 300);
}

function switchTab(index) {
  // é›¢é–‹äº‹æ•…å›å ± Tab å‰ï¼Œå…ˆå„²å­˜è³‡æ–™
  const currentActiveIndex = Array.from(document.querySelectorAll('.tab-btn')).findIndex(btn => btn.classList.contains('active'));
  if (currentActiveIndex === 1 && index !== 1) {
    // é›¢é–‹äº‹æ•…å›å ± Tabï¼Œå„²å­˜è³‡æ–™
    saveIncidentData();
  }

  document.querySelectorAll('.tab-btn').forEach((btn, i) => {
    btn.classList.toggle('active', i === index);
  });
  document.querySelectorAll('.tab-content').forEach((content, i) => {
    content.classList.toggle('active', i === index);
  });

  // Load incident reporting form when switching to incident report tab
  if (index === 1) {
    renderIncidentForm();
  }
}

function render() {
  renderLeaveDisplay();
  renderTimeSlotDisplay();
  renderPersonList();
  renderPersonGrid();
  renderTemplates();
}

function renderLeaveDisplay() {
  const html = data.onLeave.length > 0
    ? data.onLeave.map(item => {
        const icon = item.source === 'auto' ? 'ğŸ”„' : 'âœ‹';
        const title = item.source === 'auto' ? 'è‡ªå‹•åŒæ­¥' : 'è‡¨æ™‚æ¨™è¨˜';
        return `<div class="leave-tag" title="${title}">${icon} ${item.name}</div>`;
      }).join('')
    : '<div class="empty-hint">ç„¡ä¼‘å‡äººå“¡</div>';
  document.getElementById('leaveDisplay').innerHTML = html;
}

function renderTimeSlotDisplay() {
  const html = data.timeSlots.map(slot => 
    `<div class="time-slot-badge">${slot}</div>`
  ).join('');
  document.getElementById('timeSlotDisplay').innerHTML = html;
}

// å·¥å…·å‡½æ•¸ï¼šæ ¹æ“šè¨­å®šå–å¾—äººå“¡é¡¯ç¤ºåç¨±
function getDisplayName(person, context) {
  if (!person) return '';

  // è®€å–è¿´æ­¸ç·šé¡¯ç¤ºè¨­å®š
  const settings = JSON.parse(
    localStorage.getItem('vacation_display_settings') ||
    '{"checkin":"fullname","incident":"fullname"}'
  );

  // æ ¹æ“š context æ±ºå®šè¦ä½¿ç”¨å“ªå€‹è¨­å®š
  const setting = settings[context] || 'fullname';

  // å¦‚æœè¨­å®šç‚ºé¡¯ç¤ºæš±ç¨±ä¸”æœ‰æš±ç¨±ï¼Œå‰‡è¿”å›æš±ç¨±
  if (setting === 'nickname' && person.nickname) {
    return person.nickname;
  }

  // é è¨­è¿”å›å…¨å
  return person.name;
}

function renderPersonList() {
  const onLeaveNames = data.onLeave.map(item => item.name);
  const activePersonnel = data.personnel.filter(p => !onLeaveNames.includes(p.name));

  const html = activePersonnel.map((person, idx) => {
    const personStatus = data.status[person.name] || {};
    const displayName = getDisplayName(person, 'checkin'); // ä½¿ç”¨è¨­å®šæ±ºå®šé¡¯ç¤ºåç¨±

    const buttons = data.timeSlots.map((slot, slotIdx) => {
      const isThisSlot = personStatus.time === slotIdx;
      const status = isThisSlot ? personStatus.status : 0;

      let btnClass = 'time-btn';
      let label = slot;

      if (isThisSlot && status === 1) {
        btnClass += ' scheduled';
        label = 'â±ï¸ ' + slot;
      } else if (isThisSlot && status === 2) {
        btnClass += ' completed';
        label = 'âœ“ ' + slot;
      }

      return `<button class="${btnClass}" onclick="toggleStatus('${person.name}', ${slotIdx})">${label}</button>`;
    }).join('');

    return `
      <div class="person-row">
        <div class="person-row-header">
          <div class="person-name">${displayName}</div>
        </div>
        <div class="time-buttons">
          ${buttons}
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('personList').innerHTML = html || '<div class="empty-hint">ç„¡äººå“¡</div>';
}

function renderPersonGrid() {
  const onLeaveNames = data.onLeave.map(item => item.name);
  const html = data.personnel.map((p, i) => {
    const displayName = getDisplayName(p, 'checkin'); // ä½¿ç”¨è¨­å®šæ±ºå®šé¡¯ç¤ºåç¨±
    return `
    <div class="person-card ${onLeaveNames.includes(p.name) ? 'on-leave' : ''}" draggable="true"
         ondragstart="dragPersonReorderStart(event, ${i})"
         ondragend="dragPersonReorderEnd(event)"
         ondragover="dragPersonReorderOver(event)"
         ondrop="dropPersonReorder(event, ${i})"
         ondragleave="dragPersonReorderLeave(event)">
      <div class="person-card-name">${displayName}</div>
      <div class="person-actions">
        <button class="person-action-btn" style="background: linear-gradient(135deg, #ab47bc 0%, #8e24aa 100%); width: 100%;" onclick="showPersonMenu(event, ${i})">âš™ï¸ ç®¡ç†</button>
      </div>
    </div>
  `;
  }).join('');
  document.getElementById('personGrid').innerHTML = html;
}

function showPersonMenu(event, index) {
  event.stopPropagation();
  const person = data.personnel[index];
  const onLeaveNames = data.onLeave.map(item => item.name);
  const isOnLeave = onLeaveNames.includes(person.name);
  const leaveItem = data.onLeave.find(item => item.name === person.name);

  // ç§»é™¤ç¾æœ‰é¸å–®
  const existingMenu = document.getElementById('personContextMenu');
  if (existingMenu) existingMenu.remove();

  // å‰µå»ºé¸å–®
  const menu = document.createElement('div');
  menu.id = 'personContextMenu';
  menu.style.cssText = `
    position: fixed;
    background: white;
    border: 2px solid rgba(122, 111, 128, 0.5);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(126, 87, 194, 0.3);
    z-index: 10000;
    min-width: 150px;
    overflow: hidden;
  `;

  // æ ¹æ“šä¼‘å‡ç‹€æ…‹é¡¯ç¤ºä¸åŒçš„é¸é …æ–‡å­—
  let leaveText, leaveIcon;
  if (isOnLeave) {
    const source = leaveItem?.source || 'manual';
    leaveIcon = source === 'auto' ? 'ğŸ”„' : 'âœ‹';
    leaveText = `${leaveIcon} å–æ¶ˆä¼‘å‡`;
  } else {
    leaveText = 'âœ‹ è‡¨æ™‚æ¨™è¨˜ä¼‘å‡';
  }

  menu.innerHTML = `
    <div onclick="editPersonName(${index}); closePersonMenu();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: #7a6f80; transition: background 0.2s;" onmouseover="this.style.background='#f3e5f5'" onmouseout="this.style.background='white'">
      âœï¸ ç·¨è¼¯å§“å
    </div>
    <div onclick="toggleLeave('${person.name}'); closePersonMenu();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: ${isOnLeave ? '#7e57c2' : '#ff9800'}; transition: background 0.2s;" onmouseover="this.style.background='#f3e5f5'" onmouseout="this.style.background='white'">
      ${leaveText}
    </div>
    <div onclick="removePerson(${index}); closePersonMenu();" style="padding: 12px 16px; cursor: pointer; font-weight: 600; color: #dc3545; transition: background 0.2s;" onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='white'">
      ğŸ—‘ï¸ åˆªé™¤äººå“¡
    </div>
  `;

  // å®šä½é¸å–®
  const rect = event.target.getBoundingClientRect();
  menu.style.top = `${rect.bottom + 5}px`;
  menu.style.left = `${rect.left}px`;

  document.body.appendChild(menu);

  // é»æ“Šå¤–éƒ¨é—œé–‰
  setTimeout(() => {
    document.addEventListener('click', closePersonMenu);
  }, 100);
}

function closePersonMenu() {
  const menu = document.getElementById('personContextMenu');
  if (menu) menu.remove();
  document.removeEventListener('click', closePersonMenu);
}

function renderTemplates() {
  const keys = Object.keys(data.templates);
  const html = keys.length > 0 ? keys.map(key => {
    const t = data.templates[key];
    return `
      <div class="template-item">
        <div class="template-info">
          <div class="template-name">${t.name}</div>
          <div class="template-desc">${t.timeSlots?.length || 0}å€‹æ™‚æ®µ</div>
        </div>
        <div class="template-actions">
          <button class="template-btn btn-apply" onclick="applyTemplate('${key}')">å¥—ç”¨</button>
          <button class="template-btn btn-delete" onclick="deleteTemplate('${key}')">åˆªé™¤</button>
        </div>
      </div>
    `;
  }).join('') : '<div class="empty-hint">å°šç„¡å„²å­˜çš„ç¯„æœ¬</div>';
  document.getElementById('templateList').innerHTML = html;
}

function toggleStatus(person, timeIndex) {
  const current = data.status[person] || {};
  const currentTime = current.time;
  const currentStatus = current.status || 0;
  
  if (currentTime === timeIndex) {
    if (currentStatus === 1) {
      data.status[person] = { time: timeIndex, status: 2 };
    } else if (currentStatus === 2) {
      delete data.status[person];
    }
  } else {
    data.status[person] = { time: timeIndex, status: 1 };
  }
  
  save();
  render();
}

function addPerson() {
  const input = document.getElementById('newPersonName');
  const name = input.value.trim();

  if (!name) return;

  // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
  if (data.personnel.find(p => p.name === name)) {
    alert('æ­¤äººå“¡å·²å­˜åœ¨ï¼');
    return;
  }

  // æ–°å¢åˆ° personnel_cache
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];

  const newPerson = {
    name,
    rank: '',
    specialties: [],
    systems: ['service', 'task', 'vacation'], // é è¨­åŠ å…¥æ‰€æœ‰ç³»çµ±
    enabled: true
  };

  allPersonnel.push(newPerson);
  localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));

  // æ›´æ–°æœ¬åœ°è³‡æ–™
  data.personnel.push(newPerson);

  input.value = '';
  save();
  render();
}

function batchAddPersons() {
  const input = document.getElementById('batchPersonNames');
  const names = input.value.split(/[,ï¼Œ]/).map(n => n.trim()).filter(n => n);

  // è¼‰å…¥ personnel_cache
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];

  names.forEach(name => {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (data.personnel.find(p => p.name === name)) return;
    if (allPersonnel.find(p => p.name === name)) return;

    const newPerson = {
      name,
      rank: '',
      specialties: [],
      systems: ['service', 'task', 'vacation'], // é è¨­åŠ å…¥æ‰€æœ‰ç³»çµ±
      enabled: true
    };

    allPersonnel.push(newPerson);
    data.personnel.push(newPerson);
  });

  localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));

  input.value = '';
  save();
  render();
}

function editPersonName(index) {
  const oldName = data.personnel[index].name;
  const html = `
    <div class="input-group" style="margin-bottom: 16px;">
      <input type="text" class="input-text" id="editPersonInput" value="${oldName}" style="flex: 1;">
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="confirmEditPerson(${index})">âœ… ç¢ºèªä¿®æ”¹</button>
  `;
  showModal(`ç·¨è¼¯äººå“¡ - ${oldName}`, html);

  // èšç„¦ä¸¦é¸ä¸­æ–‡å­—
  setTimeout(() => {
    const input = document.getElementById('editPersonInput');
    if (input) {
      input.focus();
      input.select();
    }
  }, 100);
}

function confirmEditPerson(index) {
  const person = data.personnel[index];
  const oldName = person.name;
  const newName = document.getElementById('editPersonInput').value.trim();

  if (!newName) {
    alert('å§“åä¸èƒ½ç‚ºç©ºï¼');
    return;
  }

  if (newName === oldName) {
    closeModal();
    return;
  }

  if (data.personnel.find(p => p.name === newName)) {
    alert('æ­¤å§“åå·²å­˜åœ¨ï¼');
    return;
  }

  // æ›´æ–° personnel_cache
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];
  const cacheIndex = allPersonnel.findIndex(p => p.name === oldName);
  if (cacheIndex !== -1) {
    allPersonnel[cacheIndex].name = newName;
    localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));
  }

  // æ›´æ–°æœ¬åœ° personnel ç‰©ä»¶
  person.name = newName;

  // æ›´æ–° onLeave é™£åˆ—
  const leaveItem = data.onLeave.find(item => item.name === oldName);
  if (leaveItem) {
    leaveItem.name = newName;
  }

  // æ›´æ–° status ç‰©ä»¶ä¸­çš„ key
  if (data.status[oldName]) {
    data.status[newName] = data.status[oldName];
    delete data.status[oldName];
  }

  save();
  render();
  closeModal();
}

function removePerson(index) {
  const person = data.personnel[index];
  const name = person.name;

  if (confirm(`ç¢ºå®šåˆªé™¤ ${name} å—ï¼Ÿ`)) {
    // å¾ personnel_cache ç§»é™¤
    const personnelCache = localStorage.getItem('personnel_cache');
    const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];
    const cacheIndex = allPersonnel.findIndex(p => p.name === name);
    if (cacheIndex !== -1) {
      allPersonnel.splice(cacheIndex, 1);
      localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));
    }

    // å¾æœ¬åœ°è³‡æ–™ç§»é™¤
    data.personnel.splice(index, 1);
    data.onLeave = data.onLeave.filter(item => item.name !== name);
    delete data.status[name];
    save();
    render();
  }
}

// äººå“¡æ’åºæ‹–æ›³åŠŸèƒ½
function dragPersonReorderStart(event, index) {
  draggedPersonIndex = index;
  event.target.classList.add('dragging');
}

function dragPersonReorderEnd(event) {
  event.target.classList.remove('dragging');
  draggedPersonIndex = null;
}

function dragPersonReorderOver(event) {
  event.preventDefault();
  event.stopPropagation();
  if (draggedPersonIndex !== null) {
    event.currentTarget.style.borderColor = '#5e35b1';
    event.currentTarget.style.borderWidth = '3px';
  }
}

function dragPersonReorderLeave(event) {
  event.currentTarget.style.borderColor = '';
  event.currentTarget.style.borderWidth = '';
}

function dropPersonReorder(event, dropIndex) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.style.borderColor = '';
  event.currentTarget.style.borderWidth = '';

  if (draggedPersonIndex !== null && draggedPersonIndex !== dropIndex) {
    const person = data.personnel.splice(draggedPersonIndex, 1)[0];
    data.personnel.splice(dropIndex, 0, person);
    save();
    render();
  }
}

function toggleLeave(name) {
  const existingIndex = data.onLeave.findIndex(item => item.name === name);

  if (existingIndex !== -1) {
    // å·²åœ¨ä¼‘å‡åˆ—è¡¨ä¸­ï¼Œç§»é™¤
    data.onLeave.splice(existingIndex, 1);
  } else {
    // ä¸åœ¨ä¼‘å‡åˆ—è¡¨ä¸­ï¼Œæ·»åŠ ç‚ºæ‰‹å‹•è‡¨æ™‚æ¨™è¨˜
    data.onLeave.push({ name, source: 'manual' });
  }

  save();
  render();
}

function manageTimeSlots() {
  const html = `
    <div class="manage-list">
      ${data.timeSlots.map((slot, idx) => `
        <div class="manage-item">
          <div class="manage-item-name">${slot}</div>
          <button class="btn-icon btn-edit" onclick="editTimeSlot(${idx})">ç·¨è¼¯</button>
          <button class="btn-icon btn-delete" onclick="removeTimeSlot(${idx})">åˆªé™¤</button>
        </div>
      `).join('')}
    </div>
    <div class="input-group" style="margin-top: 16px;">
      <input type="text" class="input-text" id="newTimeSlot" placeholder="ä¾‹å¦‚ï¼š1800 æˆ– éš”å¤©ä¸­åˆ">
      <button class="btn-primary" onclick="addTimeSlot()">â• æ–°å¢</button>
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 12px;" onclick="closeModal()">å®Œæˆ</button>
  `;
  showModal('ç®¡ç†æ”¶å‡æ™‚æ®µ', html);
}

function addTimeSlot() {
  const input = document.getElementById('newTimeSlot');
  const slot = input.value.trim();
  if (slot && !data.timeSlots.includes(slot)) {
    data.timeSlots.push(slot);
    save();
    render();
    manageTimeSlots();
  }
}

function editTimeSlot(index) {
  const slot = data.timeSlots[index];
  const html = `
    <div class="input-group">
      <input type="text" class="input-text" id="editTimeSlotValue" value="${slot}">
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="saveEditTimeSlot(${index})">ç¢ºå®š</button>
  `;
  showModal('ç·¨è¼¯æ™‚æ®µ', html);
}

function saveEditTimeSlot(index) {
  const value = document.getElementById('editTimeSlotValue').value.trim();
  if (value) {
    data.timeSlots[index] = value;
    save();
    render();
    manageTimeSlots();
  }
}

function removeTimeSlot(index) {
  if (confirm(`ç¢ºå®šåˆªé™¤ ${data.timeSlots[index]} æ™‚æ®µå—ï¼Ÿ`)) {
    data.timeSlots.splice(index, 1);
    
    for (let person in data.status) {
      if (data.status[person].time === index) {
        delete data.status[person];
      } else if (data.status[person].time > index) {
        data.status[person].time--;
      }
    }
    
    save();
    render();
    manageTimeSlots();
  }
}

function saveTemplate() {
  const name = document.getElementById('templateName').value.trim();
  if (!name) {
    alert('è«‹è¼¸å…¥ç¯„æœ¬åç¨±');
    return;
  }
  
  const key = 'tpl_' + Date.now();
  data.templates[key] = {
    name,
    timeSlots: [...data.timeSlots]
  };
  
  document.getElementById('templateName').value = '';
  save();
  render();
  alert('âœ… ç¯„æœ¬å·²å„²å­˜ï¼');
}

function applyTemplate(key) {
  if (confirm('å¥—ç”¨ç¯„æœ¬æœƒè¦†è“‹ç•¶å‰çš„æ™‚æ®µé…ç½®ï¼Œç¢ºå®šå—ï¼Ÿ')) {
    const t = data.templates[key];
    data.timeSlots = [...t.timeSlots];
    data.status = {};
    save();
    render();
    switchTab(0);
    alert('âœ… ç¯„æœ¬å·²å¥—ç”¨ï¼');
  }
}

function deleteTemplate(key) {
  if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç¯„æœ¬å—ï¼Ÿ')) {
    delete data.templates[key];
    save();
    render();
  }
}

// è¼”åŠ©å‡½æ•¸ï¼šå°‡å­˜å„²çš„å…¨åè½‰æ›ç‚ºé¡¯ç¤ºåç¨±ï¼ˆæ ¹æ“šçµ±ä¸€è¨­å®šï¼‰
function getDisplayNameForOutput(personName, context) {
  if (!personName) return '';
  const personObj = data.personnel.find(p => p.name === personName);
  return personObj ? getDisplayName(personObj, context) : personName;
}

function generateResult() {
  const date = document.getElementById('dateInput').value;
  const dateObj = new Date(date + 'T00:00:00');
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const [year, month, day] = date.split('-');
  const weekday = weekdays[dateObj.getDay()];

  let result = `âœ…${month}/${day}ï¼ˆé€±${weekday}ï¼‰æ”¶å‡ç‹€æ³\n\n`;

  data.timeSlots.forEach((slot, timeIndex) => {
    const completed = [];
    const scheduled = [];

    for (let person in data.status) {
      const status = data.status[person];
      if (status.time === timeIndex) {
        const displayName = getDisplayNameForOutput(person, 'checkin');
        if (status.status === 2) {
          completed.push(displayName);
        } else if (status.status === 1) {
          scheduled.push(displayName);
        }
      }
    }

    if (completed.length > 0 || scheduled.length > 0) {
      result += `${slot}æ”¶å‡äººå“¡ï¼š\n`;
      if (completed.length > 0) {
        result += completed.map(p => `âœ…${p}`).join('\n') + '\n';
      }
      if (scheduled.length > 0) {
        if (completed.length > 0) result += '\n';
        result += scheduled.map(p => `${p}`).join('\n') + '\n';
      }
      result += '\n';
    }
  });

  return result.trim();
}

function preview() {
  const result = generateResult();
  showIOSPreview('ğŸ“… æ”¶å‡ç‹€æ³', result);
}

function showModal(title, content) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalContent').innerHTML = content;
  document.getElementById('modal').classList.add('show');
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
}

// ========================================
// äº‹æ•…å›å ±ç³»çµ±
// ========================================

let incidentData = {
  date: '',
  weekday: 'é€±äº”',
  unit: '',  // å–®ä½åç¨±
  personnelStatuses: [],
  // å¤šæ—¥æ¨¡å¼æ”¯æ´
  multiDayMode: false,
  currentDate: null,
  statusByDate: {} // { '2024-10-25': { personnelStatuses: [] }, ... }
};

// åŒæ­¥äº‹æ•…å›å ±çš„å¤šæ—¥æ¨¡å¼ç‹€æ…‹ï¼ˆå¾å›æ­¸ç·šï¼‰
function syncIncidentDateFromCheckin() {
  // æª¢æŸ¥æ˜¯å¦ç‚ºå¤šæ—¥æ¨¡å¼
  if (data.multiDayMode && data.currentDate) {
    // å¤šæ—¥æ¨¡å¼ï¼šåŒæ­¥ç‹€æ…‹
    incidentData.multiDayMode = true;
    incidentData.currentDate = data.currentDate;
  } else {
    // å–®æ—¥æ¨¡å¼ï¼šé‡ç½®å¤šæ—¥æ¨¡å¼ç‹€æ…‹
    incidentData.multiDayMode = false;
    incidentData.currentDate = null;
  }
}


// å„²å­˜ç•¶å‰æ—¥æœŸçš„äº‹æ•…è³‡æ–™
function saveIncidentDateData(dateStr) {
  incidentData.statusByDate[dateStr] = {
    personnelStatuses: JSON.parse(JSON.stringify(incidentData.personnelStatuses))
  };
}

// è¼‰å…¥æŒ‡å®šæ—¥æœŸçš„äº‹æ•…è³‡æ–™
function loadIncidentDateData(dateStr) {
  if (incidentData.statusByDate[dateStr]) {
    incidentData.personnelStatuses = JSON.parse(JSON.stringify(incidentData.statusByDate[dateStr].personnelStatuses));
  } else {
    // åˆå§‹åŒ–ç‚ºç©ºè³‡æ–™
    const incidentPersonnelIds = JSON.parse(localStorage.getItem('incident_personnel_ids') || '[]');
    const personnelCache = localStorage.getItem('personnel_cache');
    const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];
    const selectedPersonnel = allPersonnel.filter(p => incidentPersonnelIds.includes(p.id));

    incidentData.personnelStatuses = selectedPersonnel.map(p => ({
      id: p.id,
      name: p.name,
      status: ''
    }));
  }
}

// å„²å­˜äº‹æ•…è³‡æ–™åˆ° localStorage
function saveIncidentData() {
  // å„²å­˜ç•¶å‰æ—¥æœŸçš„è³‡æ–™åˆ° statusByDate
  if (incidentData.multiDayMode && incidentData.currentDate) {
    incidentData.statusByDate[incidentData.currentDate] = {
      personnelStatuses: JSON.parse(JSON.stringify(incidentData.personnelStatuses))
    };
  }

  // æ•´å€‹ incidentData å­˜åˆ° localStorage
  localStorage.setItem('incident_report_data', JSON.stringify(incidentData));

  // åŒæ™‚å„²å­˜åˆ°æ—¥æœŸç‰¹å®šçš„ key (ç”¨æ–¼è¤‡è£½å‰æ—¥åŠŸèƒ½)
  const currentDate = document.getElementById('dateInput').valueAsDate || new Date();
  const dateStr = currentDate.toISOString().split('T')[0];
  localStorage.setItem(`incident_report_data_${dateStr}`, JSON.stringify({
    personnelStatuses: JSON.parse(JSON.stringify(incidentData.personnelStatuses)),
    unit: incidentData.unit
  }));

  console.log('ğŸ’¾ å„²å­˜äº‹æ•…è³‡æ–™:', incidentData.personnelStatuses.length, 'ç­†');
}

// å¾ localStorage è¼‰å…¥äº‹æ•…è³‡æ–™
function loadIncidentData() {
  const saved = localStorage.getItem('incident_report_data');
  if (saved) {
    try {
      const loadedData = JSON.parse(saved);
      // åˆä½µè¼‰å…¥çš„è³‡æ–™
      incidentData.unit = loadedData.unit || '';
      incidentData.personnelStatuses = loadedData.personnelStatuses || [];
      incidentData.statusByDate = loadedData.statusByDate || {};
      incidentData.multiDayMode = loadedData.multiDayMode || false;
      incidentData.currentDate = loadedData.currentDate || null;

      console.log('âœ… è¼‰å…¥äº‹æ•…è³‡æ–™:', incidentData.personnelStatuses.length, 'ç­†');
    } catch (e) {
      console.error('âŒ è¼‰å…¥äº‹æ•…è³‡æ–™å¤±æ•—:', e);
    }
  } else {
    console.log('â„¹ï¸ ç„¡å·²å„²å­˜çš„äº‹æ•…è³‡æ–™');
  }
}

// å„²å­˜å–®ä½åç¨±
function saveIncidentUnit() {
  const unitInput = document.getElementById('incidentUnit');
  if (unitInput) {
    incidentData.unit = unitInput.value.trim();
    saveIncidentData();
  }
}

// æ¸²æŸ“äº‹æ•…å¡«å¯«è¡¨å–®
function renderIncidentForm() {
  const formEl = document.getElementById('incidentPersonnelForm');
  const countEl = document.getElementById('incidentPersonnelCount2');
  if (!formEl) return;

  // å…ˆè¼‰å…¥å·²å„²å­˜çš„è³‡æ–™
  loadIncidentData();

  // è‡ªå‹•åŒæ­¥å›æ­¸ç·šçš„æ—¥æœŸå’Œæ˜ŸæœŸ
  syncIncidentDateFromCheckin();

  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');
  const incidentPersonnelIds = JSON.parse(localStorage.getItem('incident_personnel_ids') || '[]');

  if (incidentPersonnelIds.length === 0) {
    formEl.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">è«‹å…ˆåˆ°ã€Œç³»çµ±è¨­å®š â†’ äº‹æ•…é¡å‹ã€é¸æ“‡è¦çµ±è¨ˆçš„äººå“¡</div>';
    if (countEl) countEl.textContent = '0 äºº';
    return;
  }

  // å¾ personnel_cache è¼‰å…¥æ‰€æœ‰äººå“¡
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];

  const selectedPersonnel = allPersonnel.filter(p => incidentPersonnelIds.includes(p.id));
  if (countEl) countEl.textContent = `${selectedPersonnel.length} äºº`;

  // è¼‰å…¥å¤šæ—¥æ¨¡å¼è³‡æ–™ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  if (incidentData.multiDayMode && incidentData.currentDate) {
    loadIncidentDateData(incidentData.currentDate);
  } else {
    // å–®æ—¥æ¨¡å¼ï¼šç¢ºä¿ personnelStatuses åŒ…å«æ‰€æœ‰é¸å®šçš„äººå“¡
    // å¦‚æœå·²æœ‰è³‡æ–™ï¼Œä¿ç•™ï¼›å¦‚æœæ˜¯æ–°å¢äººå“¡ï¼Œåˆå§‹åŒ–ç‚ºç©ºç‹€æ…‹
    const existingStatuses = new Map(incidentData.personnelStatuses.map(p => [p.id, p]));

    incidentData.personnelStatuses = selectedPersonnel.map(p => {
      if (existingStatuses.has(p.id)) {
        return existingStatuses.get(p.id); // ä¿ç•™å·²å­˜çš„ç‹€æ…‹
      } else {
        return { id: p.id, name: p.name, status: '' }; // æ–°äººå“¡åˆå§‹åŒ–
      }
    });
  }

  const html = selectedPersonnel.map((person, index) => {
    const displayName = getDisplayName(person, 'incident'); // ä½¿ç”¨è¨­å®šæ±ºå®šé¡¯ç¤ºåç¨±
    const personStatus = incidentData.personnelStatuses.find(p => p.id === person.id);
    const currentStatus = personStatus ? personStatus.status : '';

    return `
    <div class="person-item" id="person-item-${person.id}" style="display: grid; grid-template-columns: 32px 100px 1fr; gap: 8px; align-items: center; padding: 12px; background: ${index % 2 === 0 ? '#f9f9f9' : 'white'}; border-radius: 8px; margin-bottom: 4px; transition: all 0.3s ease; border: 2px solid transparent;">
      <input type="checkbox" class="batch-checkbox" data-person-id="${person.id}" onchange="updateBatchSelection(${person.id})" style="width: 20px; height: 20px; cursor: pointer;">
      <span style="font-weight: 600; font-size: 14px;">${displayName}</span>
      <input type="text" class="input-text" id="incident_${person.id}"
             list="incidentTypes_${person.id}"
             value="${currentStatus}"
             onchange="updateIncidentStatus(${person.id}, this.value)"
             placeholder="åœ¨ç‡Ÿ(ç©ºç™½) æˆ–é¸æ“‡/è¼¸å…¥äº‹æ•…"
             style="padding: 8px;">
      <datalist id="incidentTypes_${person.id}">
        ${incidentTypes.map(type => `<option value="${type.name}">`).join('')}
      </datalist>
    </div>
  `;
  }).join('');

  formEl.innerHTML = html;
  calculateIncidentSummary();

  // è¼‰å…¥å–®ä½åç¨±
  const unitInput = document.getElementById('incidentUnit');
  if (unitInput && incidentData.unit) {
    unitInput.value = incidentData.unit;
  }

  // æ¸²æŸ“äº‹æ•…é¡å‹ç®¡ç†åˆ—è¡¨
  renderIncidentTypes();

  // æ¸²æŸ“çµ±è¨ˆäººå“¡åˆ—è¡¨
  renderIncidentPersonnel();

  // æ¸²æŸ“æ‰¹æ¬¡æ“ä½œæŒ‰éˆ•
  renderBatchIncidentTypes();
}

// æ›´æ–°å–®å€‹äººå“¡ç‹€æ…‹
function updateIncidentStatus(personId, status) {
  const person = incidentData.personnelStatuses.find(p => p.id === personId);
  if (person) {
    person.status = status;
    calculateIncidentSummary();
    saveIncidentData(); // å„²å­˜åˆ° localStorage
  }
}

// è¤‡è£½å‰æ—¥äº‹æ•…
function copyPreviousDayIncident() {
  try {
    let previousData = null;

    // å¦‚æœæ˜¯å¤šæ—¥æ¨¡å¼,æ‰¾å‰ä¸€å€‹æ—¥æœŸ
    if (incidentData.multiDayMode && incidentData.currentDate) {
      const currentDate = new Date(incidentData.currentDate);
      currentDate.setDate(currentDate.getDate() - 1);
      const previousDateStr = currentDate.toISOString().split('T')[0];

      // å¾å¤šæ—¥è³‡æ–™ä¸­è®€å–
      if (incidentData.statusByDate && incidentData.statusByDate[previousDateStr]) {
        previousData = incidentData.statusByDate[previousDateStr].personnelStatuses;
      }
    } else {
      // å–®æ—¥æ¨¡å¼,å¾localStorageè®€å–å‰æ—¥è³‡æ–™
      // å˜—è©¦å¾incident_report_data_YYYY-MM-DDè®€å–
      const currentDate = document.getElementById('dateInput').valueAsDate || new Date();
      const previousDate = new Date(currentDate);
      previousDate.setDate(previousDate.getDate() - 1);
      const previousDateStr = previousDate.toISOString().split('T')[0];

      const savedData = localStorage.getItem(`incident_report_data_${previousDateStr}`);
      if (savedData) {
        const parsedData = JSON.parse(savedData);
        previousData = parsedData.personnelStatuses;
      }
    }

    if (!previousData || previousData.length === 0) {
      showToast('æ²’æœ‰å‰æ—¥äº‹æ•…è³‡æ–™', 'warning');
      return;
    }

    // è¤‡è£½å‰æ—¥ç‹€æ…‹åˆ°ç•¶å‰äººå“¡
    let copiedCount = 0;
    incidentData.personnelStatuses.forEach(currentPerson => {
      const previousPerson = previousData.find(p => p.id === currentPerson.id || p.name === currentPerson.name);
      if (previousPerson && previousPerson.status) {
        currentPerson.status = previousPerson.status;
        copiedCount++;
      }
    });

    if (copiedCount > 0) {
      saveIncidentData();
      renderIncidentForm(); // é‡æ–°æ¸²æŸ“è¡¨å–®
      calculateIncidentSummary();
      showToast(`å·²è¤‡è£½ ${copiedCount} äººçš„å‰æ—¥äº‹æ•…`, 'success');
    } else {
      showToast('ç„¡å¯è¤‡è£½çš„äº‹æ•…è³‡æ–™', 'warning');
    }
  } catch (error) {
    console.error('è¤‡è£½å‰æ—¥äº‹æ•…å¤±æ•—:', error);
    showToast('è¤‡è£½å¤±æ•—,è«‹ç¨å¾Œå†è©¦', 'error');
  }
}

// è¨ˆç®—äº‹æ•…çµ±è¨ˆ
function calculateIncidentSummary() {
  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');
  const statuses = incidentData.personnelStatuses;

  let total = statuses.length;
  let present = 0;
  let incident = 0;
  const details = {};

  statuses.forEach(p => {
    if (!p.status || p.status === '') {
      present++;
    } else {
      const type = incidentTypes.find(t => t.name === p.status);
      // åªæœ‰é è¨­äº‹æ•…é¡å‹ä¸”å‹¾é¸ã€Œåˆ—å…¥çµ±è¨ˆã€æ‰è¨ˆå…¥äº‹æ•…äººæ•¸
      // æ‰‹å‹•è¼¸å…¥çš„äº‹æ•…æœƒé¡¯ç¤ºåœ¨å ±å‘Šä¸­ï¼Œä½†ä¸è¨ˆå…¥çµ±è¨ˆ
      if (type && type.countAsIncident) {
        incident++;
        details[p.status] = (details[p.status] || 0) + 1;
      } else {
        present++;
      }
    }
  });

  // æ›´æ–°é¡¯ç¤º
  document.getElementById('incidentTotalCount').textContent = total;
  document.getElementById('incidentPresentCount').textContent = present;
  document.getElementById('incidentAwayCount').textContent = incident;

  // æ›´æ–°äº‹æ•…æ˜ç´°
  const detailsEl = document.getElementById('incidentDetails');
  if (Object.keys(details).length > 0) {
    const detailText = Object.entries(details)
      .map(([type, count]) => `â€¢ ${type}: ${count} å“¡`)
      .join('<br>');
    detailsEl.innerHTML = `<strong>ğŸ“Š äº‹æ•…æ˜ç´°:</strong><br>${detailText}`;
  } else {
    detailsEl.innerHTML = 'ğŸ“Š äº‹æ•…æ˜ç´°: ç„¡';
  }

  // å„²å­˜æ‘˜è¦
  incidentData.summary = { total, present, incident, details };
}

// ç”Ÿæˆäººå“¡æ˜ç´°å ±å‘Š
function generateDetailReport() {
  const unit = document.getElementById('incidentUnit').value.trim() || 'æˆ°æ”¯é€£';

  // å¾é ‚éƒ¨æ—¥æœŸé¸æ“‡å™¨è®€å–æ—¥æœŸå’Œæ˜ŸæœŸ
  const dateInput = document.getElementById('dateInput');
  const date = dateInput.valueAsDate || new Date();
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekday = `é€±${weekdays[date.getDay()]}`;
  const dateStr = `${month}/${day}`;

  const statuses = incidentData.personnelStatuses;

  let report = `${dateStr}(${weekday})${unit}äº‹æ•…\n\n`;

  // åˆ—å‡ºæ‰€æœ‰äººå“¡ç‹€æ…‹
  statuses.forEach(p => {
    const displayName = getDisplayNameForOutput(p.name, 'incident');
    report += `${displayName}ï¼š${p.status || ''}\n`;
  });

  return report;
}

// ç”Ÿæˆçµ±è¨ˆå ±å‘Š
function generateSummaryReport() {
  const unit = document.getElementById('incidentUnit').value.trim() || 'æˆ°æ”¯é€£';

  // å¾é ‚éƒ¨æ—¥æœŸé¸æ“‡å™¨è®€å–æ—¥æœŸ
  const dateInput = document.getElementById('dateInput');
  const date = dateInput.valueAsDate || new Date();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const dateStr = `${month}/${day}`;

  const summary = incidentData.summary || { total: 0, present: 0, incident: 0, details: {} };

  let report = `${unit}å ±å‘Šï¼šï¼ˆ${dateStr}ï¼‰\n`;
  report += `1.äººå“¡ç¾æ³\n`;
  report += `ç¾å“¡ï¼š${summary.total}å“¡\n`;
  report += `åœ¨ç‡Ÿï¼š${summary.present}å“¡\n`;
  report += `äº‹æ•…ï¼š${summary.incident}å“¡\n`;

  // äº‹æ•…æ˜ç´°
  if (Object.keys(summary.details).length > 0) {
    const detailsText = Object.entries(summary.details)
      .map(([type, count]) => `${type}${count}`)
      .join('ã€');
    report += `ï¼ˆ${detailsText}ï¼‰\n`;
  }

  return report;
}

// é è¦½äººå“¡æ˜ç´°å ±å‘Š
function previewDetailReport() {
  const report = generateDetailReport();
  showIOSPreview('ğŸ“‹ äººå“¡æ˜ç´°å ±å‘Š', report);
}

// é è¦½çµ±è¨ˆå ±å‘Š
function previewSummaryReport() {
  const report = generateSummaryReport();
  showIOSPreview('ğŸ“Š çµ±è¨ˆå ±å‘Š', report);
}

// ç”Ÿæˆäº‹æ•…æ˜ç´°å ±å‘Š(æŒ‰äº‹æ•…é¡å‹åˆ†é¡)
function generateIncidentDetailReport() {
  const unit = document.getElementById('incidentUnit').value.trim() || 'æˆ°æ”¯é€£';

  // å¾é ‚éƒ¨æ—¥æœŸé¸æ“‡å™¨è®€å–æ—¥æœŸå’Œæ˜ŸæœŸ
  const dateInput = document.getElementById('dateInput');
  const date = dateInput.valueAsDate || new Date();
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekday = `é€±${weekdays[date.getDay()]}`;
  const dateStr = `${month}/${day}`;

  const statuses = incidentData.personnelStatuses;

  // æŒ‰äº‹æ•…é¡å‹åˆ†çµ„
  const incidentGroups = {};
  const noIncidentPersonnel = [];

  statuses.forEach(p => {
    const status = (p.status || '').trim();
    const displayName = getDisplayNameForOutput(p.name, 'incident');

    // å€åˆ†æœ‰äº‹æ•…å’Œç„¡äº‹æ•…
    if (status && status !== 'åœ¨ç‡Ÿ') {
      // æœ‰äº‹æ•…
      if (!incidentGroups[status]) {
        incidentGroups[status] = [];
      }
      incidentGroups[status].push(displayName);
    } else {
      // ç„¡äº‹æ•…(ç©ºç™½æˆ–åœ¨ç‡Ÿ)
      noIncidentPersonnel.push(displayName);
    }
  });

  // ç”Ÿæˆå ±å‘Š
  let report = `${dateStr}(${weekday})${unit}äº‹æ•…æ˜ç´°\n\n`;

  // å…ˆè¼¸å‡ºå„ç¨®äº‹æ•…é¡å‹
  if (Object.keys(incidentGroups).length > 0) {
    Object.entries(incidentGroups).forEach(([incidentType, personnel]) => {
      report += `${incidentType}:${personnel.join('ã€')}\n`;
    });

    // å¦‚æœæœ‰äº‹æ•…,åŠ ä¸€å€‹ç©ºè¡Œåˆ†éš”
    if (noIncidentPersonnel.length > 0) {
      report += '\n';
    }
  }

  // æœ€å¾Œè¼¸å‡ºç„¡äº‹æ•…äººå“¡
  if (noIncidentPersonnel.length > 0) {
    report += `ç„¡äº‹æ•…:${noIncidentPersonnel.join('ã€')}\n`;
  }

  return report;
}

// é è¦½äº‹æ•…æ˜ç´°å ±å‘Š
function previewIncidentDetailReport() {
  const report = generateIncidentDetailReport();
  showIOSPreview('ğŸ“ äº‹æ•…æ˜ç´°', report);
}

// ========================================
// äº‹æ•…é¡å‹ç®¡ç†
// ========================================

// æ¸²æŸ“äº‹æ•…é¡å‹åˆ—è¡¨
function renderIncidentTypes() {
  const list = document.getElementById('incidentTypesList');
  if (!list) return;

  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');

  if (incidentTypes.length === 0) {
    list.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">å°šç„¡äº‹æ•…é¡å‹</div>';
    return;
  }

  const html = incidentTypes.map((type) => `
    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f3e5f5; border: 2px solid #ce93d8; border-radius: 12px; margin-bottom: 8px;">
      <div style="flex: 1; min-width: 0;">
        <input type="text"
               id="incident_name_${type.id}"
               value="${type.name}"
               onblur="saveIncidentNameInline(${type.id}, this.value)"
               onkeypress="if(event.key==='Enter') this.blur()"
               style="width: 100%; max-width: 300px; padding: 6px 10px; border: 2px solid transparent; border-radius: 6px; font-weight: 600; font-size: 15px; color: #5e35b1; background: transparent; transition: all 0.2s;"
               onfocus="this.style.background='white'; this.style.borderColor='#9c27b0';"
               onblur="this.style.background='transparent'; this.style.borderColor='transparent'; saveIncidentNameInline(${type.id}, this.value)">
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
          <input type="checkbox" ${type.countAsIncident ? 'checked' : ''}
                 onchange="toggleIncidentCount(${type.id})"
                 style="width: 18px; height: 18px;">
          <span style="font-size: 13px; color: #666; white-space: nowrap;">åˆ—å…¥äº‹æ•…çµ±è¨ˆ</span>
        </label>
        <button onclick="deleteIncidentType(${type.id})"
                style="padding: 6px 12px; background: linear-gradient(135deg, #e53935 0%, #ef5350 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; white-space: nowrap;">
          åˆªé™¤
        </button>
      </div>
    </div>
  `).join('');

  list.innerHTML = html;
}

// æ–°å¢äº‹æ•…é¡å‹
function addIncidentType() {
  const nameInput = document.getElementById('newIncidentType');
  const countInput = document.getElementById('newIncidentCount');
  const name = nameInput.value.trim();

  if (!name) {
    alert('è«‹è¼¸å…¥äº‹æ•…é¡å‹åç¨±');
    return;
  }

  // è®€å–ç¾æœ‰é¡å‹
  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');

  // æª¢æŸ¥é‡è¤‡
  if (incidentTypes.some(t => t.name === name)) {
    alert('æ­¤äº‹æ•…é¡å‹å·²å­˜åœ¨');
    return;
  }

  // æ–°å¢
  incidentTypes.push({
    id: Date.now(),
    name: name,
    countAsIncident: countInput.checked
  });

  // å„²å­˜åˆ° localStorage
  localStorage.setItem('incident_types', JSON.stringify(incidentTypes));

  nameInput.value = '';
  countInput.checked = false;

  renderIncidentTypes();
  renderIncidentForm(); // é‡æ–°æ¸²æŸ“äº‹æ•…è¡¨å–®
  alert(`âœ… å·²æ–°å¢äº‹æ•…é¡å‹: ${name}`);
}

// å…§åµŒç·¨è¼¯äº‹æ•…é¡å‹åç¨±
function saveIncidentNameInline(id, newName) {
  newName = newName.trim();

  if (!newName) {
    alert('äº‹æ•…é¡å‹åç¨±ä¸èƒ½ç‚ºç©º');
    renderIncidentTypes();
    return;
  }

  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');
  const type = incidentTypes.find(t => t.id === id);

  if (type && type.name !== newName) {
    // æª¢æŸ¥æ˜¯å¦èˆ‡å…¶ä»–é¡å‹é‡è¤‡
    if (incidentTypes.some(t => t.id !== id && t.name === newName)) {
      alert('æ­¤äº‹æ•…é¡å‹åç¨±å·²å­˜åœ¨');
      renderIncidentTypes();
      return;
    }

    type.name = newName;
    localStorage.setItem('incident_types', JSON.stringify(incidentTypes));
    renderIncidentForm(); // é‡æ–°æ¸²æŸ“äº‹æ•…è¡¨å–®
  }
}

// åˆ‡æ›æ˜¯å¦åˆ—å…¥çµ±è¨ˆ
function toggleIncidentCount(id) {
  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');
  const type = incidentTypes.find(t => t.id === id);

  if (type) {
    type.countAsIncident = !type.countAsIncident;
    localStorage.setItem('incident_types', JSON.stringify(incidentTypes));
    calculateIncidentSummary(); // é‡æ–°è¨ˆç®—çµ±è¨ˆ
  }
}

// åˆªé™¤äº‹æ•…é¡å‹
function deleteIncidentType(id) {
  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');
  const type = incidentTypes.find(t => t.id === id);

  if (!type) return;

  if (!confirm(`ç¢ºå®šåˆªé™¤äº‹æ•…é¡å‹ã€Œ${type.name}ã€å—ï¼Ÿ`)) return;

  const updatedTypes = incidentTypes.filter(t => t.id !== id);
  localStorage.setItem('incident_types', JSON.stringify(updatedTypes));

  renderIncidentTypes();
  renderIncidentForm(); // é‡æ–°æ¸²æŸ“äº‹æ•…è¡¨å–®
}

// ========================================
// çµ±è¨ˆäººå“¡ç®¡ç†
// ========================================

// æ¸²æŸ“çµ±è¨ˆäººå“¡åˆ—è¡¨
function renderIncidentPersonnel() {
  const list = document.getElementById('incidentPersonnelList');
  const countEl = document.getElementById('incidentPersonnelCount2');
  if (!list) return;

  // å¾ personnel_cache è¼‰å…¥æ‰€æœ‰äººå“¡
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];

  // è¼‰å…¥å·²é¸æ“‡çš„äººå“¡ IDs
  const incidentPersonnelIds = JSON.parse(localStorage.getItem('incident_personnel_ids') || '[]');

  if (allPersonnel.length === 0) {
    list.innerHTML = '<div style="color: #999; text-align: center; padding: 20px; grid-column: 1 / -1;">å°šç„¡äººå“¡,è«‹å…ˆåˆ°ã€Œç³»çµ±è¨­å®š â†’ äººå“¡ç®¡ç†ã€æ–°å¢äººå“¡</div>';
    if (countEl) countEl.textContent = '0 äºº';
    return;
  }

  const html = allPersonnel.map((person) => {
    const isSelected = incidentPersonnelIds.includes(person.id);
    return `
      <label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: ${isSelected ? '#e8f5e9' : '#f5f5f5'}; border: 2px solid ${isSelected ? '#66bb6a' : '#e0e0e0'}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
        <input type="checkbox"
               ${isSelected ? 'checked' : ''}
               onchange="toggleIncidentPersonnel(${person.id})"
               style="width: 16px; height: 16px;">
        <span style="font-size: 14px; font-weight: ${isSelected ? '600' : '400'};">${person.name}</span>
      </label>
    `;
  }).join('');

  list.innerHTML = html;
  if (countEl) countEl.textContent = `${incidentPersonnelIds.length} äºº`;
}

// åˆ‡æ›äººå“¡é¸æ“‡
function toggleIncidentPersonnel(personId) {
  const incidentPersonnelIds = JSON.parse(localStorage.getItem('incident_personnel_ids') || '[]');
  const index = incidentPersonnelIds.indexOf(personId);

  if (index === -1) {
    incidentPersonnelIds.push(personId);
  } else {
    incidentPersonnelIds.splice(index, 1);
  }

  localStorage.setItem('incident_personnel_ids', JSON.stringify(incidentPersonnelIds));
  renderIncidentPersonnel();
  renderIncidentForm(); // é‡æ–°æ¸²æŸ“äº‹æ•…è¡¨å–®
}

// å…¨é¸çµ±è¨ˆäººå“¡
function selectAllIncidentPersonnel() {
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];
  const incidentPersonnelIds = allPersonnel.map(p => p.id);
  localStorage.setItem('incident_personnel_ids', JSON.stringify(incidentPersonnelIds));
  renderIncidentPersonnel();
  renderIncidentForm(); // é‡æ–°æ¸²æŸ“äº‹æ•…è¡¨å–®
}

// å…¨ä¸é¸çµ±è¨ˆäººå“¡
function deselectAllIncidentPersonnel() {
  localStorage.setItem('incident_personnel_ids', JSON.stringify([]));
  renderIncidentPersonnel();
  renderIncidentForm(); // é‡æ–°æ¸²æŸ“äº‹æ•…è¡¨å–®
}

// ========================================
// å¯æ”¶åˆå€å¡Šæ§åˆ¶
// ========================================

// ========== æ‰¹æ¬¡æ“ä½œç›¸é—œå‡½æ•¸ ==========

// æ¸²æŸ“æ‰¹æ¬¡æ“ä½œçš„äº‹æ•…é¡å‹æŒ‰éˆ•
function renderBatchIncidentTypes() {
  const container = document.getElementById('batchIncidentTypes');
  if (!container) return;

  const incidentTypes = JSON.parse(localStorage.getItem('incident_types') || '[]');

  if (incidentTypes.length === 0) {
    container.innerHTML = '<div style="color: #999; font-size: 12px;">å°šç„¡äº‹æ•…é¡å‹,è«‹å…ˆåˆ°ã€ŒåŸºæœ¬è³‡è¨Šã€å€å¡Šæ–°å¢</div>';
    return;
  }

  const html = incidentTypes.map(type => `
    <button onclick="applyBatchIncident('${type.name.replace(/'/g, "\\'")}')"
            style="padding: 8px 16px; background: linear-gradient(135deg, #6a5f70 0%, #7a6f80 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; min-height: 40px; -webkit-tap-highlight-color: transparent; touch-action: manipulation;"
            onmouseover="this.style.transform='translateY(-2px)'"
            onmouseout="this.style.transform='translateY(0)'">
      ${type.name}
    </button>
  `).join('');

  container.innerHTML = html;
}

// æ›´æ–°æ‰¹æ¬¡é¸æ“‡äººæ•¸å’Œè¦–è¦ºå›é¥‹
function updateBatchSelection(personId) {
  const checkbox = document.querySelector(`.batch-checkbox[data-person-id="${personId}"]`);
  const personItem = document.getElementById(`person-item-${personId}`);

  if (checkbox && personItem) {
    const isDarkMode = document.body.classList.contains('dark-mode');
    const index = Array.from(document.querySelectorAll('.person-item')).indexOf(personItem);

    if (checkbox.checked) {
      // é¸ä¸­ç‹€æ…‹ - è—è‰²é«˜äº®
      if (isDarkMode) {
        personItem.style.background = 'linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)';
      } else {
        personItem.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%)';
      }
      personItem.style.borderColor = '#2196f3';
      personItem.style.transform = 'scale(1.02)';
    } else {
      // æœªé¸ä¸­ç‹€æ…‹ - æ¢å¾©åŸæ¨£
      if (isDarkMode) {
        personItem.style.background = index % 2 === 0 ? 'rgba(61, 51, 66, 0.7)' : 'rgba(61, 51, 66, 0.6)';
      } else {
        personItem.style.background = index % 2 === 0 ? '#f9f9f9' : 'white';
      }
      personItem.style.borderColor = 'transparent';
      personItem.style.transform = 'scale(1)';
    }
  }

  // æ›´æ–°è¨ˆæ•¸
  const checkboxes = document.querySelectorAll('.batch-checkbox:checked');
  const count = checkboxes.length;
  const countEl = document.getElementById('batchSelectedCount');
  if (countEl) {
    countEl.textContent = `${count}äºº`;
  }
}

// å…¨é¸æ‰¹æ¬¡æ“ä½œ
function selectAllBatch() {
  const checkboxes = document.querySelectorAll('.batch-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = true;
    const personId = parseInt(cb.dataset.personId);
    updateBatchSelection(personId);
  });
}

// å…¨ä¸é¸æ‰¹æ¬¡æ“ä½œ
function deselectAllBatch() {
  const checkboxes = document.querySelectorAll('.batch-checkbox');
  checkboxes.forEach(cb => {
    cb.checked = false;
    const personId = parseInt(cb.dataset.personId);
    updateBatchSelection(personId);
  });
}

// æ‰¹æ¬¡å¥—ç”¨äº‹æ•…é¡å‹
function applyBatchIncident(incidentType) {
  const checkboxes = document.querySelectorAll('.batch-checkbox:checked');

  if (checkboxes.length === 0) {
    showToast('è«‹å…ˆé¸æ“‡è¦è¨­å®šçš„äººå“¡', 'warning');
    return;
  }

  let successCount = 0;
  checkboxes.forEach(checkbox => {
    const personId = parseInt(checkbox.dataset.personId);
    const person = incidentData.personnelStatuses.find(p => p.id === personId);
    if (person) {
      person.status = incidentType;

      // åŒæ™‚æ›´æ–°ç•«é¢ä¸Šçš„ input å€¼
      const inputEl = document.getElementById(`incident_${personId}`);
      if (inputEl) {
        inputEl.value = incidentType;
      }

      successCount++;
    }
  });

  if (successCount > 0) {
    saveIncidentData();
    calculateIncidentSummary();
    showToast(`å·²å°‡ ${successCount} äººè¨­å®šç‚ºã€Œ${incidentType}ã€`, 'success');

    // æ¸…é™¤é¸æ“‡
    deselectAllBatch();
  } else {
    showToast('è¨­å®šå¤±æ•—,è«‹ç¨å¾Œå†è©¦', 'error');
  }
}

// ========== æ”¶åˆå€å¡Šæ§åˆ¶ ==========

function toggleCollapse(sectionId) {
  const content = document.getElementById(`content-${sectionId}`);
  const arrow = document.getElementById(`arrow-${sectionId}`);

  if (!content || !arrow) return;

  const isExpanded = content.classList.contains('expanded');

  if (isExpanded) {
    content.classList.remove('expanded');
    arrow.classList.remove('expanded');
  } else {
    content.classList.add('expanded');
    arrow.classList.add('expanded');
  }
}

window.addEventListener('load', () => {
  init();
});
</script>
</body>
</html>