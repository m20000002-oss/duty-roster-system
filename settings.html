<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç³»çµ±è¨­å®šä¸­å¿ƒ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
  background: linear-gradient(135deg, #d9c9a8 0%, #c9b896 100%);
  min-height: 100vh;
  padding-bottom: 80px;
  transition: all 0.3s ease;
  position: relative;
}

/* ç´™è³ªç´‹ç†æ•ˆæœ */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  background-image:
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(139, 119, 101, 0.03) 2px, rgba(139, 119, 101, 0.03) 4px),
    repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(139, 119, 101, 0.03) 2px, rgba(139, 119, 101, 0.03) 4px);
  z-index: 0;
  opacity: 0.5;
}

/* === æš—é»‘æ¨¡å¼æ¨£å¼ === */
body.dark-mode {
  background: linear-gradient(135deg, #3E342E 0%, #2C2420 100%);
  color: #e0e0e0;
}

body.dark-mode::before {
  background-image:
    repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(199, 184, 163, 0.05) 2px, rgba(199, 184, 163, 0.05) 4px),
    repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(199, 184, 163, 0.05) 2px, rgba(199, 184, 163, 0.05) 4px);
  opacity: 0.3;
}

body.dark-mode .header {
  background: linear-gradient(135deg, #4A3F35 0%, #5D4F42 100%);
}

body.dark-mode .section {
  background: rgba(62, 52, 46, 0.6);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
}

body.dark-mode .section-title {
  color: #e8dcc8;
}

body.dark-mode .input-text,
body.dark-mode .input-text-area {
  background: rgba(62, 52, 46, 0.6);
  color: #e8dcc8;
  border-color: rgba(201, 184, 150, 0.4);
}

body.dark-mode .input-text::placeholder {
  color: #7f8c8d;
}

body.dark-mode .person-card {
  background: rgba(62, 52, 46, 0.6);
  border-color: rgba(201, 184, 150, 0.3);
}

body.dark-mode .person-name {
  color: #f5e6d3;
}

body.dark-mode .btn-danger {
  background: linear-gradient(135deg, #c62828 0%, #e53935 100%);
}

body.dark-mode .specialty-tag {
  background: #8d6e63;
  color: white;
}

body.dark-mode .toast {
  background: rgba(0, 0, 0, 0.9);
}

.header {
  background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
  padding: 16px 20px;
  box-shadow: 0 4px 12px rgba(94, 53, 177, 0.3);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-title {
  font-size: 22px;
  color: #ffffff;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 700;
}

.back-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 18px;
}

.tab-nav {
  display: flex;
  gap: 5px;
  margin-top: 12px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.tab-btn {
  padding: 10px 16px;
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
}

.tab-btn.active {
  color: #ffffff;
  border-bottom-color: #ffc107;
}

.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.section {
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: #8d6e63;
  margin-bottom: 16px;
}

.input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
}

.input-text {
  flex: 1;
  padding: 12px;
  border: 2px solid #ce93d8;
  border-radius: 10px;
  font-size: 14px;
}

.btn-primary {
  padding: 12px 20px;
  background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-primary:hover {
  transform: translateY(-2px);
}

.person-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.person-item {
  background: #f3e5f5;
  border: 2px solid #ce93d8;
  border-radius: 12px;
  padding: 16px;
}

.person-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.person-name {
  font-size: 16px;
  font-weight: 700;
  color: #8d6e63;
}

.person-rank {
  font-size: 13px;
  color: #9575cd;
  margin-left: 8px;
}

.tags {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}

.tag {
  background: #9575cd;
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.tag-item {
  background: #f3e5f5;
  border: 2px solid #ce93d8;
  border-radius: 12px;
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.tag-name {
  flex: 1;
  font-weight: 600;
  color: #8d6e63;
}

.btn-delete {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
}

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
  padding: 12px 20px;
  display: flex;
  gap: 10px;
  z-index: 99;
}

.footer-btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
}

.btn-sync {
  background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
  color: white;
}

.loading {
  display: none;
  text-align: center;
  padding: 40px;
  color: #9575cd;
}

.loading.show {
  display: block;
}

/* === ç¸½è¦½å¡ç‰‡å¼æ¨£å¼ === */
.overview-card {
  background: #f3e5f5;
  border: 2px solid #ce93d8;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

body.dark-mode .overview-card {
  background: rgba(62, 52, 46, 0.6);
  border-color: rgba(201, 184, 150, 0.3);
}

.overview-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 2px solid rgba(94, 53, 177, 0.2);
}

.overview-card-name {
  font-size: 18px;
  font-weight: 700;
  color: #8d6e63;
}

body.dark-mode .overview-card-name {
  color: #f5e6d3;
}

.overview-card-rank {
  font-size: 13px;
  color: #9575cd;
  margin-left: 8px;
}

.overview-card-row {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  font-size: 13px;
}

.overview-card-label {
  font-weight: 600;
  color: #8d6e63;
  min-width: 80px;
}

body.dark-mode .overview-card-label {
  color: #c9b896;
}

.overview-card-value {
  flex: 1;
  color: #333;
}

body.dark-mode .overview-card-value {
  color: #e0e0e0;
}

/* === æ”¶åˆé¸å–®æ¨£å¼ === */
.person-actions-dropdown {
  position: relative;
  display: inline-block;
}

.person-actions-btn {
  padding: 6px 16px;
  font-size: 13px;
  background: linear-gradient(135deg, #8D6E63 0%, #A1887F 100%);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
}

.person-actions-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.person-actions-menu {
  position: absolute;
  top: 100%;
  right: 0;
  margin-top: 4px;
  background: white;
  border: 2px solid #ce93d8;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  min-width: 150px;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px);
  transition: all 0.3s;
}

.person-actions-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.person-actions-menu button {
  width: 100%;
  padding: 10px 16px;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  font-size: 13px;
  color: #333;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.person-actions-menu button:hover {
  background: #f3e5f5;
}

.person-actions-menu button:first-child {
  border-radius: 8px 8px 0 0;
}

.person-actions-menu button:last-child {
  border-radius: 0 0 8px 8px;
  color: #d32f2f;
}

body.dark-mode .person-actions-menu {
  background: rgba(62, 52, 46, 0.8);
  border-color: rgba(201, 184, 150, 0.4);
}

body.dark-mode .person-actions-menu button {
  color: #e8dcc8;
}

body.dark-mode .person-actions-menu button:hover {
  background: rgba(141, 110, 99, 0.3);
}

/* === äººå“¡åˆ—è¡¨æ©«å‘æ»‘å‹•æ¨£å¼ === */
.person-list-scroll-wrapper {
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  margin: 0 -16px;
  padding: 0 16px;
}

.person-list-scroll-wrapper::-webkit-scrollbar {
  height: 8px;
}

.person-list-scroll-wrapper::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.person-list-scroll-wrapper::-webkit-scrollbar-thumb {
  background: #ce93d8;
  border-radius: 4px;
}

.person-list-scroll-wrapper::-webkit-scrollbar-thumb:hover {
  background: #ba68c8;
}

/* === RWD éŸ¿æ‡‰å¼å„ªåŒ– === */
@media (max-width: 768px) {
  /* æ‰‹æ©Ÿç‰ˆéš±è—è¡¨æ ¼,é¡¯ç¤ºå¡ç‰‡ */
  #overviewTableView {
    display: none !important;
  }

  #overviewCardView {
    display: block !important;
  }

  /* Tab æŒ‰éˆ•ç¸®å°å­—é«” */
  .tab-btn {
    font-size: 12px;
    padding: 8px 10px;
  }

  /* å®¹å™¨èª¿æ•´ */
  .container {
    padding: 12px;
  }

  /* Section èª¿æ•´ */
  .section {
    padding: 16px;
    margin-bottom: 12px;
  }

  /* æ‰¹æ¬¡æ“ä½œæŒ‰éˆ•ç¸®å° */
  #batchActions button {
    font-size: 11px !important;
    padding: 6px 10px !important;
  }

  /* äººå“¡åˆ—è¡¨æ©«å‘æ»‘å‹• */
  .person-list {
    display: flex !important;
    flex-direction: row !important;
    gap: 12px;
    width: max-content;
  }

  .person-list .person-item {
    min-width: 280px;
    max-width: 280px;
    flex-shrink: 0;
  }
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">
    <button class="back-btn" onclick="location.href='index.html'">â†</button>
    âš™ï¸ ç³»çµ±è¨­å®šä¸­å¿ƒ
    <button onclick="toggleTheme()" style="margin-left: auto; width: 42px; height: 42px; border-radius: 50%; background: rgba(255, 255, 255, 0.15); border: none; color: white; font-size: 20px; cursor: pointer; transition: all 0.3s;" id="themeToggle">ğŸŒ™</button>
  </div>
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab(0)">ğŸ“Š äººå“¡ç¸½è¦½</button>
    <button class="tab-btn" onclick="switchTab(1)">ğŸ‘¥ äººå“¡ç®¡ç†</button>
    <button class="tab-btn" onclick="switchTab(2)">ğŸ–ï¸ å°ˆé•·ç®¡ç†</button>
    <button class="tab-btn" onclick="switchTab(3)" style="display: none;">ğŸ” å¯†ç¢¼ç®¡ç†</button>
  </div>
</div>

<div class="container">
  <!-- Tab 1: äººå“¡ç¸½è¦½ -->
  <div class="tab-content active" id="tab0">
    <div class="section">
      <div class="section-title">ğŸ“Š äººå“¡ç¸½è¦½è¡¨æ ¼</div>

      <!-- è¿´æ­¸ç·šé¡¯ç¤ºè¨­å®š -->
      <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <div style="font-size: 14px; font-weight: 600; color: #2e7d32; margin-bottom: 12px;">âš™ï¸ è¿´æ­¸ç·šç³»çµ±é¡¯ç¤ºè¨­å®šï¼ˆçµ±ä¸€è¨­å®šï¼‰</div>
        <div style="font-size: 12px; color: #666; margin-bottom: 12px;">æ­¤è¨­å®šæœƒå¥—ç”¨åˆ°æ‰€æœ‰äººå“¡çš„è¿´æ­¸ç·šç³»çµ±</div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div style="background: white; padding: 12px; border-radius: 8px;">
            <div style="font-size: 13px; font-weight: 600; color: #8d6e63; margin-bottom: 8px;">ğŸ“… æ¯æ—¥æ”¶å‡é¡¯ç¤º</div>
            <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
              <input type="radio" name="vacationCheckin" value="fullname" checked style="width: 16px; height: 16px;">
              <span style="font-size: 13px;">é¡¯ç¤ºå…¨å</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="vacationCheckin" value="nickname" style="width: 16px; height: 16px;">
              <span style="font-size: 13px;">é¡¯ç¤ºæš±ç¨±ï¼ˆå¦‚æœ‰ï¼‰</span>
            </label>
          </div>

          <div style="background: white; padding: 12px; border-radius: 8px;">
            <div style="font-size: 13px; font-weight: 600; color: #8d6e63; margin-bottom: 8px;">ğŸ“‹ äº‹æ•…å›å ±é¡¯ç¤º</div>
            <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px; cursor: pointer;">
              <input type="radio" name="vacationIncident" value="fullname" checked style="width: 16px; height: 16px;">
              <span style="font-size: 13px;">é¡¯ç¤ºå…¨å</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="vacationIncident" value="nickname" style="width: 16px; height: 16px;">
              <span style="font-size: 13px;">é¡¯ç¤ºæš±ç¨±ï¼ˆå¦‚æœ‰ï¼‰</span>
            </label>
          </div>
        </div>

        <button class="btn-primary" onclick="saveVacationDisplaySettings()" style="width: 100%; margin-top: 12px; padding: 10px;">
          ğŸ’¾ å„²å­˜è¿´æ­¸ç·šé¡¯ç¤ºè¨­å®š
        </button>
      </div>

      <!-- æœå°‹å’Œæ‰¹æ¬¡æ“ä½œå€ -->
      <div style="background: #f5f5f5; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <input type="text" class="input-text" id="overviewSearch" placeholder="ğŸ” æœå°‹å§“åæˆ–æš±ç¨±..." oninput="filterOverviewTable()" style="width: 100%;">
          </div>

          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap;">
            <input type="checkbox" id="batchMode" onchange="toggleBatchMode()" style="width: 18px; height: 18px;">
            <span style="font-weight: 600;">æ‰¹æ¬¡æ¨¡å¼</span>
          </label>

          <div id="batchActions" style="display: none; flex: 1; display: flex; gap: 8px;">
            <button class="btn-primary" onclick="batchSetSystems()" style="padding: 8px 16px; font-size: 13px;">ğŸ“± æ‰¹æ¬¡è¨­å®šç³»çµ±</button>
            <button class="btn-primary" onclick="batchSetSpecialties()" style="padding: 8px 16px; font-size: 13px;">ğŸ–ï¸ æ‰¹æ¬¡è¨­å®šå°ˆé•·</button>
          </div>

          <div id="statsInfo" style="font-size: 13px; color: #666; white-space: nowrap;">
            å·²é¸: <strong id="selectedCount">0</strong> äºº | å…± <strong id="totalCount">0</strong> äºº
          </div>
        </div>
      </div>

      <!-- Excel æ¨£å¼è¡¨æ ¼ (æ¡Œé¢ç‰ˆ) -->
      <div id="overviewTableView" style="overflow-x: auto; background: white; border-radius: 12px; border: 2px solid #e0e0e0;">
        <table id="personnelOverviewTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background: linear-gradient(135deg, #8d6e63 0%, #a1887f 100%); color: white;">
              <th style="padding: 12px; text-align: center; width: 40px;">â‹®â‹®</th>
              <th style="padding: 12px; text-align: center; width: 40px;" id="selectAllHeader">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="width: 18px; height: 18px; display: none;">
              </th>
              <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="sortTable('name')">å§“å â†•</th>
              <th style="padding: 12px; text-align: left;">å°ˆé•·</th>
              <th style="padding: 12px; text-align: left;">ç³»çµ±èˆ‡é¡¯ç¤º</th>
              <th style="padding: 12px; text-align: center;">ä¼‘å‡æœŸé–“</th>
              <th style="padding: 12px; text-align: center; width: 80px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="overviewTableBody">
            <!-- å‹•æ…‹ç”Ÿæˆ -->
          </tbody>
        </table>
      </div>

      <!-- å¡ç‰‡å¼å¸ƒå±€ (æ‰‹æ©Ÿç‰ˆ) -->
      <div id="overviewCardView" style="display: none;">
        <div id="overviewCardContainer">
          <!-- å‹•æ…‹ç”Ÿæˆå¡ç‰‡ -->
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 2: äººå“¡ç®¡ç† -->
  <div class="tab-content" id="tab1">
    <div class="section">
      <div class="section-title">æ–°å¢äººå“¡</div>
      <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; color: #1976d2; margin-bottom: 6px;">
              éšç´š + å§“å <span style="color: #f44336;">*</span>
            </label>
            <input type="text" class="input-text" id="newPersonName" placeholder="ä¾‹å¦‚ï¼šä¸Šå°‡è‰¾æ–¯" style="width: 100%;">
            <div style="font-size: 11px; color: #666; margin-top: 4px;">ğŸ’¡ å®Œæ•´çš„éšç´šå’Œå§“å</div>
          </div>
          <div>
            <label style="display: block; font-size: 13px; font-weight: 600; color: #1976d2; margin-bottom: 6px;">
              æš±ç¨± / ç°¡ç¨±
            </label>
            <input type="text" class="input-text" id="newPersonNickname" placeholder="ä¾‹å¦‚ï¼šç«æ‹³" style="width: 100%;">
            <div style="font-size: 11px; color: #666; margin-top: 4px;">ğŸ’¡ é¸å¡«ï¼Œéƒ¨åˆ†ç³»çµ±æœƒé¡¯ç¤ºæš±ç¨±</div>
          </div>
        </div>

        <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
          <div style="font-size: 13px; font-weight: 600; color: #1976d2; margin-bottom: 8px;">ğŸ“± é©ç”¨ç³»çµ±ï¼ˆé è¨­å…¨é¸ï¼‰</div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="newPersonSystem1" value="service" checked style="width: 18px; height: 18px;">
              <span style="font-size: 13px;">æ›´å¼¦æ˜“è½</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="newPersonSystem2" value="task" checked style="width: 18px; height: 18px;">
              <span style="font-size: 13px;">ç«¹æ—è¨ˆç•«</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="newPersonSystem3" value="vacation" checked style="width: 18px; height: 18px;">
              <span style="font-size: 13px;">è¿´æ­¸ç·š</span>
            </label>
          </div>
        </div>

        <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
          <div style="font-size: 13px; font-weight: 600; color: #1976d2; margin-bottom: 8px;">ğŸ–ï¸ å°ˆé•·æ¨™ç±¤</div>
          <div id="newPersonSpecialtiesArea" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">
            <!-- å‹•æ…‹ç”Ÿæˆå°ˆé•·é¸é … -->
          </div>
        </div>

        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; background: white; padding: 8px 12px; border-radius: 8px; flex: 1;">
            <input type="checkbox" id="quickAddMode" style="width: 18px; height: 18px;">
            <span style="font-size: 13px; font-weight: 600;">ğŸš€ å¿«é€Ÿé€£çºŒæ–°å¢æ¨¡å¼</span>
          </label>
          <span id="addedCount" style="font-size: 13px; color: #666; display: none;">å·²æ–°å¢: <strong style="color: #2e7d32;">0</strong> äºº</span>
        </div>

        <button class="btn-primary" onclick="addPersonEnhanced()" style="width: 100%; padding: 14px; font-size: 15px;">
          âœ… æ–°å¢äººå“¡
        </button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">äººå“¡åˆ—è¡¨</div>
      <div class="loading" id="loadingPersonnel">â³ è¼‰å…¥ä¸­...</div>
      <div class="person-list-scroll-wrapper">
        <div class="person-list" id="personnelList"></div>
      </div>
    </div>
  </div>

  <!-- Tab 3: å°ˆé•·ç®¡ç† -->
  <div class="tab-content" id="tab2">
    <div class="section">
      <div class="section-title">ğŸ“‹ å°ˆé•·åˆ—è¡¨ï¼ˆè‡ªå‹•åŒæ­¥ï¼‰</div>
      <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
        <div style="font-size: 14px; font-weight: 600; color: #1976d2; margin-bottom: 8px;">ğŸ’¡ è‡ªå‹•åŒæ­¥èªªæ˜</div>
        <div style="font-size: 13px; color: #666; line-height: 1.6;">
          â€¢ å°ˆé•·åˆ—è¡¨æœƒè‡ªå‹•å¾ã€Œæ›´å¼¦æ˜“è½ã€ç³»çµ±åŒæ­¥<br>
          â€¢ åŒ…å«ï¼šå‹¤å‹™é¡å‹ï¼ˆå®‰å®˜ã€æµ·å“¨ç­‰ï¼‰+ ç‰¹æ®Šè·å‹™ + è»Šè¼›è§’è‰²ï¼ˆè»Šé•·ã€é§•é§›ï¼‰<br>
          â€¢ ç„¡éœ€æ‰‹å‹•ç®¡ç†ï¼Œæ–°å¢è·å‹™æ™‚æœƒè‡ªå‹•æ–°å¢å°æ‡‰å°ˆé•·<br>
          â€¢ äººå“¡é¸æ“‡å°ˆé•·æ™‚ï¼Œæœƒè‡ªå‹•æ›´æ–°ç‚ºæœ€æ–°çš„å°ˆé•·åˆ—è¡¨
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">ç›®å‰å¯ç”¨å°ˆé•·</div>
      <div style="font-size: 13px; color: #666; margin-bottom: 12px;">ğŸ’¡ æç¤ºï¼šå°ˆé•·ç”¨æ–¼ç¯©é¸é©åˆäººå“¡ï¼Œä¾‹å¦‚è»Šè¼›èª¿åº¦æ™‚åªé¡¯ç¤ºæœ‰ã€Œé§•é§›ã€å°ˆé•·çš„äººå“¡</div>
      <div class="tag-list" id="specialtiesList"></div>
    </div>
  </div>

  <!-- Tab 4: å¯†ç¢¼ç®¡ç† -->
  <div class="tab-content" id="tab3">
    <div class="section">
      <div class="section-title">ğŸ” ç³»çµ±å¯†ç¢¼ç®¡ç†</div>
      <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
        <div style="font-size: 14px; font-weight: 600; color: #e65100; margin-bottom: 8px;">âš ï¸ é‡è¦æé†’</div>
        <div style="font-size: 13px; color: #bf360c; line-height: 1.6;">
          â€¢ æ›´æ”¹å¯†ç¢¼å¾Œè«‹å‹™å¿…è¨˜ä½æ–°å¯†ç¢¼<br>
          â€¢ å¯†ç¢¼ä»¥åŠ å¯†æ–¹å¼å„²å­˜ï¼Œç„¡æ³•å¾©åŸ<br>
          â€¢ å¿˜è¨˜å¯†ç¢¼è«‹åƒè€ƒã€Œå¯†ç¢¼è¨­å®šèªªæ˜.mdã€æ–‡ä»¶
        </div>
      </div>

      <div style="background: #f5f5f5; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
        <div style="font-size: 15px; font-weight: 600; color: #8d6e63; margin-bottom: 16px;">ğŸ”‘ æ›´æ”¹ç³»çµ±å¯†ç¢¼</div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">
            ç•¶å‰å¯†ç¢¼
          </label>
          <input type="password" class="input-text" id="currentPassword" placeholder="è«‹è¼¸å…¥ç•¶å‰å¯†ç¢¼" style="width: 100%;">
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">
            æ–°å¯†ç¢¼
          </label>
          <input type="password" class="input-text" id="newPassword" placeholder="è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘4ä½ï¼‰" style="width: 100%;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">
            ç¢ºèªæ–°å¯†ç¢¼
          </label>
          <input type="password" class="input-text" id="confirmPassword" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" style="width: 100%;">
        </div>

        <button class="btn-primary" onclick="changeSystemPassword()" style="width: 100%; padding: 14px; font-size: 15px;">
          ğŸ”’ æ›´æ–°å¯†ç¢¼
        </button>
      </div>

      <div style="background: #e8f5e9; border: 2px solid #4caf50; border-radius: 12px; padding: 16px;">
        <div style="font-size: 14px; font-weight: 600; color: #2e7d32; margin-bottom: 12px;">ğŸ“Š å¯†ç¢¼è¨­å®šç‹€æ…‹</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px; color: #1b5e20;">
          <div>
            <strong>æœ‰æ•ˆæœŸé™:</strong> <span id="passwordExpiryDays">30 å¤©</span>
          </div>
          <div>
            <strong>éŒ¯èª¤é–å®š:</strong> <span id="passwordMaxAttempts">5 æ¬¡</span>
          </div>
          <div>
            <strong>é–å®šæ™‚é•·:</strong> <span id="passwordLockoutTime">15 åˆ†é˜</span>
          </div>
          <div>
            <strong>ä¸Šæ¬¡æ›´æ–°:</strong> <span id="passwordLastUpdate">-</span>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ› ï¸ é€²éšå¯†ç¢¼å·¥å…·</div>

      <div style="background: #f5f5f5; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
        <div style="font-size: 14px; font-weight: 600; color: #8d6e63; margin-bottom: 8px;">ç”Ÿæˆå¯†ç¢¼é›œæ¹Šå€¼ï¼ˆé–‹ç™¼è€…å·¥å…·ï¼‰</div>
        <div style="font-size: 12px; color: #666; margin-bottom: 12px;">
          è¼¸å…¥å¯†ç¢¼å¾Œç”Ÿæˆ SHA-256 é›œæ¹Šå€¼ï¼Œç”¨æ–¼æ‰‹å‹•æ›´æ–° index.html é…ç½®æª”
        </div>
        <div style="display: flex; gap: 8px;">
          <input type="text" class="input-text" id="hashGenInput" placeholder="è¼¸å…¥è¦ç”Ÿæˆé›œæ¹Šçš„å¯†ç¢¼" style="flex: 1;">
          <button class="btn-primary" onclick="generateHash()" style="padding: 10px 20px;">ç”Ÿæˆé›œæ¹Š</button>
        </div>
        <div id="hashOutput" style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; font-family: monospace; font-size: 11px; word-break: break-all; display: none;"></div>
      </div>

      <button class="btn-primary" onclick="openPasswordDoc()" style="width: 100%; background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);">
        ğŸ“– æŸ¥çœ‹å¯†ç¢¼è¨­å®šèªªæ˜æ–‡ä»¶
      </button>
    </div>
  </div>
</div>

<div class="footer">
  <button class="footer-btn" onclick="exportData()" style="background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);">ğŸ“¥ åŒ¯å‡ºå®Œæ•´è³‡æ–™</button>
  <button class="footer-btn" onclick="document.getElementById('importFile').click()" style="background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);">ğŸ“¤ åŒ¯å…¥å®Œæ•´è³‡æ–™</button>
</div>
<input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">

<script>
// ç§»é™¤é›²ç«¯ APIï¼Œæ”¹ç‚ºç´”æœ¬åœ°å„²å­˜æ¨¡å¼

let data = {
  personnel: [
    {
      id: Date.now() + 1,
      name: 'ä¸Šå£«ç¨å­¤æ±‚æ•—',
      nickname: 'æ±‚æ•—',
      rank: '',
      specialties: ['ğŸš— ç–¾é¢¨é§•é§›', 'ğŸ‘‘ éµè¡€è»Šé•·'],
      systems: ['service', 'task', 'vacation'],
      displayPreference: {
        service: 'fullname',
        task: 'nickname',
        vacation: 'fullname'
      },
      vacationStart: null,
      vacationEnd: null,
      enabled: true
    },
    {
      id: Date.now() + 2,
      name: 'ä¸­å£«é­¯å¤«',
      nickname: 'è‰å¸½',
      rank: '',
      specialties: ['ğŸš— ç–¾é¢¨é§•é§›', 'ğŸŒŠ æµ·å¢ƒå“¨å…µ'],
      systems: ['service', 'task', 'vacation'],
      displayPreference: {
        service: 'nickname',
        task: 'nickname',
        vacation: 'fullname'
      },
      vacationStart: null,
      vacationEnd: null,
      enabled: true
    },
    {
      id: Date.now() + 3,
      name: 'ä¸‹å£«é›·ç¥ç´¢çˆ¾',
      nickname: 'ç´¢çˆ¾',
      rank: '',
      specialties: ['ğŸ›¡ï¸ å®ˆè­·å®‰å®˜', 'ğŸ¯ ç¥å°„æ‰‹'],
      systems: ['service', 'task', 'vacation'],
      displayPreference: {
        service: 'fullname',
        task: 'fullname',
        vacation: 'nickname'
      },
      vacationStart: null,
      vacationEnd: null,
      enabled: true
    },
    {
      id: Date.now() + 4,
      name: 'ä¸Šå…µè«¸è‘›äº®',
      nickname: 'å­”æ˜',
      rank: '',
      specialties: ['ğŸ“¡ é€šè¨Šä½¿è€…', 'ğŸ‘‘ éµè¡€è»Šé•·'],
      systems: ['service', 'task', 'vacation'],
      displayPreference: {
        service: 'nickname',
        task: 'fullname',
        vacation: 'fullname'
      },
      vacationStart: null,
      vacationEnd: null,
      enabled: true
    },
    {
      id: Date.now() + 5,
      name: 'ä¸‹å£«å¤¢ç„¡é›²',
      nickname: 'åœ“æ»¿',
      rank: '',
      specialties: ['ğŸš— ç–¾é¢¨é§•é§›'],
      systems: ['service', 'task', 'vacation'],
      displayPreference: {
        service: 'fullname',
        task: 'nickname',
        vacation: 'nickname'
      },
      vacationStart: null,
      vacationEnd: null,
      enabled: true
    },
    {
      id: Date.now() + 6,
      name: 'äºŒå…µæ‚Ÿç©º',
      nickname: 'çŒ´å“¥',
      rank: '',
      specialties: ['ğŸ¯ ç¥å°„æ‰‹', 'âš”ï¸ è¡›åŸå“¨å…µ'],
      systems: ['service', 'task', 'vacation'],
      displayPreference: {
        service: 'nickname',
        task: 'nickname',
        vacation: 'nickname'
      },
      vacationStart: null,
      vacationEnd: null,
      enabled: true
    },
    {
      id: Date.now() + 7,
      name: 'ä¸€å…µé³´äºº',
      nickname: 'ç«å½±',
      rank: '',
      specialties: ['ğŸŒŠ æµ·å¢ƒå“¨å…µ'],
      systems: ['service', 'task', 'vacation'],
      displayPreference: {
        service: 'fullname',
        task: 'nickname',
        vacation: 'fullname'
      },
      vacationStart: null,
      vacationEnd: null,
      enabled: true
    }
  ],
  specialties: ['ğŸš— ç–¾é¢¨é§•é§›', 'ğŸ‘‘ éµè¡€è»Šé•·', 'ğŸ›¡ï¸ å®ˆè­·å®‰å®˜', 'ğŸŒŠ æµ·å¢ƒå“¨å…µ', 'âš”ï¸ è¡›åŸå“¨å…µ', 'ğŸ”§ è£ç”²æŠ€å¸«', 'ğŸ“¡ é€šè¨Šä½¿è€…', 'ğŸ¯ ç¥å°„æ‰‹'],
  incidentTypes: [
    { id: 1, name: 'ğŸ  è¿”é„‰ä¹‹æ—…', countAsIncident: true },
    { id: 2, name: 'ğŸ® é»ƒé‡‘å‡æœŸ', countAsIncident: true },
    { id: 3, name: 'ğŸ“š ä¿®ç·´ä¹‹è·¯', countAsIncident: true },
    { id: 4, name: 'ğŸ² å»šè—å¤§å¸«', countAsIncident: false },
    { id: 5, name: 'ğŸ§¼ æ¸…æ½”ç‰¹æ”»éšŠ', countAsIncident: false },
    { id: 6, name: 'ğŸ’Š ç™‚é¤Šä¸­å¿ƒ', countAsIncident: false },
    { id: 7, name: 'ğŸŒ™ å¤œé–“å®ˆè­·è€…', countAsIncident: false },
    { id: 8, name: 'ğŸ˜´ é€±æœ«ä¼‘é¤Š', countAsIncident: false },
    { id: 9, name: 'ğŸš— ç‹ç‰Œé§•é§›', countAsIncident: false },
    { id: 10, name: 'ğŸŒ… è¥¿æ–¹æˆ°å£«', countAsIncident: false }
  ],
  incidentPersonnelIds: []
};

// åˆå§‹åŒ–
async function init() {
  await loadFromCache();
  render();
}

// å¾å¿«å–è¼‰å…¥
async function loadFromCache() {
  const personnelCache = localStorage.getItem('personnel_cache');
  const specialtiesCache = localStorage.getItem('specialties_cache');
  const incidentTypesCache = localStorage.getItem('incident_types');
  const incidentPersonnelCache = localStorage.getItem('incident_personnel_ids');

  if (personnelCache) {
    data.personnel = JSON.parse(personnelCache);

    // ç‚ºæ²’æœ‰ id çš„èˆŠäººå“¡è£œä¸Š id
    let needSave = false;
    data.personnel.forEach((p, index) => {
      if (!p.id) {
        p.id = Date.now() + index; // ç¢ºä¿æ¯å€‹ ID éƒ½ä¸åŒ
        needSave = true;
      }
      // è£œä¸Š nickname å’Œ displayPreferenceï¼ˆèˆŠè³‡æ–™ç›¸å®¹æ€§ï¼‰
      if (p.nickname === undefined) {
        p.nickname = null;
        needSave = true;
      }
      if (!p.displayPreference) {
        p.displayPreference = {
          service: 'fullname',
          task: 'fullname',
          vacation: 'fullname'
        };
        needSave = true;
      }
    });

    if (needSave) {
      saveToCache(); // å„²å­˜æ›´æ–°å¾Œçš„è³‡æ–™
    }
  } else {
    // é¦–æ¬¡ä½¿ç”¨ï¼Œä½¿ç”¨é è¨­çš„7ä½ç¯„ä¾‹äººå“¡ï¼ˆå·²åœ¨ data åˆå§‹åŒ–æ™‚è¨­å®šï¼‰
    console.log('ğŸ“ é¦–æ¬¡ä½¿ç”¨ï¼Œè¼‰å…¥é è¨­ç¯„ä¾‹äººå“¡:', data.personnel.length, 'ä½');
    saveToCache();
  }

  // ğŸ”§ è‡¨æ™‚ä¿®æ­£ï¼šå¦‚æœäººå“¡è³‡æ–™æ˜¯ç©ºçš„ï¼Œå¼·åˆ¶è¼‰å…¥ç¯„ä¾‹è³‡æ–™
  if (data.personnel.length === 0) {
    console.warn('âš ï¸ åµæ¸¬åˆ°äººå“¡è³‡æ–™ç‚ºç©ºï¼Œé‡æ–°è¼‰å…¥ç¯„ä¾‹è³‡æ–™');
    // é‡æ–°åˆå§‹åŒ– data.personnel
    data.personnel = [
      {
        id: Date.now() + 1,
        name: 'ä¸Šå£«ç¨å­¤æ±‚æ•—',
        nickname: 'æ±‚æ•—',
        rank: '',
        specialties: ['ğŸš— ç–¾é¢¨é§•é§›', 'ğŸ‘‘ éµè¡€è»Šé•·'],
        systems: ['service', 'task', 'vacation'],
        displayPreference: { service: 'fullname', task: 'nickname', vacation: 'fullname' },
        vacationStart: null,
        vacationEnd: null,
        enabled: true
      },
      {
        id: Date.now() + 2,
        name: 'ä¸­å£«é­¯å¤«',
        nickname: 'è‰å¸½',
        rank: '',
        specialties: ['ğŸš— ç–¾é¢¨é§•é§›', 'ğŸŒŠ æµ·å¢ƒå“¨å…µ'],
        systems: ['service', 'task', 'vacation'],
        displayPreference: { service: 'nickname', task: 'nickname', vacation: 'fullname' },
        vacationStart: null,
        vacationEnd: null,
        enabled: true
      },
      {
        id: Date.now() + 3,
        name: 'ä¸‹å£«é›·ç¥ç´¢çˆ¾',
        nickname: 'ç´¢çˆ¾',
        rank: '',
        specialties: ['ğŸ›¡ï¸ å®ˆè­·å®‰å®˜', 'ğŸ¯ ç¥å°„æ‰‹'],
        systems: ['service', 'task', 'vacation'],
        displayPreference: { service: 'fullname', task: 'fullname', vacation: 'nickname' },
        vacationStart: null,
        vacationEnd: null,
        enabled: true
      },
      {
        id: Date.now() + 4,
        name: 'ä¸Šå…µè«¸è‘›äº®',
        nickname: 'å­”æ˜',
        rank: '',
        specialties: ['ğŸ“¡ é€šè¨Šä½¿è€…', 'ğŸ‘‘ éµè¡€è»Šé•·'],
        systems: ['service', 'task', 'vacation'],
        displayPreference: { service: 'nickname', task: 'fullname', vacation: 'fullname' },
        vacationStart: null,
        vacationEnd: null,
        enabled: true
      },
      {
        id: Date.now() + 5,
        name: 'ä¸‹å£«å¤¢ç„¡é›²',
        nickname: 'åœ“æ»¿',
        rank: '',
        specialties: ['ğŸš— ç–¾é¢¨é§•é§›'],
        systems: ['service', 'task', 'vacation'],
        displayPreference: { service: 'fullname', task: 'nickname', vacation: 'nickname' },
        vacationStart: null,
        vacationEnd: null,
        enabled: true
      },
      {
        id: Date.now() + 6,
        name: 'äºŒå…µæ‚Ÿç©º',
        nickname: 'çŒ´å“¥',
        rank: '',
        specialties: ['ğŸ¯ ç¥å°„æ‰‹', 'âš”ï¸ è¡›åŸå“¨å…µ'],
        systems: ['service', 'task', 'vacation'],
        displayPreference: { service: 'nickname', task: 'nickname', vacation: 'nickname' },
        vacationStart: null,
        vacationEnd: null,
        enabled: true
      },
      {
        id: Date.now() + 7,
        name: 'ä¸€å…µé³´äºº',
        nickname: 'ç«å½±',
        rank: '',
        specialties: ['ğŸŒŠ æµ·å¢ƒå“¨å…µ'],
        systems: ['service', 'task', 'vacation'],
        displayPreference: { service: 'fullname', task: 'nickname', vacation: 'fullname' },
        vacationStart: null,
        vacationEnd: null,
        enabled: true
      }
    ];
    saveToCache();
  }

  if (specialtiesCache) {
    data.specialties = JSON.parse(specialtiesCache);
  } else {
    // é¦–æ¬¡ä½¿ç”¨ï¼Œä¿å­˜é è¨­çš„8ç¨®è¶£å‘³å°ˆé•·
    console.log('ğŸ“ é¦–æ¬¡ä½¿ç”¨ï¼Œè¼‰å…¥é è¨­å°ˆé•·:', data.specialties.length, 'ç¨®');
    localStorage.setItem('specialties_cache', JSON.stringify(data.specialties));
  }

  // ğŸ”§ è‡¨æ™‚ä¿®æ­£ï¼šå¦‚æœå°ˆé•·è³‡æ–™æ˜¯ç©ºçš„ï¼Œå¼·åˆ¶è¼‰å…¥ç¯„ä¾‹è³‡æ–™
  if (data.specialties.length === 0) {
    console.warn('âš ï¸ åµæ¸¬åˆ°å°ˆé•·è³‡æ–™ç‚ºç©ºï¼Œé‡æ–°è¼‰å…¥ç¯„ä¾‹è³‡æ–™');
    data.specialties = ['ğŸš— ç–¾é¢¨é§•é§›', 'ğŸ‘‘ éµè¡€è»Šé•·', 'ğŸ›¡ï¸ å®ˆè­·å®‰å®˜', 'ğŸŒŠ æµ·å¢ƒå“¨å…µ', 'âš”ï¸ è¡›åŸå“¨å…µ', 'ğŸ”§ è£ç”²æŠ€å¸«', 'ğŸ“¡ é€šè¨Šä½¿è€…', 'ğŸ¯ ç¥å°„æ‰‹'];
    localStorage.setItem('specialties_cache', JSON.stringify(data.specialties));
  }

  if (incidentTypesCache) {
    data.incidentTypes = JSON.parse(incidentTypesCache);
  } else {
    // é¦–æ¬¡ä½¿ç”¨ï¼Œä¿å­˜é è¨­çš„10ç¨®è¶£å‘³äº‹æ•…é¡å‹
    console.log('ğŸ“ é¦–æ¬¡ä½¿ç”¨ï¼Œè¼‰å…¥é è¨­äº‹æ•…é¡å‹:', data.incidentTypes.length, 'ç¨®');
    localStorage.setItem('incident_types', JSON.stringify(data.incidentTypes));
  }

  // ğŸ”§ è‡¨æ™‚ä¿®æ­£ï¼šå¦‚æœäº‹æ•…é¡å‹è³‡æ–™æ˜¯ç©ºçš„ï¼Œå¼·åˆ¶è¼‰å…¥ç¯„ä¾‹è³‡æ–™
  if (data.incidentTypes.length === 0) {
    console.warn('âš ï¸ åµæ¸¬åˆ°äº‹æ•…é¡å‹è³‡æ–™ç‚ºç©ºï¼Œé‡æ–°è¼‰å…¥ç¯„ä¾‹è³‡æ–™');
    data.incidentTypes = [
      { id: 1, name: 'ğŸ  è¿”é„‰ä¹‹æ—…', countAsIncident: true },
      { id: 2, name: 'ğŸ® é»ƒé‡‘å‡æœŸ', countAsIncident: true },
      { id: 3, name: 'ğŸ“š ä¿®ç·´ä¹‹è·¯', countAsIncident: true },
      { id: 4, name: 'ğŸ² å»šè—å¤§å¸«', countAsIncident: false },
      { id: 5, name: 'ğŸ§¼ æ¸…æ½”ç‰¹æ”»éšŠ', countAsIncident: false },
      { id: 6, name: 'ğŸ’Š ç™‚é¤Šä¸­å¿ƒ', countAsIncident: false },
      { id: 7, name: 'ğŸŒ™ å¤œé–“å®ˆè­·è€…', countAsIncident: false },
      { id: 8, name: 'ğŸ˜´ é€±æœ«ä¼‘é¤Š', countAsIncident: false },
      { id: 9, name: 'ğŸš— ç‹ç‰Œé§•é§›', countAsIncident: false },
      { id: 10, name: 'ğŸŒ… è¥¿æ–¹æˆ°å£«', countAsIncident: false }
    ];
    localStorage.setItem('incident_types', JSON.stringify(data.incidentTypes));
  }

  if (incidentPersonnelCache) {
    data.incidentPersonnelIds = JSON.parse(incidentPersonnelCache);
  }
}

// æ¸²æŸ“å…¨éƒ¨
function render() {
  console.log('ğŸ”„ render() åŸ·è¡Œä¸­...');
  console.log('äººå“¡æ•¸:', data.personnel.length);
  console.log('å°ˆé•·æ•¸:', data.specialties.length);
  console.log('äº‹æ•…é¡å‹æ•¸:', data.incidentTypes.length);

  renderPersonnel();
  renderSpecialties();
  renderSpecialtiesCheckboxes();
  loadPasswordSettings();
  loadVacationDisplaySettings();
  renderOverviewTable();

  console.log('âœ… render() å®Œæˆ');
}

// æ¸²æŸ“å°ˆé•·è¤‡é¸æ¡†ï¼ˆåœ¨æ–°å¢äººå“¡å€åŸŸï¼‰
function renderSpecialtiesCheckboxes() {
  const container = document.getElementById('newPersonSpecialtiesArea');
  if (!container) return;

  // å…ˆåŒæ­¥æœ€æ–°çš„å°ˆé•·ä¸¦å–å¾—åˆ†é¡è³‡æ–™
  const serviceData = localStorage.getItem('duty_pro_v2_data');
  const categories = {
    dutyTypes: [],
    specialDuties: [],
    vehicles: ['è»Šé•·', 'é§•é§›']
  };

  if (serviceData) {
    try {
      const parsed = JSON.parse(serviceData);
      if (parsed.dutyTypes && Array.isArray(parsed.dutyTypes)) {
        categories.dutyTypes = parsed.dutyTypes;
      }
      if (parsed.specialDuties && Array.isArray(parsed.specialDuties)) {
        categories.specialDuties = parsed.specialDuties.map(d => d.name);
      }
    } catch (e) {
      console.warn('ç„¡æ³•è®€å– service.html è³‡æ–™');
    }
  }

  if (data.specialties.length === 0) {
    container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #999; padding: 12px; font-size: 13px;">å°šç„¡å°ˆé•·ï¼Œè«‹å…ˆåœ¨ã€Œå°ˆé•·ç®¡ç†ã€æ–°å¢</div>';
    return;
  }

  // ä¸‰é¡å¡ç‰‡ UI
  const html = `
    <div style="grid-column: 1/-1; display: flex; flex-direction: column; gap: 12px;">
      <!-- è¼ªå€¼å‹¤å‹™å°ˆé•· -->
      ${categories.dutyTypes.length > 0 ? `
        <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 12px;">
          <div style="font-size: 13px; font-weight: 700; color: #1976d2; margin-bottom: 8px;">ğŸ“‹ è¼ªå€¼å‹¤å‹™å°ˆé•·</div>
          <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            ${categories.dutyTypes.map(specialty => `
              <label style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: white; border: 2px solid #90caf9; border-radius: 6px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" value="${specialty}" style="width: 14px; height: 14px;">
                <span>${specialty}</span>
              </label>
            `).join('')}
          </div>
        </div>
      ` : ''}

      <!-- ç‰¹æ®Šè·å‹™å°ˆé•· -->
      ${categories.specialDuties.length > 0 ? `
        <div style="background: #fce4ec; border: 2px solid #f06292; border-radius: 8px; padding: 12px;">
          <div style="font-size: 13px; font-weight: 700; color: #c2185b; margin-bottom: 8px;">â­ ç‰¹æ®Šè·å‹™å°ˆé•·</div>
          <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            ${categories.specialDuties.map(specialty => `
              <label style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: white; border: 2px solid #f48fb1; border-radius: 6px; cursor: pointer; font-size: 12px;">
                <input type="checkbox" value="${specialty}" style="width: 14px; height: 14px;">
                <span>${specialty}</span>
              </label>
            `).join('')}
          </div>
        </div>
      ` : ''}

      <!-- è»Šè¼›è§’è‰²å°ˆé•· -->
      <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 12px;">
        <div style="font-size: 13px; font-weight: 700; color: #f57c00; margin-bottom: 8px;">ğŸš— è»Šè¼›è§’è‰²å°ˆé•·</div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
          ${categories.vehicles.map(specialty => `
            <label style="display: flex; align-items: center; gap: 4px; padding: 6px 10px; background: white; border: 2px solid #ffb74d; border-radius: 6px; cursor: pointer; font-size: 12px;">
              <input type="checkbox" value="${specialty}" style="width: 14px; height: 14px;">
              <span>${specialty}</span>
            </label>
          `).join('')}
        </div>
      </div>
    </div>
  `;

  container.innerHTML = html;
}

// æ¸²æŸ“äººå“¡åˆ—è¡¨
function renderPersonnel() {
  const list = document.getElementById('personnelList');
  const loading = document.getElementById('loadingPersonnel');

  if (data.personnel.length === 0) {
    loading.classList.add('show');
    loading.textContent = 'å°šç„¡äººå“¡è³‡æ–™';
    list.innerHTML = '';
    return;
  }

  loading.classList.remove('show');

  const systemNames = { service: 'æ›´å¼¦æ˜“è½', task: 'ç«¹æ—è¨ˆç•«', vacation: 'è¿´æ­¸ç·š' };
  const html = data.personnel.map((p, i) => `
    <div class="person-item">
      <div class="person-header">
        <div>
          <span class="person-name">${p.name}</span>
          ${p.nickname ? `<span class="person-rank" style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 6px; margin-left: 8px;">æš±ç¨±: ${p.nickname}</span>` : ''}
          ${p.rank ? `<span class="person-rank">${p.rank}</span>` : ''}
        </div>
      </div>
      <div>
        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">é©ç”¨ç³»çµ±ï¼š</div>
        <div class="tags">
          ${(p.systems || []).map(s => `<span class="tag" style="background: #2196f3;">${systemNames[s] || s}</span>`).join('') || '<span style="color: #999; font-size: 12px;">ç„¡</span>'}
        </div>
      </div>
      <div style="margin-top: 8px;">
        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">å°ˆé•·ï¼š</div>
        <div class="tags">
          ${(p.specialties || []).map(s => `<span class="tag" style="background: #ff9800;">${s}</span>`).join('') || '<span style="color: #999; font-size: 12px;">ç„¡</span>'}
        </div>
      </div>
      <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
        <div style="flex: 1;">
          <div style="font-size: 13px; color: #666; margin-bottom: 4px;">ä¼‘å‡æœŸé–“ï¼š</div>
          <div style="font-size: 13px; color: ${p.vacationStart && p.vacationEnd ? '#e91e63' : '#999'};">
            ${p.vacationStart && p.vacationEnd ? `${p.vacationStart} ~ ${p.vacationEnd}` : 'æœªè¨­å®š'}
          </div>
        </div>
        <div class="person-actions-dropdown">
          <button class="person-actions-btn" onclick="togglePersonActions(${i}, event)">
            <span>âš™ï¸ æ“ä½œ</span>
            <span style="font-size: 10px;">â–¼</span>
          </button>
          <div class="person-actions-menu" id="person-menu-${i}">
            <button onclick="editPersonBasicInfo(${i}); closePersonActions(${i})">âœï¸ ç·¨è¼¯åŸºæœ¬è³‡æ–™</button>
            <button onclick="editPersonSystems(${i}); closePersonActions(${i})">ğŸ“± è¨­å®šç³»çµ±</button>
            <button onclick="editPersonSpecialties(${i}); closePersonActions(${i})">ğŸ–ï¸ è¨­å®šå°ˆé•·</button>
            <button onclick="editPersonVacation(${i}); closePersonActions(${i})">ğŸ–ï¸ è¨­å®šä¼‘å‡</button>
            <button onclick="deletePerson(${i}); closePersonActions(${i})">ğŸ—‘ï¸ åˆªé™¤äººå“¡</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');

  list.innerHTML = html;
}

// æ–°å¢äººå“¡ï¼ˆå¢å¼·ç‰ˆï¼‰
function addPersonEnhanced() {
  const name = document.getElementById('newPersonName').value.trim();
  const nickname = document.getElementById('newPersonNickname').value.trim();

  if (!name) {
    alert('è«‹è¼¸å…¥å§“å');
    return;
  }

  // æª¢æŸ¥æ˜¯å¦é‡è¤‡
  if (data.personnel.find(p => p.name === name)) {
    alert('æ­¤äººå“¡å·²å­˜åœ¨ï¼');
    return;
  }

  // å–å¾—é¸ä¸­çš„ç³»çµ±
  const systems = [];
  if (document.getElementById('newPersonSystem1').checked) systems.push('service');
  if (document.getElementById('newPersonSystem2').checked) systems.push('task');
  if (document.getElementById('newPersonSystem3').checked) systems.push('vacation');

  if (systems.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é©ç”¨ç³»çµ±');
    return;
  }

  // å–å¾—é¸ä¸­çš„å°ˆé•·
  const specialties = [];
  document.querySelectorAll('#newPersonSpecialtiesArea input[type="checkbox"]:checked').forEach(cb => {
    specialties.push(cb.value);
  });

  // æ–°å¢äººå“¡
  data.personnel.push({
    id: Date.now(),
    name,
    nickname: nickname || null,  // æš±ç¨±æ¬„ä½
    rank: '',  // éšç´šå·²åŒ…å«åœ¨ name ä¸­
    specialties,
    systems,
    enabled: true,
    vacationStart: null,
    vacationEnd: null
  });

  // æª¢æŸ¥å¿«é€Ÿæ–°å¢æ¨¡å¼
  const quickAddMode = document.getElementById('quickAddMode').checked;

  saveToCache();
  render();

  if (quickAddMode) {
    // å¿«é€Ÿæ–°å¢æ¨¡å¼ï¼šæ¸…ç©ºè¡¨å–®ä¸¦èšç„¦
    document.getElementById('newPersonName').value = '';
    document.getElementById('newPersonNickname').value = '';
    document.querySelectorAll('#newPersonSpecialtiesArea input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
    });

    // æ›´æ–°è¨ˆæ•¸
    const countEl = document.getElementById('addedCount');
    countEl.style.display = 'inline';
    const currentCount = parseInt(countEl.querySelector('strong').textContent) + 1;
    countEl.querySelector('strong').textContent = currentCount;

    // èšç„¦åˆ°å§“åæ¬„ä½
    document.getElementById('newPersonName').focus();

    // é¡¯ç¤ºç°¡çŸ­æç¤º
    showQuickToast(`âœ… å·²æ–°å¢: ${name}${nickname ? ' (' + nickname + ')' : ''}`);
  } else {
    // ä¸€èˆ¬æ¨¡å¼ï¼šå®Œæ•´æ¸…ç©º
    document.getElementById('newPersonName').value = '';
    document.getElementById('newPersonNickname').value = '';
    document.getElementById('newPersonSystem1').checked = true;
    document.getElementById('newPersonSystem2').checked = true;
    document.getElementById('newPersonSystem3').checked = true;
    document.querySelectorAll('#newPersonSpecialtiesArea input[type="checkbox"]').forEach(cb => {
      cb.checked = false;
    });

    alert(`âœ… å·²æ–°å¢äººå“¡: ${name}${nickname ? ' (' + nickname + ')' : ''}`);
  }
}

// å¿«é€Ÿæç¤ºè¨Šæ¯
function showQuickToast(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed; top: 20px; right: 20px; background: #4caf50; color: white;
    padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000;
    animation: slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

// ç›£è½å¿«é€Ÿæ–°å¢æ¨¡å¼åˆ‡æ›
document.addEventListener('DOMContentLoaded', function() {
  const quickAddCheckbox = document.getElementById('quickAddMode');
  if (quickAddCheckbox) {
    quickAddCheckbox.addEventListener('change', function() {
      const countEl = document.getElementById('addedCount');
      if (this.checked) {
        countEl.style.display = 'inline';
        countEl.querySelector('strong').textContent = '0';
      } else {
        countEl.style.display = 'none';
      }
    });
  }
});

// èˆŠç‰ˆæ–°å¢äººå“¡ï¼ˆä¿ç•™ç›¸å®¹æ€§ï¼‰
function addPerson() {
  addPersonEnhanced();
}

// åˆªé™¤äººå“¡
function deletePerson(index) {
  if (confirm(`ç¢ºå®šåˆªé™¤ ${data.personnel[index].name} å—ï¼Ÿ`)) {
    data.personnel.splice(index, 1);
    saveToCache();
    render();
  }
}

// å„²å­˜åˆ°å¿«å–
function saveToCache() {
  localStorage.setItem('personnel_cache', JSON.stringify(data.personnel));
  localStorage.setItem('specialties_cache', JSON.stringify(data.specialties));
  localStorage.setItem('incident_types', JSON.stringify(data.incidentTypes));
  localStorage.setItem('incident_personnel_ids', JSON.stringify(data.incidentPersonnelIds));
}

// åŒ¯å‡ºå®Œæ•´è³‡æ–™ (å‚™ä»½)
function exportData() {
  // è®€å–å›æ­¸ç·šé¡¯ç¤ºè¨­å®š
  const vacationSettings = JSON.parse(
    localStorage.getItem('vacation_display_settings') ||
    '{"checkin":"fullname","incident":"fullname"}'
  );

  // è®€å–å›æ­¸ç·šè³‡æ–™
  const vacationData = JSON.parse(localStorage.getItem('return_v2_data') || '{}');

  // è®€å–æ›´å¼¦æ˜“è½è³‡æ–™
  const serviceData = JSON.parse(localStorage.getItem('duty_pro_v2_data') || '{}');

  const exportData = {
    version: '2.3',  // ç‰ˆæœ¬å‡ç´š
    exportTime: new Date().toISOString(),
    // åŸæœ‰è³‡æ–™
    personnel: data.personnel,
    specialties: data.specialties,
    incidentTypes: data.incidentTypes,
    vacationSettings: vacationSettings,
    // æ“´å……ï¼šå›æ­¸ç·šè³‡æ–™
    vacationTimeSlots: vacationData.timeSlots || ['2222', 'éš”å¤© 0555'],
    vacationTemplates: vacationData.templates || {},
    // æ“´å……ï¼šæ›´å¼¦æ˜“è½è³‡æ–™
    vehicles: serviceData.vehicles || [],
    dutyTypes: serviceData.dutyTypes || ['å®‰å®˜', 'æµ·å“¨'],
    dutyTypeTemplates: serviceData.dutyTypeTemplates || [],
    specialDuties: serviceData.specialDuties || []
  };

  // è©¢å•æ˜¯å¦åŠ å¯†
  const encrypt = confirm('ğŸ“¦ åŒ¯å‡ºå®Œæ•´è³‡æ–™\n\nåŒ…å«ï¼šäººå“¡ã€å°ˆé•·ã€äº‹æ•…é¡å‹ã€è»Šè¼›ã€æ”¶å‡æ™‚æ®µã€è¼ªå€¼å‹¤å‹™ã€ç‰¹æ®Šè·å‹™\n\næ˜¯å¦åŠ å¯†ï¼Ÿ\n\nâœ… æ˜¯ - éœ€è¦å¯†ç¢¼æ‰èƒ½åŒ¯å…¥ï¼ˆæ¨è–¦ï¼‰\nâŒ å¦ - ä¸€èˆ¬æ ¼å¼åŒ¯å‡º');

  const timestamp = new Date().toISOString().slice(0, 10);

  if (encrypt) {
    const password = prompt('ğŸ” è«‹è¨­å®šåŒ¯å‡ºå¯†ç¢¼ï¼š\n\nï¼ˆè«‹è¨˜ä½æ­¤å¯†ç¢¼ï¼ŒåŒ¯å…¥æ™‚éœ€è¦ï¼‰');
    if (!password) {
      alert('å·²å–æ¶ˆåŒ¯å‡º');
      return;
    }

    if (password.length < 4) {
      alert('å¯†ç¢¼è‡³å°‘éœ€è¦ 4 å€‹å­—å…ƒ');
      return;
    }

    // AES åŠ å¯†
    const dataStr = JSON.stringify(exportData);
    const encrypted = CryptoJS.AES.encrypt(dataStr, password).toString();

    const encryptedData = {
      encrypted: true,
      version: '2.1',
      data: encrypted,
      timestamp: new Date().toISOString()
    };

    const blob = new Blob([JSON.stringify(encryptedData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `complete_backup_encrypted_${timestamp}.json`;
    a.click();
    URL.revokeObjectURL(url);

    alert('âœ… å·²åŠ å¯†åŒ¯å‡ºå®Œæ•´è³‡æ–™ï¼\n\nåŒ…å«ï¼šäººå“¡ã€å°ˆé•·ã€äº‹æ•…é¡å‹ã€è»Šè¼›ã€æ”¶å‡æ™‚æ®µã€è¼ªå€¼å‹¤å‹™ã€ç‰¹æ®Šè·å‹™\n\nè«‹å¦¥å–„ä¿ç®¡å¯†ç¢¼å’Œæª”æ¡ˆ');
  } else {
    // ä¸€èˆ¬åŒ¯å‡º
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `complete_backup_${timestamp}.json`;
    a.click();
    URL.revokeObjectURL(url);

    alert('âœ… å®Œæ•´è³‡æ–™å·²åŒ¯å‡ºï¼\n\nåŒ…å«ï¼šäººå“¡ã€å°ˆé•·ã€äº‹æ•…é¡å‹ã€è»Šè¼›ã€æ”¶å‡æ™‚æ®µã€è¼ªå€¼å‹¤å‹™ã€ç‰¹æ®Šè·å‹™');
  }
}

// åŒ¯å…¥å®Œæ•´è³‡æ–™ (é‚„åŸ)
function importData(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (!confirm('âš ï¸ åŒ¯å…¥æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šç¹¼çºŒå—ï¼Ÿ')) {
    event.target.value = '';
    return;
  }

  const reader = new FileReader();

  reader.onload = function(e) {
    try {
      const json = JSON.parse(e.target.result);

      // æª¢æŸ¥æ˜¯å¦ç‚ºåŠ å¯†æª”æ¡ˆ
      if (json.encrypted) {
        const password = prompt('ğŸ” æ­¤æª”æ¡ˆå·²åŠ å¯†\n\nè«‹è¼¸å…¥å¯†ç¢¼ï¼š');
        if (!password) {
          alert('å·²å–æ¶ˆåŒ¯å…¥');
          event.target.value = '';
          return;
        }

        try {
          // è§£å¯†
          const decrypted = CryptoJS.AES.decrypt(json.data, password);
          const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);

          if (!decryptedStr) {
            alert('âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•è§£å¯†');
            event.target.value = '';
            return;
          }

          const importedData = JSON.parse(decryptedStr);

          // è¼‰å…¥è³‡æ–™
          data.personnel = importedData.personnel;
          data.specialties = importedData.specialties || data.specialties;
          data.incidentTypes = importedData.incidentTypes || data.incidentTypes;

          // è¼‰å…¥è¿´æ­¸ç·šè¨­å®š
          if (importedData.vacationSettings) {
            localStorage.setItem('vacation_display_settings', JSON.stringify(importedData.vacationSettings));
          }

          // è¼‰å…¥å›æ­¸ç·šè³‡æ–™
          if (importedData.vacationTimeSlots || importedData.vacationTemplates) {
            const vacationData = JSON.parse(localStorage.getItem('return_v2_data') || '{}');
            if (importedData.vacationTimeSlots) vacationData.timeSlots = importedData.vacationTimeSlots;
            if (importedData.vacationTemplates) vacationData.templates = importedData.vacationTemplates;
            localStorage.setItem('return_v2_data', JSON.stringify(vacationData));
          }

          // è¼‰å…¥æ›´å¼¦æ˜“è½è³‡æ–™
          if (importedData.vehicles || importedData.dutyTypes || importedData.dutyTypeTemplates || importedData.specialDuties) {
            const serviceData = JSON.parse(localStorage.getItem('duty_pro_v2_data') || '{}');
            if (importedData.vehicles) serviceData.vehicles = importedData.vehicles;
            if (importedData.dutyTypes) serviceData.dutyTypes = importedData.dutyTypes;
            if (importedData.dutyTypeTemplates) serviceData.dutyTypeTemplates = importedData.dutyTypeTemplates;
            if (importedData.specialDuties) serviceData.specialDuties = importedData.specialDuties;
            localStorage.setItem('duty_pro_v2_data', JSON.stringify(serviceData));
          }

          // å„²å­˜åˆ°å¿«å–
          saveToCache();
          render();

          alert(`âœ… åŒ¯å…¥æˆåŠŸï¼\n\näººå“¡ï¼š${data.personnel.length} ä½\nå°ˆé•·ï¼š${data.specialties.length} ç¨®\näº‹æ•…é¡å‹ï¼š${data.incidentTypes.length} ç¨®\nè»Šè¼›ï¼š${importedData.vehicles?.length || 0} è¼›\n\nå·²è¼‰å…¥å®Œæ•´ç³»çµ±è¨­å®š`);
        } catch (err) {
          console.error(err);
          alert('âŒ å¯†ç¢¼éŒ¯èª¤æˆ–æª”æ¡ˆå·²æå£');
        }
      } else {
        // ä¸€èˆ¬æª”æ¡ˆ
        if (!json.personnel || !Array.isArray(json.personnel)) {
          throw new Error('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
        }

        // è¼‰å…¥è³‡æ–™
        data.personnel = json.personnel;
        data.specialties = json.specialties || data.specialties;
        data.incidentTypes = json.incidentTypes || data.incidentTypes;

        // è¼‰å…¥è¿´æ­¸ç·šè¨­å®š
        if (json.vacationSettings) {
          localStorage.setItem('vacation_display_settings', JSON.stringify(json.vacationSettings));
        }

        // è¼‰å…¥å›æ­¸ç·šè³‡æ–™
        if (json.vacationTimeSlots || json.vacationTemplates) {
          const vacationData = JSON.parse(localStorage.getItem('return_v2_data') || '{}');
          if (json.vacationTimeSlots) vacationData.timeSlots = json.vacationTimeSlots;
          if (json.vacationTemplates) vacationData.templates = json.vacationTemplates;
          localStorage.setItem('return_v2_data', JSON.stringify(vacationData));
        }

        // è¼‰å…¥æ›´å¼¦æ˜“è½è³‡æ–™
        if (json.vehicles || json.dutyTypes || json.dutyTypeTemplates || json.specialDuties) {
          const serviceData = JSON.parse(localStorage.getItem('duty_pro_v2_data') || '{}');
          if (json.vehicles) serviceData.vehicles = json.vehicles;
          if (json.dutyTypes) serviceData.dutyTypes = json.dutyTypes;
          if (json.dutyTypeTemplates) serviceData.dutyTypeTemplates = json.dutyTypeTemplates;
          if (json.specialDuties) serviceData.specialDuties = json.specialDuties;
          localStorage.setItem('duty_pro_v2_data', JSON.stringify(serviceData));
        }

        // å„²å­˜åˆ°å¿«å–
        saveToCache();
        render();

        alert(`âœ… åŒ¯å…¥æˆåŠŸï¼\n\näººå“¡ï¼š${data.personnel.length} ä½\nå°ˆé•·ï¼š${data.specialties.length} ç¨®\näº‹æ•…é¡å‹ï¼š${data.incidentTypes.length} ç¨®\nè»Šè¼›ï¼š${json.vehicles?.length || 0} è¼›\n\nå·²è¼‰å…¥å®Œæ•´ç³»çµ±è¨­å®š`);
      }
    } catch (error) {
      console.error('åŒ¯å…¥å¤±æ•—:', error);
      alert('âŒ åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤æˆ–æå£');
    }
  };

  reader.readAsText(file);
  event.target.value = '';
}

// æ¸²æŸ“å°ˆé•·
// å¾ service.html è‡ªå‹•åŒæ­¥å°ˆé•·
function syncSpecialtiesFromService() {
  const serviceData = localStorage.getItem('duty_pro_v2_data');
  const specialties = new Set();

  // å›ºå®šå°ˆé•·ï¼šè»Šè¼›è§’è‰²
  specialties.add('è»Šé•·');
  specialties.add('é§•é§›');

  if (serviceData) {
    try {
      const parsed = JSON.parse(serviceData);

      // å¾å‹¤å‹™é¡å‹æ”¶é›†
      if (parsed.dutyTypes && Array.isArray(parsed.dutyTypes)) {
        parsed.dutyTypes.forEach(type => specialties.add(type));
      }

      // å¾ç‰¹æ®Šè·å‹™æ”¶é›†
      if (parsed.specialDuties && Array.isArray(parsed.specialDuties)) {
        parsed.specialDuties.forEach(duty => {
          if (duty.name) specialties.add(duty.name);
        });
      }
    } catch (e) {
      console.warn('ç„¡æ³•è®€å– service.html è³‡æ–™ï¼Œä½¿ç”¨é è¨­å°ˆé•·');
    }
  }

  // è½‰ç‚ºæ’åºå¾Œçš„é™£åˆ—
  data.specialties = Array.from(specialties).sort();
  localStorage.setItem('specialties_cache', JSON.stringify(data.specialties));
}

function renderSpecialties() {
  const list = document.getElementById('specialtiesList');

  // å…ˆåŒæ­¥æœ€æ–°çš„å°ˆé•·ä¸¦å–å¾—åˆ†é¡è³‡æ–™
  const serviceData = localStorage.getItem('duty_pro_v2_data');
  const categories = {
    dutyTypes: [],
    specialDuties: [],
    vehicles: ['è»Šé•·', 'é§•é§›']
  };

  if (serviceData) {
    try {
      const parsed = JSON.parse(serviceData);
      if (parsed.dutyTypes && Array.isArray(parsed.dutyTypes)) {
        categories.dutyTypes = parsed.dutyTypes;
      }
      if (parsed.specialDuties && Array.isArray(parsed.specialDuties)) {
        categories.specialDuties = parsed.specialDuties.map(d => d.name);
      }
    } catch (e) {
      console.warn('ç„¡æ³•è®€å– service.html è³‡æ–™');
    }
  }

  // åŒæ­¥åˆ° data.specialties
  syncSpecialtiesFromService();

  if (data.specialties.length === 0) {
    list.innerHTML = '<div style="color: #999;">å°šç„¡å°ˆé•·ï¼ˆè«‹å…ˆåœ¨ã€Œæ›´å¼¦æ˜“è½ã€ç³»çµ±è¨­å®šè·å‹™ï¼‰</div>';
    return;
  }

  // ä¸‰é¡å¡ç‰‡ UI
  const html = `
    <!-- è¼ªå€¼å‹¤å‹™å°ˆé•· -->
    <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
      <div style="font-size: 15px; font-weight: 700; color: #1976d2; margin-bottom: 12px;">ğŸ“‹ è¼ªå€¼å‹¤å‹™å°ˆé•·</div>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${categories.dutyTypes.length > 0
          ? categories.dutyTypes.map(specialty => `
              <div class="tag-item">
                <span class="tag-name">${specialty}</span>
              </div>
            `).join('')
          : '<div style="color: #999; font-size: 13px;">å°šç„¡è¼ªå€¼å‹¤å‹™</div>'
        }
      </div>
    </div>

    <!-- ç‰¹æ®Šè·å‹™å°ˆé•· -->
    <div style="background: #fce4ec; border: 2px solid #f06292; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
      <div style="font-size: 15px; font-weight: 700; color: #c2185b; margin-bottom: 12px;">â­ ç‰¹æ®Šè·å‹™å°ˆé•·</div>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${categories.specialDuties.length > 0
          ? categories.specialDuties.map(specialty => `
              <div class="tag-item">
                <span class="tag-name">${specialty}</span>
              </div>
            `).join('')
          : '<div style="color: #999; font-size: 13px;">å°šç„¡ç‰¹æ®Šè·å‹™</div>'
        }
      </div>
    </div>

    <!-- è»Šè¼›è§’è‰²å°ˆé•· -->
    <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 12px; padding: 16px;">
      <div style="font-size: 15px; font-weight: 700; color: #f57c00; margin-bottom: 12px;">ğŸš— è»Šè¼›è§’è‰²å°ˆé•·</div>
      <div style="display: flex; flex-wrap: wrap; gap: 8px;">
        ${categories.vehicles.map(specialty => `
          <div class="tag-item">
            <span class="tag-name">${specialty}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  list.innerHTML = html;
}

// ç·¨è¼¯äººå“¡é©ç”¨ç³»çµ±
function editPersonSystems(index) {
  const person = data.personnel[index];
  if (!person.systems) person.systems = [];

  const systems = [
    { id: 'service', name: 'æ›´å¼¦æ˜“è½ï¼ˆå‹¤å‹™æ’ç­ï¼‰' },
    { id: 'task', name: 'ç«¹æ—è¨ˆç•«' },
    { id: 'vacation', name: 'è¿´æ­¸ç·šï¼ˆæ”¶å‡é»é¸ï¼‰' }
  ];

  const checkboxHtml = systems.map(sys => {
    const checked = person.systems.includes(sys.id);
    return `
      <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #e3f2fd; border-radius: 8px; cursor: pointer;">
        <input type="checkbox" value="${sys.id}" ${checked ? 'checked' : ''} style="width: 18px; height: 18px;">
        <span style="flex: 1; font-weight: 600;">${sys.name}</span>
      </label>
    `;
  }).join('');

  const modalHtml = `
    <div style="max-height: 400px; overflow-y: auto;">
      <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
        ${checkboxHtml}
      </div>
      <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
        <div style="font-size: 13px; color: #856404;">ğŸ’¡ æç¤ºï¼šå‹¾é¸å¾Œï¼Œè©²äººå“¡æ‰æœƒåœ¨å°æ‡‰ç³»çµ±ä¸­é¡¯ç¤º</div>
      </div>
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="savePersonSystems(${index})">âœ… ç¢ºèª</button>
  `;

  showModal(`è¨­å®šé©ç”¨ç³»çµ± - ${person.name}`, modalHtml);
}

// å„²å­˜äººå“¡é©ç”¨ç³»çµ±
function savePersonSystems(index) {
  const checkboxes = document.querySelectorAll('#modalContent input[type="checkbox"]');
  const selectedSystems = Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  data.personnel[index].systems = selectedSystems;
  saveToCache();
  render();
  closeModal();
}

// ç·¨è¼¯äººå“¡å°ˆé•·
function editPersonSpecialties(index) {
  const person = data.personnel[index];
  if (!person.specialties) person.specialties = [];

  const checkboxHtml = data.specialties.map(specialty => {
    const checked = person.specialties.includes(specialty);
    return `
      <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f3e5f5; border-radius: 8px; cursor: pointer;">
        <input type="checkbox" value="${specialty}" ${checked ? 'checked' : ''} style="width: 18px; height: 18px;">
        <span style="flex: 1; font-weight: 600;">${specialty}</span>
      </label>
    `;
  }).join('');

  const modalHtml = `
    <div style="max-height: 400px; overflow-y: auto;">
      <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
        ${checkboxHtml || '<div style="color: #999; text-align: center; padding: 20px;">å°šç„¡å¯é¸å°ˆé•·<br><small>è«‹å…ˆåœ¨ã€Œå°ˆé•·ç®¡ç†ã€æ–°å¢å°ˆé•·é¡å‹</small></div>'}
      </div>
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="savePersonSpecialties(${index})">âœ… ç¢ºèª</button>
  `;

  showModal(`ç·¨è¼¯å°ˆé•· - ${person.name}`, modalHtml);
}

// å„²å­˜äººå“¡å°ˆé•·
function savePersonSpecialties(index) {
  const checkboxes = document.querySelectorAll('#modalContent input[type="checkbox"]');
  const selectedSpecialties = Array.from(checkboxes)
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  data.personnel[index].specialties = selectedSpecialties;
  saveToCache();
  render();
  closeModal();
}

// é¡¯ç¤ºæ¨¡æ…‹æ¡†
function showModal(title, content) {
  const modal = document.createElement('div');
  modal.id = 'tempModal';
  modal.style.cssText = `
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(94, 53, 177, 0.7); z-index: 2000;
    display: flex; align-items: center; justify-content: center; padding: 20px;
  `;

  modal.innerHTML = `
    <div style="background: white; border-radius: 20px; padding: 24px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
      <div style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #8d6e63;">${title}</div>
      <div id="modalContent">${content}</div>
    </div>
  `;

  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  document.body.appendChild(modal);
}

// é—œé–‰æ¨¡æ…‹æ¡†
function closeModal() {
  const modal = document.getElementById('tempModal');
  if (modal) modal.remove();
}

// ç·¨è¼¯äººå“¡ä¼‘å‡æœŸé–“
function editPersonVacation(index) {
  const person = data.personnel[index];

  const modalHtml = `
    <div style="margin-bottom: 16px;">
      <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
        <div style="font-size: 13px; color: #856404;">ğŸ’¡ æç¤ºï¼šè¨­å®šä¼‘å‡æœŸé–“å¾Œï¼Œè©²äººå“¡åœ¨ä¼‘å‡æœŸé–“å…§ä¸æœƒå‡ºç¾åœ¨ä»»å‹™é¸æ“‡æ¸…å–®ä¸­</div>
      </div>

      <div style="margin-bottom: 12px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #8d6e63;">ä¼‘å‡é–‹å§‹æ—¥æœŸï¼ˆæ ¼å¼ï¼šMM/DDï¼‰</label>
        <input type="text" class="input-text" id="vacationStart" placeholder="ä¾‹å¦‚ï¼š10/01" value="${person.vacationStart || ''}" maxlength="5">
      </div>

      <div style="margin-bottom: 12px;">
        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #8d6e63;">ä¼‘å‡çµæŸæ—¥æœŸï¼ˆæ ¼å¼ï¼šMM/DDï¼‰</label>
        <input type="text" class="input-text" id="vacationEnd" placeholder="ä¾‹å¦‚ï¼š10/15" value="${person.vacationEnd || ''}" maxlength="5">
      </div>

      <div style="font-size: 12px; color: #999; margin-top: 8px;">
        â„¹ï¸ ç•™ç©ºå…©å€‹æ¬„ä½å³å¯æ¸…é™¤ä¼‘å‡æœŸé–“
      </div>
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="savePersonVacation(${index})">âœ… ç¢ºèª</button>
  `;

  showModal(`è¨­å®šä¼‘å‡æœŸé–“ - ${person.name}`, modalHtml);
}

// å„²å­˜äººå“¡ä¼‘å‡æœŸé–“
function savePersonVacation(index) {
  const start = document.getElementById('vacationStart').value.trim();
  const end = document.getElementById('vacationEnd').value.trim();

  // é©—è­‰æ—¥æœŸæ ¼å¼ï¼ˆç°¡å–®é©—è­‰ï¼‰
  const datePattern = /^\d{1,2}\/\d{1,2}$/;
  if (start && !datePattern.test(start)) {
    alert('é–‹å§‹æ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ MM/DD æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š10/01ï¼‰');
    return;
  }
  if (end && !datePattern.test(end)) {
    alert('çµæŸæ—¥æœŸæ ¼å¼éŒ¯èª¤ï¼Œè«‹ä½¿ç”¨ MM/DD æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š10/15ï¼‰');
    return;
  }

  // å¦‚æœå…©å€‹éƒ½å¡«äº†ï¼Œæˆ–å…©å€‹éƒ½æ²’å¡«ï¼Œæ‰å„²å­˜
  if ((start && end) || (!start && !end)) {
    data.personnel[index].vacationStart = start || null;
    data.personnel[index].vacationEnd = end || null;
    saveToCache();
    render();
    closeModal();
  } else {
    alert('è«‹åŒæ™‚å¡«å¯«é–‹å§‹å’ŒçµæŸæ—¥æœŸï¼Œæˆ–å…©å€‹éƒ½ç•™ç©º');
  }
}

// åˆ‡æ› Tab
function switchTab(index) {
  console.log('ğŸ”„ åˆ‡æ›åˆ° Tab', index);

  // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  // éš±è—æ‰€æœ‰ tab-content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });

  // å•Ÿç”¨æŒ‡å®šçš„æŒ‰éˆ•
  const buttons = document.querySelectorAll('.tab-btn');
  if (buttons[index]) {
    buttons[index].classList.add('active');
  }

  // é¡¯ç¤ºæŒ‡å®šçš„ tab-content
  const tab = document.getElementById(`tab${index}`);
  if (tab) {
    tab.classList.add('active');
    console.log('âœ… é¡¯ç¤º tab' + index);
  } else {
    console.error('âŒ æ‰¾ä¸åˆ° tab' + index);
  }

  // å¦‚æœåˆ‡æ›åˆ°äººå“¡ç¸½è¦½ï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼
  if (index === 0) {
    renderOverviewTable();
  }
}

// ========================================
// ========================================
// å¯†ç¢¼ç®¡ç†åŠŸèƒ½
// ========================================

// è¼‰å…¥å¯†ç¢¼è¨­å®šç‹€æ…‹
function loadPasswordSettings() {
  // å¾ index.html è®€å–é…ç½®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
  // é€™è£¡é¡¯ç¤ºé è¨­å€¼ï¼Œå¯¦éš›å€¼åœ¨ index.html ä¸­
  document.getElementById('passwordExpiryDays').textContent = '30 å¤©';
  document.getElementById('passwordMaxAttempts').textContent = '5 æ¬¡';
  document.getElementById('passwordLockoutTime').textContent = '15 åˆ†é˜';

  const initTime = localStorage.getItem('init_time');
  if (initTime) {
    const date = new Date(initTime);
    document.getElementById('passwordLastUpdate').textContent =
      `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
  } else {
    document.getElementById('passwordLastUpdate').textContent = 'æœªè¨­å®š';
  }
}

// æ›´æ”¹ç³»çµ±å¯†ç¢¼
function changeSystemPassword() {
  const currentPwd = document.getElementById('currentPassword').value;
  const newPwd = document.getElementById('newPassword').value;
  const confirmPwd = document.getElementById('confirmPassword').value;

  // é©—è­‰è¼¸å…¥
  if (!currentPwd || !newPwd || !confirmPwd) {
    alert('âŒ è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
    return;
  }

  if (newPwd.length < 4) {
    alert('âŒ æ–°å¯†ç¢¼è‡³å°‘éœ€è¦ 4 å€‹å­—å…ƒ');
    return;
  }

  if (newPwd !== confirmPwd) {
    alert('âŒ å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´');
    return;
  }

  // é©—è­‰ç•¶å‰å¯†ç¢¼
  const SALT = 'qian_chou_lue_shi_2024';
  const currentHash = CryptoJS.SHA256(currentPwd + SALT).toString();

  // å¾ localStorage è®€å–æˆ–ä½¿ç”¨é è¨­é›œæ¹Š
  const storedHash = localStorage.getItem('system_password_hash') ||
                     '03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4'; // é è¨­ 1234

  if (currentHash !== storedHash) {
    alert('âŒ ç•¶å‰å¯†ç¢¼éŒ¯èª¤');
    return;
  }

  // ç”Ÿæˆæ–°å¯†ç¢¼çš„é›œæ¹Šå€¼
  const newHash = CryptoJS.SHA256(newPwd + SALT).toString();

  // é¡¯ç¤ºæç¤º
  const confirmChange = confirm(
    `ğŸ” ç¢ºå®šè¦æ›´æ”¹ç³»çµ±å¯†ç¢¼å—ï¼Ÿ\n\n` +
    `æ–°å¯†ç¢¼é›œæ¹Šå€¼ï¼š\n${newHash}\n\n` +
    `âš ï¸ è«‹å°‡æ­¤é›œæ¹Šå€¼è¤‡è£½åˆ° index.html çš„ PASSWORD_HASH\n` +
    `å¦å‰‡ä¸‹æ¬¡ç„¡æ³•ç™»å…¥ç³»çµ±ï¼\n\n` +
    `æ˜¯å¦ç¹¼çºŒï¼Ÿ`
  );

  if (!confirmChange) return;

  // å„²å­˜åˆ° localStorageï¼ˆè‡¨æ™‚æ–¹æ¡ˆï¼‰
  localStorage.setItem('system_password_hash', newHash);
  localStorage.setItem('init_time', new Date().toISOString());

  // æ¸…ç©ºè¡¨å–®
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';

  // é¡¯ç¤ºæˆåŠŸè¨Šæ¯å’Œé›œæ¹Šå€¼
  alert(
    `âœ… å¯†ç¢¼å·²æ›´æ–°ï¼\n\n` +
    `è«‹ç«‹å³åŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š\n\n` +
    `1. æ‰“é–‹ index.html æ–‡ä»¶\n` +
    `2. æ‰¾åˆ° PASSWORD_HASH æ¬„ä½\n` +
    `3. å°‡ä¸‹æ–¹é›œæ¹Šå€¼è²¼ä¸Šï¼š\n\n` +
    `${newHash}\n\n` +
    `4. å„²å­˜æ–‡ä»¶\n\n` +
    `âš ï¸ è«‹å‹™å¿…å®Œæˆæ­¤æ­¥é©Ÿï¼Œå¦å‰‡ä¸‹æ¬¡ç„¡æ³•ç™»å…¥ï¼`
  );

  // è¤‡è£½åˆ°å‰ªè²¼ç°¿
  if (navigator.clipboard) {
    navigator.clipboard.writeText(newHash).then(() => {
      console.log('âœ… é›œæ¹Šå€¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
    });
  }

  loadPasswordSettings();
}

// ç”Ÿæˆé›œæ¹Šå€¼å·¥å…·
function generateHash() {
  const input = document.getElementById('hashGenInput').value;
  if (!input) {
    alert('è«‹è¼¸å…¥å¯†ç¢¼');
    return;
  }

  const SALT = 'qian_chou_lue_shi_2024';
  const hash = CryptoJS.SHA256(input + SALT).toString();

  const output = document.getElementById('hashOutput');
  output.style.display = 'block';
  output.innerHTML = `
    <div style="margin-bottom: 8px; font-weight: 600; color: #8d6e63;">SHA-256 é›œæ¹Šå€¼ï¼š</div>
    <div style="background: #f5f5f5; padding: 8px; border-radius: 4px; margin-bottom: 8px;">${hash}</div>
    <button onclick="navigator.clipboard.writeText('${hash}').then(() => alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿'))"
            style="padding: 6px 12px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
      ğŸ“‹ è¤‡è£½é›œæ¹Šå€¼
    </button>
  `;
}

// æ‰“é–‹å¯†ç¢¼èªªæ˜æ–‡ä»¶
function openPasswordDoc() {
  const hasDoc = confirm(
    'ğŸ“– å¯†ç¢¼è¨­å®šèªªæ˜æ–‡ä»¶\n\n' +
    'æ–‡ä»¶è·¯å¾‘ï¼šå¯†ç¢¼è¨­å®šèªªæ˜.md\n\n' +
    'æ˜¯å¦è¦åœ¨æ–°è¦–çª—é–‹å•Ÿï¼Ÿ\n' +
    'ï¼ˆå¦‚æœæ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œè«‹ç¢ºèªæ–‡ä»¶æ˜¯å¦å­˜åœ¨æ–¼å°ˆæ¡ˆç›®éŒ„ä¸­ï¼‰'
  );

  if (hasDoc) {
    window.open('å¯†ç¢¼è¨­å®šèªªæ˜.md', '_blank');
  }
}

// ========================================
// äººå“¡åŸºæœ¬è³‡æ–™ç·¨è¼¯ï¼ˆåŒ…å«æš±ç¨±å’Œé¡¯ç¤ºåå¥½ï¼‰
// ========================================
function editPersonBasicInfo(index) {
  const person = data.personnel[index];

  const modalHtml = `
    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">
        éšç´š + å§“å <span style="color: #f44336;">*</span>
      </label>
      <input type="text" class="input-text" id="editPersonName" value="${person.name}" style="width: 100%;">
    </div>

    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px;">
        æš±ç¨± / ç°¡ç¨±
      </label>
      <input type="text" class="input-text" id="editPersonNickname" value="${person.nickname || ''}" placeholder="ä¾‹å¦‚ï¼šæ¸™è™”" style="width: 100%;">
      <div style="font-size: 11px; color: #999; margin-top: 4px;">ğŸ’¡ é¸å¡«ï¼Œéƒ¨åˆ†ç³»çµ±æœƒé¡¯ç¤ºæš±ç¨±</div>
    </div>

    <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
      <div style="font-size: 14px; font-weight: 600; color: #1976d2; margin-bottom: 12px;">ğŸ“± å„ç³»çµ±é¡¯ç¤ºåå¥½</div>
      <div style="font-size: 12px; color: #666; margin-bottom: 12px;">é¸æ“‡æ­¤äººå“¡åœ¨å„ç³»çµ±ä¸­è¦é¡¯ç¤ºå…¨åé‚„æ˜¯æš±ç¨±</div>

      <div style="display: flex; flex-direction: column; gap: 10px;">
        <div style="background: white; padding: 10px; border-radius: 8px;">
          <div style="font-size: 13px; font-weight: 600; color: #1976d2; margin-bottom: 6px;">ğŸ“‹ æ›´å¼¦æ˜“è½ï¼ˆå€¼ç­ç³»çµ±ï¼‰</div>
          <label style="display: inline-flex; align-items: center; gap: 6px; margin-right: 16px; cursor: pointer;">
            <input type="radio" name="displayService" value="fullname" ${!person.displayPreference || person.displayPreference.service !== 'nickname' ? 'checked' : ''}>
            <span style="font-size: 13px;">é¡¯ç¤ºå…¨å</span>
          </label>
          <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="displayService" value="nickname" ${person.displayPreference?.service === 'nickname' ? 'checked' : ''} ${!person.nickname ? 'disabled' : ''}>
            <span style="font-size: 13px; ${!person.nickname ? 'color: #ccc;' : ''}">é¡¯ç¤ºæš±ç¨±${!person.nickname ? ' (æœªè¨­å®š)' : ''}</span>
          </label>
        </div>

        <div style="background: white; padding: 10px; border-radius: 8px;">
          <div style="font-size: 13px; font-weight: 600; color: #2e7d32; margin-bottom: 6px;">ğŸ‹ ç«¹æ—è¨ˆç•«ï¼ˆä»»å‹™ç³»çµ±ï¼‰</div>
          <label style="display: inline-flex; align-items: center; gap: 6px; margin-right: 16px; cursor: pointer;">
            <input type="radio" name="displayTask" value="fullname" ${!person.displayPreference || person.displayPreference.task !== 'nickname' ? 'checked' : ''}>
            <span style="font-size: 13px;">é¡¯ç¤ºå…¨å</span>
          </label>
          <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="displayTask" value="nickname" ${person.displayPreference?.task === 'nickname' ? 'checked' : ''} ${!person.nickname ? 'disabled' : ''}>
            <span style="font-size: 13px; ${!person.nickname ? 'color: #ccc;' : ''}">é¡¯ç¤ºæš±ç¨±${!person.nickname ? ' (æœªè¨­å®š)' : ''}</span>
          </label>
        </div>

        <div style="background: white; padding: 10px; border-radius: 8px;">
          <div style="font-size: 13px; font-weight: 600; color: #8d6e63; margin-bottom: 6px;">â° è¿´æ­¸ç·šï¼ˆæ”¶å‡ç³»çµ±ï¼‰</div>
          <label style="display: inline-flex; align-items: center; gap: 6px; margin-right: 16px; cursor: pointer;">
            <input type="radio" name="displayVacation" value="fullname" ${!person.displayPreference || person.displayPreference.vacation !== 'nickname' ? 'checked' : ''}>
            <span style="font-size: 13px;">é¡¯ç¤ºå…¨å</span>
          </label>
          <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="displayVacation" value="nickname" ${person.displayPreference?.vacation === 'nickname' ? 'checked' : ''} ${!person.nickname ? 'disabled' : ''}>
            <span style="font-size: 13px; ${!person.nickname ? 'color: #ccc;' : ''}">é¡¯ç¤ºæš±ç¨±${!person.nickname ? ' (æœªè¨­å®š)' : ''}</span>
          </label>
        </div>
      </div>
    </div>

    <button class="btn-primary" style="width: 100%;" onclick="savePersonBasicInfo(${index})">âœ… å„²å­˜è®Šæ›´</button>
  `;

  showModal(`ç·¨è¼¯äººå“¡è³‡æ–™ - ${person.name}`, modalHtml);
}

// å„²å­˜äººå“¡åŸºæœ¬è³‡æ–™
function savePersonBasicInfo(index) {
  const person = data.personnel[index];
  const newName = document.getElementById('editPersonName').value.trim();
  const newNickname = document.getElementById('editPersonNickname').value.trim();

  if (!newName) {
    alert('å§“åä¸èƒ½ç‚ºç©ºï¼');
    return;
  }

  // æª¢æŸ¥å§“åæ˜¯å¦é‡è¤‡ï¼ˆæ’é™¤è‡ªå·±ï¼‰
  if (data.personnel.find((p, i) => p.name === newName && i !== index)) {
    alert('æ­¤å§“åå·²å­˜åœ¨ï¼');
    return;
  }

  // æ›´æ–°åŸºæœ¬è³‡æ–™
  person.name = newName;
  person.nickname = newNickname || null;

  // æ›´æ–°é¡¯ç¤ºåå¥½
  if (!person.displayPreference) {
    person.displayPreference = {};
  }

  const serviceDisplay = document.querySelector('input[name="displayService"]:checked').value;
  const taskDisplay = document.querySelector('input[name="displayTask"]:checked').value;
  const vacationDisplay = document.querySelector('input[name="displayVacation"]:checked').value;

  person.displayPreference.service = serviceDisplay;
  person.displayPreference.task = taskDisplay;
  person.displayPreference.vacation = vacationDisplay;

  saveToCache();
  render();
  closeModal();
  alert(`âœ… å·²æ›´æ–°äººå“¡è³‡æ–™: ${newName}${newNickname ? ' (' + newNickname + ')' : ''}`);
}

// ========================================
// å·¥å…·å‡½æ•¸ï¼šå–å¾—äººå“¡é¡¯ç¤ºåç¨±
// ========================================
// æ­¤å‡½æ•¸å¯è¢«å…¶ä»–ç³»çµ±å‘¼å«ä»¥å–å¾—æ­£ç¢ºçš„é¡¯ç¤ºåç¨±
function getPersonDisplayName(person, systemName) {
  // systemName: 'service', 'task', 'vacation'
  if (!person) return '';

  // å¦‚æœæ²’æœ‰è¨­å®šé¡¯ç¤ºåå¥½ï¼Œé è¨­é¡¯ç¤ºå…¨å
  if (!person.displayPreference || !person.displayPreference[systemName]) {
    return person.name;
  }

  // å¦‚æœè¨­å®šç‚ºé¡¯ç¤ºæš±ç¨±ï¼Œä½†æš±ç¨±ç‚ºç©ºï¼Œå‰‡é¡¯ç¤ºå…¨å
  if (person.displayPreference[systemName] === 'nickname') {
    return person.nickname || person.name;
  }

  // é è¨­é¡¯ç¤ºå…¨å
  return person.name;
}

// ========================================
// è¿´æ­¸ç·šé¡¯ç¤ºè¨­å®š
// ========================================

// è¼‰å…¥è¿´æ­¸ç·šé¡¯ç¤ºè¨­å®š
function loadVacationDisplaySettings() {
  const settings = JSON.parse(localStorage.getItem('vacation_display_settings') || '{"checkin":"fullname","incident":"fullname"}');

  const checkinRadios = document.getElementsByName('vacationCheckin');
  const incidentRadios = document.getElementsByName('vacationIncident');

  checkinRadios.forEach(radio => {
    if (radio.value === settings.checkin) radio.checked = true;
  });

  incidentRadios.forEach(radio => {
    if (radio.value === settings.incident) radio.checked = true;
  });
}

// å„²å­˜è¿´æ­¸ç·šé¡¯ç¤ºè¨­å®š
function saveVacationDisplaySettings() {
  const checkinValue = document.querySelector('input[name="vacationCheckin"]:checked').value;
  const incidentValue = document.querySelector('input[name="vacationIncident"]:checked').value;

  const settings = {
    checkin: checkinValue,
    incident: incidentValue
  };

  localStorage.setItem('vacation_display_settings', JSON.stringify(settings));
  alert('âœ… è¿´æ­¸ç·šé¡¯ç¤ºè¨­å®šå·²å„²å­˜ï¼\n\næ¯æ—¥æ”¶å‡: ' + (checkinValue === 'fullname' ? 'é¡¯ç¤ºå…¨å' : 'é¡¯ç¤ºæš±ç¨±') + '\näº‹æ•…å›å ±: ' + (incidentValue === 'fullname' ? 'é¡¯ç¤ºå…¨å' : 'é¡¯ç¤ºæš±ç¨±'));
}

// ========================================
// äººå“¡ç¸½è¦½è¡¨æ ¼
// ========================================

let overviewFilteredData = [];

// æ¸²æŸ“äººå“¡ç¸½è¦½è¡¨æ ¼
function renderOverviewTable() {
  const tbody = document.getElementById('overviewTableBody');
  if (!tbody) return;

  overviewFilteredData = [...data.personnel];

  const systemIcons = { service: 'ğŸ“‹', task: 'ğŸ‹', vacation: 'â°' };
  const systemNames = { service: 'æ›´å¼¦æ˜“è½', task: 'ç«¹æ—è¨ˆç•«', vacation: 'è¿´æ­¸ç·š' };

  const html = overviewFilteredData.map((person, index) => {
    const realIndex = data.personnel.indexOf(person);

    // å§“åæ¬„ï¼ˆåˆä½µå…¨åå’Œæš±ç¨±ï¼‰
    const nameHtml = person.nickname
      ? `<div style="font-weight: 600;">${person.name}</div><div style="font-size: 11px; color: #999;">(${person.nickname})</div>`
      : `<div style="font-weight: 600;">${person.name}</div>`;

    // ç³»çµ±èˆ‡é¡¯ç¤ºè¨­å®šï¼ˆåˆä½µæ¬„ä½ï¼Œå‚ç›´é¡¯ç¤ºï¼‰
    const dispPref = person.displayPreference || {};
    const systemDisplayHtml = (person.systems || []).map(sys => {
      const icon = systemIcons[sys];
      const name = systemNames[sys];

      // vacation ç³»çµ±ä¸é¡¯ç¤ºå€‹äººåå¥½ç¬¦è™Ÿï¼ˆä½¿ç”¨çµ±ä¸€è¨­å®šï¼‰
      if (sys === 'vacation') {
        return `<div title="${name}ï¼ˆä½¿ç”¨çµ±ä¸€è¨­å®šï¼‰">${icon} ${name}</div>`;
      }

      // service å’Œ task é¡¯ç¤ºå€‹äººåå¥½ç¬¦è™Ÿ
      const pref = dispPref[sys];
      const symbol = pref === 'nickname' ? 'â­' : 'âšª';
      const tip = pref === 'nickname' ? 'é¡¯ç¤ºæš±ç¨±' : 'é¡¯ç¤ºå…¨å';
      return `<div title="${name}: ${tip}">${icon} ${name} ${symbol}</div>`;
    }).join('');

    return `
      <tr draggable="true" data-index="${realIndex}" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondrop="handleDrop(event)" ondragend="handleDragEnd(event)" style="border-bottom: 1px solid #e0e0e0; cursor: move;">
        <td style="padding: 12px; text-align: center; cursor: grab;">
          <span style="font-size: 18px; color: #999;">â‹®â‹®</span>
        </td>
        <td style="padding: 12px; text-align: center;">
          <input type="checkbox" class="person-checkbox" data-index="${realIndex}" style="width: 18px; height: 18px; display: none;">
        </td>
        <td style="padding: 12px;">${nameHtml}</td>
        <td style="padding: 12px; font-size: 12px;">${(person.specialties || []).join(', ') || '-'}</td>
        <td style="padding: 10px 12px; font-size: 12px; line-height: 1.8;">${systemDisplayHtml || '-'}</td>
        <td style="padding: 12px; text-align: center; font-size: 12px;">
          ${person.vacationStart && person.vacationEnd ? `${person.vacationStart}~${person.vacationEnd}` : '-'}
        </td>
        <td style="padding: 12px; text-align: center;">
          <button class="btn-primary" onclick="editPersonBasicInfo(${realIndex})" style="padding: 6px 12px; font-size: 12px;">ç·¨è¼¯</button>
        </td>
      </tr>
    `;
  }).join('');

  tbody.innerHTML = html || '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #999;">å°šç„¡äººå“¡è³‡æ–™</td></tr>';

  // ç”Ÿæˆå¡ç‰‡å¼å¸ƒå±€ (æ‰‹æ©Ÿç‰ˆ)
  const cardContainer = document.getElementById('overviewCardContainer');
  if (cardContainer) {
    const cardHtml = overviewFilteredData.map((person, index) => {
      const realIndex = data.personnel.indexOf(person);
      const dispPref = person.displayPreference || {};

      // ç³»çµ±èˆ‡é¡¯ç¤º
      const systemDisplayHtml = (person.systems || []).map(sys => {
        const icon = systemIcons[sys];
        const name = systemNames[sys];
        if (sys === 'vacation') {
          return `${icon} ${name}`;
        }
        const pref = dispPref[sys];
        const symbol = pref === 'nickname' ? 'â­' : 'âšª';
        return `${icon} ${name} ${symbol}`;
      }).join(', ') || '-';

      return `
        <div class="overview-card">
          <div class="overview-card-header">
            <div>
              <span class="overview-card-name">${person.name}</span>
              ${person.nickname ? `<span class="overview-card-rank">(${person.nickname})</span>` : ''}
            </div>
            <button class="btn-primary" onclick="editPersonBasicInfo(${realIndex})" style="padding: 6px 12px; font-size: 12px;">âœï¸ ç·¨è¼¯</button>
          </div>
          <div class="overview-card-row">
            <div class="overview-card-label">ğŸ–ï¸ å°ˆé•·:</div>
            <div class="overview-card-value">${(person.specialties || []).join(', ') || '-'}</div>
          </div>
          <div class="overview-card-row">
            <div class="overview-card-label">ğŸ“± ç³»çµ±:</div>
            <div class="overview-card-value">${systemDisplayHtml}</div>
          </div>
          <div class="overview-card-row">
            <div class="overview-card-label">ğŸ–ï¸ ä¼‘å‡:</div>
            <div class="overview-card-value">${person.vacationStart && person.vacationEnd ? `${person.vacationStart}~${person.vacationEnd}` : '-'}</div>
          </div>
        </div>
      `;
    }).join('');

    cardContainer.innerHTML = cardHtml || '<div style="padding: 40px; text-align: center; color: #999;">å°šç„¡äººå“¡è³‡æ–™</div>';
  }

  // æ›´æ–°çµ±è¨ˆ
  document.getElementById('totalCount').textContent = data.personnel.length;
  document.getElementById('selectedCount').textContent = '0';
}

// ç¯©é¸ç¸½è¦½è¡¨æ ¼
function filterOverviewTable() {
  const searchText = document.getElementById('overviewSearch').value.toLowerCase();

  if (!searchText) {
    overviewFilteredData = [...data.personnel];
  } else {
    overviewFilteredData = data.personnel.filter(p =>
      p.name.toLowerCase().includes(searchText) ||
      (p.nickname && p.nickname.toLowerCase().includes(searchText))
    );
  }

  renderOverviewTable();
}

// åˆ‡æ›æ‰¹æ¬¡æ¨¡å¼
function toggleBatchMode() {
  const batchMode = document.getElementById('batchMode').checked;
  const checkboxes = document.querySelectorAll('.person-checkbox');
  const selectAll = document.getElementById('selectAll');
  const batchActions = document.getElementById('batchActions');

  checkboxes.forEach(cb => {
    cb.style.display = batchMode ? 'inline-block' : 'none';
  });

  selectAll.style.display = batchMode ? 'inline-block' : 'none';
  batchActions.style.display = batchMode ? 'flex' : 'none';

  if (!batchMode) {
    selectAll.checked = false;
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedCount();
  }
}

// å…¨é¸/å–æ¶ˆå…¨é¸
function toggleSelectAll() {
  const selectAll = document.getElementById('selectAll').checked;
  const checkboxes = document.querySelectorAll('.person-checkbox');

  checkboxes.forEach(cb => cb.checked = selectAll);
  updateSelectedCount();
}

// æ›´æ–°é¸ä¸­äººæ•¸
function updateSelectedCount() {
  const selectedCount = document.querySelectorAll('.person-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = selectedCount;
}

// ç›£è½è¤‡é¸æ¡†è®ŠåŒ–
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('person-checkbox')) {
    updateSelectedCount();
  }
});

// æ‰¹æ¬¡è¨­å®šç³»çµ±
function batchSetSystems() {
  const selectedCheckboxes = Array.from(document.querySelectorAll('.person-checkbox:checked'));

  if (selectedCheckboxes.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½äººå“¡');
    return;
  }

  const modalHtml = `
    <div style="margin-bottom: 16px;">
      <div style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 12px;">é¸æ“‡è¦å¥—ç”¨çš„ç³»çµ±ï¼š</div>
      <label style="display: flex; align-items: center; gap: 6px; padding: 8px; margin-bottom: 8px; cursor: pointer;">
        <input type="checkbox" id="batchService" checked style="width: 18px; height: 18px;">
        <span>ğŸ“‹ æ›´å¼¦æ˜“è½</span>
      </label>
      <label style="display: flex; align-items: center; gap: 6px; padding: 8px; margin-bottom: 8px; cursor: pointer;">
        <input type="checkbox" id="batchTask" checked style="width: 18px; height: 18px;">
        <span>ğŸ‹ ç«¹æ—è¨ˆç•«</span>
      </label>
      <label style="display: flex; align-items: center; gap: 6px; padding: 8px; margin-bottom: 8px; cursor: pointer;">
        <input type="checkbox" id="batchVacation" checked style="width: 18px; height: 18px;">
        <span>â° è¿´æ­¸ç·š</span>
      </label>
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="applyBatchSystems()">âœ… å¥—ç”¨åˆ° ${selectedCheckboxes.length} ä½äººå“¡</button>
  `;

  showModal('æ‰¹æ¬¡è¨­å®šé©ç”¨ç³»çµ±', modalHtml);
}

// å¥—ç”¨æ‰¹æ¬¡ç³»çµ±è¨­å®š
function applyBatchSystems() {
  const selectedCheckboxes = Array.from(document.querySelectorAll('.person-checkbox:checked'));
  const systems = [];

  if (document.getElementById('batchService').checked) systems.push('service');
  if (document.getElementById('batchTask').checked) systems.push('task');
  if (document.getElementById('batchVacation').checked) systems.push('vacation');

  if (systems.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç³»çµ±');
    return;
  }

  selectedCheckboxes.forEach(cb => {
    const index = parseInt(cb.dataset.index);
    data.personnel[index].systems = systems;
  });

  saveToCache();
  render();
  closeModal();

  // è‡ªå‹•é—œé–‰æ‰¹æ¬¡æ¨¡å¼ä¸¦æ¸…é™¤å‹¾é¸
  const batchModeCheckbox = document.getElementById('batchMode');
  if (batchModeCheckbox) {
    batchModeCheckbox.checked = false;
    toggleBatchMode();
  }

  alert(`âœ… å·²ç‚º ${selectedCheckboxes.length} ä½äººå“¡è¨­å®šç³»çµ±`);
}

// æ‰¹æ¬¡è¨­å®šå°ˆé•·
function batchSetSpecialties() {
  const selectedCheckboxes = Array.from(document.querySelectorAll('.person-checkbox:checked'));

  if (selectedCheckboxes.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½äººå“¡');
    return;
  }

  const checkboxHtml = data.specialties.map(specialty => `
    <label style="display: flex; align-items: center; gap: 6px; padding: 8px; background: #f3e5f5; border-radius: 8px; cursor: pointer; margin-bottom: 8px;">
      <input type="checkbox" value="${specialty}" style="width: 18px; height: 18px;">
      <span>${specialty}</span>
    </label>
  `).join('');

  const modalHtml = `
    <div style="margin-bottom: 16px;">
      <div style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 12px;">é¸æ“‡è¦å¥—ç”¨çš„å°ˆé•·ï¼š</div>
      ${checkboxHtml || '<div style="color: #999; text-align: center; padding: 20px;">å°šç„¡å°ˆé•·</div>'}
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="applyBatchSpecialties()">âœ… å¥—ç”¨åˆ° ${selectedCheckboxes.length} ä½äººå“¡</button>
  `;

  showModal('æ‰¹æ¬¡è¨­å®šå°ˆé•·', modalHtml);
}

// å¥—ç”¨æ‰¹æ¬¡å°ˆé•·è¨­å®š
function applyBatchSpecialties() {
  const selectedCheckboxes = Array.from(document.querySelectorAll('.person-checkbox:checked'));
  const specialties = Array.from(document.querySelectorAll('#modalContent input[type="checkbox"]:checked')).map(cb => cb.value);

  selectedCheckboxes.forEach(cb => {
    const index = parseInt(cb.dataset.index);
    data.personnel[index].specialties = specialties;
  });

  saveToCache();
  render();
  closeModal();

  // è‡ªå‹•é—œé–‰æ‰¹æ¬¡æ¨¡å¼ä¸¦æ¸…é™¤å‹¾é¸
  const batchModeCheckbox = document.getElementById('batchMode');
  if (batchModeCheckbox) {
    batchModeCheckbox.checked = false;
    toggleBatchMode();
  }

  alert(`âœ… å·²ç‚º ${selectedCheckboxes.length} ä½äººå“¡è¨­å®šå°ˆé•·`);
}

// ========================================
// äººå“¡é †åºèª¿æ•´åŠŸèƒ½
// ========================================

let draggedIndex = null;

function handleDragStart(e) {
  draggedIndex = parseInt(e.target.dataset.index);
  e.target.style.opacity = '0.4';
}

function handleDragOver(e) {
  e.preventDefault();
  // é¡¯ç¤ºè—è‰²æ’å…¥ç·š
  e.currentTarget.style.borderTop = '3px solid #2196f3';
  return false;
}

function handleDrop(e) {
  e.stopPropagation();
  e.preventDefault();

  // æ¸…é™¤æ’å…¥ç·š
  e.currentTarget.style.borderTop = '';

  const dropIndex = parseInt(e.currentTarget.dataset.index);

  if (draggedIndex !== null && draggedIndex !== dropIndex) {
    // æ’å…¥é‚è¼¯ï¼šç§»é™¤è¢«æ‹–æ›³çš„äººå“¡ï¼Œæ’å…¥åˆ°ç›®æ¨™ä½ç½®
    const person = data.personnel.splice(draggedIndex, 1)[0];
    data.personnel.splice(dropIndex, 0, person);

    saveToCache();
    renderOverviewTable();
  }

  return false;
}

function handleDragEnd(e) {
  e.target.style.opacity = '1';
  // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„æ’å…¥ç·š
  document.querySelectorAll('#overviewTableBody tr').forEach(tr => {
    tr.style.borderTop = '';
  });
  draggedIndex = null;
}

// æŒ‰éˆ•æ–¹å¼ç§»å‹•äººå“¡
function movePersonUp(index) {
  if (index === 0) return;

  const temp = data.personnel[index];
  data.personnel[index] = data.personnel[index - 1];
  data.personnel[index - 1] = temp;

  saveToCache();
  renderOverviewTable();
}

function movePersonDown(index) {
  if (index === data.personnel.length - 1) return;

  const temp = data.personnel[index];
  data.personnel[index] = data.personnel[index + 1];
  data.personnel[index + 1] = temp;

  saveToCache();
  renderOverviewTable();
}

// æ’åºè¡¨æ ¼
let sortDirection = {};

function sortTable(field) {
  if (!sortDirection[field]) sortDirection[field] = 'asc';
  else sortDirection[field] = sortDirection[field] === 'asc' ? 'desc' : 'asc';

  overviewFilteredData.sort((a, b) => {
    let aVal = a[field] || '';
    let bVal = b[field] || '';

    if (sortDirection[field] === 'asc') {
      return aVal > bVal ? 1 : -1;
    } else {
      return aVal < bVal ? 1 : -1;
    }
  });

  renderOverviewTable();
}

// ========================================
// äººå“¡æ“ä½œä¸‹æ‹‰é¸å–®æ§åˆ¶
// ========================================

// åˆ‡æ›äººå“¡æ“ä½œé¸å–®
function togglePersonActions(index, event) {
  event.stopPropagation();

  const menu = document.getElementById(`person-menu-${index}`);
  if (!menu) return;

  // é—œé–‰æ‰€æœ‰å…¶ä»–é¸å–®
  document.querySelectorAll('.person-actions-menu').forEach(m => {
    if (m !== menu) {
      m.classList.remove('show');
    }
  });

  // åˆ‡æ›ç•¶å‰é¸å–®
  menu.classList.toggle('show');
}

// é—œé–‰æŒ‡å®šäººå“¡æ“ä½œé¸å–®
function closePersonActions(index) {
  const menu = document.getElementById(`person-menu-${index}`);
  if (menu) {
    menu.classList.remove('show');
  }
}

// é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚é—œé–‰æ‰€æœ‰é¸å–®
document.addEventListener('click', (e) => {
  if (!e.target.closest('.person-actions-dropdown')) {
    document.querySelectorAll('.person-actions-menu').forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

// ========================================
// æ—¥å¤œæ¨¡å¼åˆ‡æ›
// ========================================

function toggleTheme() {
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');
  const isDark = body.classList.toggle('dark-mode');

  themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('settings_theme', isDark ? 'dark' : 'light');
}

function loadTheme() {
  const savedTheme = localStorage.getItem('settings_theme');
  const themeToggle = document.getElementById('themeToggle');

  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark = savedTheme === 'dark' || (savedTheme === null && prefersDark);

  if (isDark) {
    document.body.classList.add('dark-mode');
    if (themeToggle) themeToggle.textContent = 'â˜€ï¸';
  }
}

window.addEventListener('load', () => {
  loadTheme();
  init();
});
</script>

</body>
</html>
