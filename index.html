<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ½› . ç±Œç•¥å®¤</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
  background: linear-gradient(135deg, #f5e6d3 0%, #e8d4bc 100%);
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  overflow-x: hidden;
  overflow-y: auto;
  transition: all 0.3s ease;
  position: relative;
}

/* æ™¨å…‰å…‰æšˆæ•ˆæœ */
body::before {
  content: '';
  position: fixed;
  top: -50%;
  right: -20%;
  width: 80%;
  height: 80%;
  background: radial-gradient(circle, rgba(255, 255, 200, 0.3) 0%, transparent 70%);
  pointer-events: none;
  animation: glowPulse 8s ease-in-out infinite;
  z-index: 0;
}

@keyframes glowPulse {
  0%, 100% { opacity: 0.6; transform: scale(1); }
  50% { opacity: 0.8; transform: scale(1.1); }
}

/* === æš—é»‘æ¨¡å¼æ¨£å¼ === */
body.dark-mode {
  background: linear-gradient(135deg, #1a2332 0%, #2c3e50 100%);
}

body.dark-mode::before {
  display: none;
}

/* æ·±æµ·æ³¡æ²«æ•ˆæœ */
body.dark-mode::after {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  background-image:
    radial-gradient(circle, rgba(255, 255, 255, 0.15) 2px, transparent 2px),
    radial-gradient(circle, rgba(255, 255, 255, 0.12) 3px, transparent 3px),
    radial-gradient(circle, rgba(255, 255, 255, 0.1) 2px, transparent 2px);
  background-size: 150px 150px, 200px 200px, 250px 250px;
  background-position: 0 100%, 50px 150%, 100px 180%;
  animation: bubbleFloat 15s ease-in-out infinite;
  z-index: 0;
}

@keyframes bubbleFloat {
  0% {
    background-position: 0 100%, 50px 150%, 100px 180%;
    opacity: 0;
  }
  20% {
    opacity: 1;
  }
  80% {
    opacity: 1;
  }
  100% {
    background-position: 0 -100%, 50px -50%, 100px -80%;
    opacity: 0;
  }
}

body.dark-mode .title {
  color: #f5f5f5;
}

body.dark-mode .subtitle {
  color: rgba(255, 255, 255, 0.6);
}

body.dark-mode .menu-item {
  background: rgba(44, 62, 80, 0.3);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  color: #e8d4bc;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

body.dark-mode .menu-item:hover {
  box-shadow: 0 6px 24px rgba(0, 0, 0, 0.4);
}

body.dark-mode .menu-title {
  color: #f5e6d3;
}

body.dark-mode .menu-desc {
  color: #d9c9a8;
}

body.dark-mode .loading {
  background: rgba(44, 62, 80, 0.95);
  color: #b39ddb;
}

body.dark-mode .sync-status {
  background: rgba(44, 62, 80, 0.9);
  color: #9fa8b2;
}

body.dark-mode .version {
  color: rgba(255, 255, 255, 0.5);
}

.container {
  max-width: 100%;
  width: 100%;
  padding: 0 10px;
  position: relative;
  z-index: 1;
}

.header {
  text-align: center;
  margin-bottom: 40px;
}

.logo {
  font-size: 64px;
  margin-bottom: 16px;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.title {
  font-size: 28px;
  font-weight: 700;
  color: #ffffff;
  margin-bottom: 8px;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.subtitle {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.8);
}

.mode-label {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.9);
  margin-top: 8px;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
  background: rgba(255, 255, 255, 0.15);
  padding: 6px 16px;
  border-radius: 20px;
  display: inline-block;
  backdrop-filter: blur(5px);
}

/* æ·±åº¦æŒ‡ç¤ºå™¨ */
.depth-indicator {
  position: fixed;
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 1000;
  display: none;
}

body.dark-mode .depth-indicator {
  display: block;
}

.depth-scale {
  position: relative;
  width: 3px;
  height: 300px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 2px;
}

.depth-mark {
  position: absolute;
  left: 10px;
  white-space: nowrap;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.6);
  font-weight: 500;
}

.depth-mark::before {
  content: '';
  position: absolute;
  left: -13px;
  top: 50%;
  transform: translateY(-50%);
  width: 8px;
  height: 1px;
  background: rgba(255, 255, 255, 0.4);
}

.depth-current {
  position: absolute;
  left: 10px;
  top: 42.5%;
  font-size: 14px;
  color: #64b5f6;
  font-weight: 700;
  animation: depthChange 8s ease-in-out infinite;
  text-shadow: 0 0 8px rgba(100, 181, 246, 0.6);
}

@keyframes depthChange {
  0%, 100% { top: 42.5%; }
  50% { top: 47.5%; }
}

.menu-grid {
  display: flex;
  gap: 20px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  scroll-behavior: smooth;
  padding: 10px 0 30px 0;
  margin-bottom: 20px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none; /* Firefox */
}

.menu-grid::-webkit-scrollbar {
  display: none; /* Chrome, Safari */
}

.menu-item {
  flex: 0 0 80vw;
  max-width: 350px;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 24px;
  padding: 40px 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
  text-decoration: none;
  display: block;
  scroll-snap-align: center;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}

.menu-item:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
}

.menu-item:active {
  transform: translateY(-4px) scale(1.01);
}

.menu-icon {
  font-size: 64px;
  margin-bottom: 16px;
  filter: drop-shadow(0 2px 8px rgba(255, 140, 66, 0.2));
}

.menu-title {
  font-size: 18px;
  font-weight: 700;
  color: #8B5E3C;
  margin-bottom: 6px;
  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
}

.menu-desc {
  font-size: 13px;
  color: #6D4C3A;
  text-shadow: 0 1px 2px rgba(255, 255, 255, 0.2);
}

/* æ»‘å‹•æŒ‡ç¤ºå™¨ */
.scroll-indicator {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px;
}

.scroll-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.4);
  transition: all 0.3s;
  cursor: pointer;
}

.scroll-dot.active {
  background: rgba(255, 255, 255, 0.9);
  width: 24px;
  border-radius: 4px;
}

.sync-status {
  text-align: center;
  color: rgba(255, 255, 255, 0.85);
  font-size: 12px;
  margin-top: 16px;
  font-weight: 500;
}

.sync-status.syncing {
  color: #ffd700;
}

.loading {
  display: none;
  text-align: center;
  color: white;
  padding: 20px;
}

.loading.show {
  display: block;
}

.loading-spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top-color: #ffffff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 12px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.version {
  text-align: center;
  color: rgba(255, 255, 255, 0.5);
  font-size: 11px;
  margin-top: 20px;
}

@media (max-width: 480px) {
  .menu-grid {
    gap: 12px;
  }

  .menu-item {
    padding: 24px 16px;
  }

  .menu-icon {
    font-size: 40px;
  }

  .menu-title {
    font-size: 14px;
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <button onclick="toggleTheme()" style="position: fixed; top: 20px; right: 20px; width: 48px; height: 48px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); color: white; font-size: 24px; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: center;" id="themeToggle">ğŸŒ™</button>

    <!-- æ·±åº¦æŒ‡ç¤ºå™¨ (åƒ…å¤œé–“æ¨¡å¼é¡¯ç¤º) -->
    <div class="depth-indicator" id="depthIndicator">
      <div class="depth-scale">
        <div class="depth-mark" style="top: 0%"><span>0m</span></div>
        <div class="depth-mark" style="top: 25%"><span>50m</span></div>
        <div class="depth-mark" style="top: 50%"><span>100m</span></div>
        <div class="depth-mark" style="top: 75%"><span>150m</span></div>
        <div class="depth-mark" style="top: 100%"><span>200m</span></div>
      </div>
      <div class="depth-current" id="depthCurrent">85m</div>
    </div>

    <div class="logo">ğŸ–ï¸</div>
    <div class="title">æ½› . ç±Œç•¥å®¤</div>
    <div class="subtitle">Strategic Planning Center</div>
    <div class="mode-label" id="modeLabel">ç ´æ›‰ä½œæˆ°æ¨¡å¼</div>
  </div>

  <div class="loading" id="loading">
    <div class="loading-spinner"></div>
    <div>åˆå§‹åŒ–ä¸­...</div>
  </div>

  <div class="menu-grid" id="menuGrid" style="display: none;">
    <!-- è¤‡è£½çš„æœ€å¾Œä¸€å¼µï¼ˆç”¨æ–¼ç„¡é™å¾ªç’°ï¼‰ -->
    <a href="settings.html" class="menu-item menu-item-clone" data-index="3" data-clone="true">
      <div class="menu-icon">âš™ï¸</div>
      <div class="menu-title">ç³»çµ±è¨­å®š</div>
      <div class="menu-desc">äººå“¡å°ˆé•·ç®¡ç†</div>
    </a>

    <!-- çœŸå¯¦å¡ç‰‡ -->
    <a href="service.html" class="menu-item" data-index="0">
      <div class="menu-icon">ğŸ“‹</div>
      <div class="menu-title">æ›´å¼¦æ˜“è½</div>
      <div class="menu-desc">è¼ªå€¼èª¿åº¦ç®¡ç†</div>
    </a>

    <a href="vacation.html" class="menu-item" data-index="1">
      <div class="menu-icon">â°</div>
      <div class="menu-title">è¿´æ­¸ç·š</div>
      <div class="menu-desc">æ­¸éšŠæ™‚é–“ç™»è¨˜</div>
    </a>

    <a href="task.html" class="menu-item" data-index="2">
      <div class="menu-icon">ğŸ‹</div>
      <div class="menu-title">ç«¹æ—è¨ˆç•«</div>
      <div class="menu-desc">è¡Œå‹•æº–æ“šè¦åŠƒ</div>
    </a>

    <a href="settings.html" class="menu-item" data-index="3">
      <div class="menu-icon">âš™ï¸</div>
      <div class="menu-title">ç³»çµ±è¨­å®š</div>
      <div class="menu-desc">äººå“¡å°ˆé•·ç®¡ç†</div>
    </a>

    <!-- è¤‡è£½çš„ç¬¬ä¸€å¼µï¼ˆç”¨æ–¼ç„¡é™å¾ªç’°ï¼‰ -->
    <a href="service.html" class="menu-item menu-item-clone" data-index="0" data-clone="true">
      <div class="menu-icon">ğŸ“‹</div>
      <div class="menu-title">æ›´å¼¦æ˜“è½</div>
      <div class="menu-desc">è¼ªå€¼èª¿åº¦ç®¡ç†</div>
    </a>
  </div>

  <div class="scroll-indicator" id="scrollIndicator" style="display: none;">
    <div class="scroll-dot active" onclick="scrollToCard(0)"></div>
    <div class="scroll-dot" onclick="scrollToCard(1)"></div>
    <div class="scroll-dot" onclick="scrollToCard(2)"></div>
    <div class="scroll-dot" onclick="scrollToCard(3)"></div>
  </div>

  <div class="sync-status" id="syncStatus">
    åˆå§‹åŒ–ä¸­...
  </div>

  <div class="version">v2.0.0 - LIFF Edition</div>
</div>

<script>
// ========================================
// å®‰å…¨å¯†ç¢¼é©—è­‰ç³»çµ± v2.0
// ========================================

// ğŸ” å®‰å…¨é…ç½®
const SECURITY_CONFIG = {
  // å¯†ç¢¼çš„ SHA-256 é›œæ¹Šå€¼ (ç•¶å‰å¯†ç¢¼: liqwer+159time)
  // å¦‚è¦æ›´æ”¹å¯†ç¢¼ï¼Œè«‹ä½¿ç”¨ä¸‹æ–¹çš„ generatePasswordHash() å‡½æ•¸ç”Ÿæˆæ–°çš„é›œæ¹Šå€¼
  PASSWORD_HASH: 'bdd6dbe19c726948e66a4c7909e47126e604cc0310f10fd769aa43d860f67dbd',

  // é¹½å€¼ (å¢åŠ å®‰å…¨æ€§ï¼Œè«‹è‡ªè¡Œä¿®æ”¹ç‚ºéš¨æ©Ÿå­—ä¸²)
  SALT: 'qian_chou_lue_shi_2024',

  // å¯†ç¢¼æœ‰æ•ˆæœŸï¼ˆå¤©æ•¸ï¼Œ0 è¡¨ç¤ºæ°¸ä¹…æœ‰æ•ˆï¼‰
  EXPIRE_DAYS: 30,

  // æœ€å¤§å˜—è©¦æ¬¡æ•¸ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
  MAX_ATTEMPTS: 5,

  // é–å®šæ™‚é–“ï¼ˆåˆ†é˜ï¼‰
  LOCKOUT_MINUTES: 15
};

// ========================================
// å¯†ç¢¼é›œæ¹Šç”Ÿæˆå·¥å…·ï¼ˆåƒ…ç”¨æ–¼è¨­å®šæ–°å¯†ç¢¼ï¼‰
// ========================================
// ä½¿ç”¨æ–¹æ³•ï¼šåœ¨ç€è¦½å™¨æ§åˆ¶å°è¼¸å…¥ generatePasswordHash('ä½ çš„æ–°å¯†ç¢¼')
// ç„¶å¾Œå°‡è¿”å›çš„é›œæ¹Šå€¼è¤‡è£½åˆ°ä¸Šæ–¹çš„ PASSWORD_HASH
function generatePasswordHash(password) {
  const hash = CryptoJS.SHA256(password + SECURITY_CONFIG.SALT).toString();
  console.log('='.repeat(60));
  console.log('ğŸ” æ–°å¯†ç¢¼é›œæ¹Šå€¼å·²ç”Ÿæˆï¼š');
  console.log(hash);
  console.log('='.repeat(60));
  console.log('è«‹å°‡æ­¤é›œæ¹Šå€¼è¤‡è£½åˆ° SECURITY_CONFIG.PASSWORD_HASH');
  console.log('='.repeat(60));
  return hash;
}

// ========================================
// æª¢æŸ¥æ˜¯å¦è¢«é–å®š
// ========================================
function checkLockout() {
  const lockoutUntil = localStorage.getItem('lockout_until');
  if (!lockoutUntil) return false;

  const now = new Date().getTime();
  const lockoutTime = new Date(lockoutUntil).getTime();

  if (now < lockoutTime) {
    const remainingMinutes = Math.ceil((lockoutTime - now) / (1000 * 60));
    return remainingMinutes;
  } else {
    // é–å®šæ™‚é–“å·²éï¼Œæ¸…é™¤è¨˜éŒ„
    localStorage.removeItem('lockout_until');
    localStorage.removeItem('failed_attempts');
    return false;
  }
}

// ========================================
// è¨˜éŒ„å¤±æ•—å˜—è©¦
// ========================================
function recordFailedAttempt() {
  const attempts = parseInt(localStorage.getItem('failed_attempts') || '0') + 1;
  localStorage.setItem('failed_attempts', attempts.toString());

  if (attempts >= SECURITY_CONFIG.MAX_ATTEMPTS) {
    // è§¸ç™¼é–å®š
    const lockoutUntil = new Date();
    lockoutUntil.setMinutes(lockoutUntil.getMinutes() + SECURITY_CONFIG.LOCKOUT_MINUTES);
    localStorage.setItem('lockout_until', lockoutUntil.toISOString());

    return {
      locked: true,
      message: `âš ï¸ å¯†ç¢¼éŒ¯èª¤æ¬¡æ•¸éå¤š\n\nç³»çµ±å·²é–å®š ${SECURITY_CONFIG.LOCKOUT_MINUTES} åˆ†é˜\nè«‹ç¨å¾Œå†è©¦`
    };
  }

  const remaining = SECURITY_CONFIG.MAX_ATTEMPTS - attempts;
  return {
    locked: false,
    message: `âŒ è­˜åˆ¥ç¢¼éŒ¯èª¤\n\nå‰©é¤˜å˜—è©¦æ¬¡æ•¸: ${remaining}`
  };
}

// ========================================
// æª¢æŸ¥å¯†ç¢¼æ˜¯å¦éæœŸ
// ========================================
function checkPasswordExpiry() {
  if (SECURITY_CONFIG.EXPIRE_DAYS === 0) return true;

  const initTime = localStorage.getItem('init_time');
  if (!initTime) return true;

  const initDate = new Date(initTime);
  const now = new Date();
  const diffDays = (now - initDate) / (1000 * 60 * 60 * 24);

  if (diffDays > SECURITY_CONFIG.EXPIRE_DAYS) {
    localStorage.removeItem('access_granted');
    localStorage.removeItem('init_time');
    return false;
  }

  return true;
}

// ========================================
// é©—è­‰å¯†ç¢¼
// ========================================
function verifyPassword(inputPassword) {
  // è¨ˆç®—è¼¸å…¥å¯†ç¢¼çš„é›œæ¹Šå€¼
  const inputHash = CryptoJS.SHA256(inputPassword + SECURITY_CONFIG.SALT).toString();

  // æ¯”å°é›œæ¹Šå€¼
  return inputHash === SECURITY_CONFIG.PASSWORD_HASH;
}

// ========================================
// Token é©—è­‰æ©Ÿåˆ¶ï¼ˆé˜²æ­¢ç°¡å–®ç¹éï¼‰
// ========================================

// ç”Ÿæˆé©—è­‰ Token
function generateAuthToken() {
  const timestamp = new Date().getTime();
  const random = Math.random().toString(36).substring(2);
  const token = CryptoJS.SHA256(timestamp + random + SECURITY_CONFIG.SALT).toString();
  return token;
}

// é©—è­‰ Token æœ‰æ•ˆæ€§
function verifyAuthToken() {
  const granted = localStorage.getItem('access_granted');
  const token = localStorage.getItem('auth_token');
  const initTime = localStorage.getItem('init_time');

  // ä¸‰è€…å¿…é ˆéƒ½å­˜åœ¨
  if (granted !== 'true' || !token || !initTime) {
    return false;
  }

  // æª¢æŸ¥ Token æ ¼å¼ï¼ˆ64 ä½ hexï¼‰
  if (!/^[a-f0-9]{64}$/.test(token)) {
    return false;
  }

  return true;
}

// ========================================
// æª¢æŸ¥å­˜å–æ¬Šé™ï¼ˆä¸»è¦å‡½æ•¸ï¼‰
// ========================================
function checkAccessCode() {
  // 1. æª¢æŸ¥æ˜¯å¦è¢«é–å®š
  const lockoutMinutes = checkLockout();
  if (lockoutMinutes) {
    alert(`ğŸ”’ ç³»çµ±å·²é–å®š\n\nè«‹åœ¨ ${lockoutMinutes} åˆ†é˜å¾Œå†è©¦`);
    document.body.innerHTML = `
      <div style="text-align:center;padding:50px;font-family:sans-serif;">
        <h1>ğŸ”’ ç³»çµ±å·²é–å®š</h1>
        <p style="font-size:18px;color:#666;margin-top:20px;">
          å¯†ç¢¼éŒ¯èª¤æ¬¡æ•¸éå¤š<br>
          è«‹åœ¨ <strong style="color:#f44336;">${lockoutMinutes}</strong> åˆ†é˜å¾Œå†è©¦
        </p>
        <button onclick="location.reload()" style="margin-top:30px;padding:12px 24px;font-size:16px;background:#2196f3;color:white;border:none;border-radius:8px;cursor:pointer;">
          é‡æ–°æ•´ç†
        </button>
      </div>
    `;
    return false;
  }

  // 2. æª¢æŸ¥æ˜¯å¦å·²é©—è­‰ï¼ˆåŠ å…¥ Token é©—è­‰ï¼‰
  if (verifyAuthToken()) {
    // æª¢æŸ¥æ˜¯å¦éæœŸ
    if (checkPasswordExpiry()) {
      return true; // å·²é©—è­‰ã€Token æœ‰æ•ˆä¸”æœªéæœŸ
    } else {
      alert(`â° é©—è­‰å·²éæœŸ\n\nè«‹é‡æ–°è¼¸å…¥è­˜åˆ¥ç¢¼\nï¼ˆæœ‰æ•ˆæœŸé™ï¼š${SECURITY_CONFIG.EXPIRE_DAYS} å¤©ï¼‰`);
    }
  }

  // 3. ç¬¬ä¸€æ¬¡ä½¿ç”¨æˆ–é©—è­‰éæœŸï¼Œè¦æ±‚è¼¸å…¥è­˜åˆ¥ç¢¼
  let attempts = 0;
  const maxPromptAttempts = 3; // prompt æœ€å¤šé¡¯ç¤º 3 æ¬¡

  while (attempts < maxPromptAttempts) {
    const userCode = prompt('ğŸ” è«‹è¼¸å…¥ç³»çµ±è­˜åˆ¥ç¢¼:');

    // ä½¿ç”¨è€…å–æ¶ˆè¼¸å…¥
    if (userCode === null) {
      document.body.innerHTML = `
        <div style="text-align:center;padding:50px;font-family:sans-serif;">
          <h1>âš ï¸ æœªå®Œæˆé©—è­‰</h1>
          <p style="font-size:16px;color:#666;margin-top:20px;">
            æ‚¨å·²å–æ¶ˆè­˜åˆ¥ç¢¼è¼¸å…¥
          </p>
          <button onclick="location.reload()" style="margin-top:30px;padding:12px 24px;font-size:16px;background:#2196f3;color:white;border:none;border-radius:8px;cursor:pointer;">
            é‡æ–°é©—è­‰
          </button>
        </div>
      `;
      return false;
    }

    // é©—è­‰å¯†ç¢¼
    if (verifyPassword(userCode)) {
      // é©—è­‰æˆåŠŸ - ç”Ÿæˆä¸¦å„²å­˜ Token
      const authToken = generateAuthToken();
      localStorage.setItem('access_granted', 'true');
      localStorage.setItem('auth_token', authToken);
      localStorage.setItem('init_time', new Date().toISOString());
      localStorage.removeItem('failed_attempts');
      localStorage.removeItem('lockout_until');

      // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
      if (SECURITY_CONFIG.EXPIRE_DAYS > 0) {
        console.log(`âœ… é©—è­‰æˆåŠŸï¼æœ‰æ•ˆæœŸé™ï¼š${SECURITY_CONFIG.EXPIRE_DAYS} å¤©`);
      } else {
        console.log('âœ… é©—è­‰æˆåŠŸï¼');
      }

      return true;
    } else {
      // é©—è­‰å¤±æ•—
      const result = recordFailedAttempt();

      if (result.locked) {
        // å·²è¢«é–å®š
        alert(result.message);
        document.body.innerHTML = `
          <div style="text-align:center;padding:50px;font-family:sans-serif;">
            <h1>ğŸ”’ ç³»çµ±å·²é–å®š</h1>
            <p style="font-size:18px;color:#666;margin-top:20px;">
              å¯†ç¢¼éŒ¯èª¤æ¬¡æ•¸éå¤š<br>
              ç³»çµ±å·²é–å®š <strong style="color:#f44336;">${SECURITY_CONFIG.LOCKOUT_MINUTES}</strong> åˆ†é˜
            </p>
            <button onclick="location.reload()" style="margin-top:30px;padding:12px 24px;font-size:16px;background:#2196f3;color:white;border:none;border-radius:8px;cursor:pointer;">
              é‡æ–°æ•´ç†
            </button>
          </div>
        `;
        return false;
      } else {
        // ç¹¼çºŒå˜—è©¦
        alert(result.message);
        attempts++;
      }
    }
  }

  // è¶…é prompt å˜—è©¦æ¬¡æ•¸
  document.body.innerHTML = `
    <div style="text-align:center;padding:50px;font-family:sans-serif;">
      <h1>âš ï¸ ç„¡å­˜å–æ¬Šé™</h1>
      <p style="font-size:16px;color:#666;margin-top:20px;">
        è«‹è¯çµ¡ç®¡ç†å“¡å–å¾—è­˜åˆ¥ç¢¼
      </p>
      <button onclick="location.reload()" style="margin-top:30px;padding:12px 24px;font-size:16px;background:#2196f3;color:white;border:none;border-radius:8px;cursor:pointer;">
        é‡æ–°å˜—è©¦
      </button>
    </div>
  `;
  return false;
}

// ========================================
// åˆå§‹åŒ–
// ========================================
async function init() {
  // æª¢æŸ¥è­˜åˆ¥ç¢¼
  if (!checkAccessCode()) return;

  showLoading(true);

  try {
    // å¾æœ¬åœ°å¿«å–è¼‰å…¥è³‡æ–™
    const cache = localStorage.getItem('personnel_cache');

    if (cache) {
      updateSyncStatus('æœ¬åœ°è³‡æ–™å·²è¼‰å…¥');
    } else {
      // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œåˆå§‹åŒ–ç©ºåå–®
      localStorage.setItem('personnel_cache', '[]');
      localStorage.setItem('roles_cache', '[]');
      localStorage.setItem('signauth_cache', '[]');
      updateSyncStatus('é¦–æ¬¡ä½¿ç”¨ï¼Œè«‹è‡³ã€Œç³»çµ±è¨­å®šã€æ–°å¢äººå“¡');
    }
  } catch (error) {
    console.error('åˆå§‹åŒ–å¤±æ•—:', error);
    updateSyncStatus('åˆå§‹åŒ–å¤±æ•—');
  } finally {
    showLoading(false);
  }
}

// ========================================
// é‡è¨­ç³»çµ± (æ¸…é™¤æ‰€æœ‰è³‡æ–™)
// ========================================
function resetSystem() {
  if (confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—?\n\nåŒ…å«:\n- è­˜åˆ¥ç¢¼é©—è­‰è¨˜éŒ„\n- äººå“¡åå–®\n- æ‰€æœ‰å€¼ç­è³‡æ–™\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
    if (confirm('è«‹å†æ¬¡ç¢ºèªï¼ŒçœŸçš„è¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) {
      localStorage.clear();
      alert('âœ… ç³»çµ±å·²é‡è¨­ï¼Œé é¢å³å°‡é‡æ–°è¼‰å…¥');
      location.reload();
    }
  }
}

// ========================================
// æ›´æ–°ç‹€æ…‹é¡¯ç¤º
// ========================================
function updateSyncStatus(message) {
  const statusEl = document.getElementById('syncStatus');
  if (statusEl) {
    statusEl.textContent = message || 'æœ¬åœ°è³‡æ–™æ¨¡å¼';
  }
}

// ========================================
// é¡¯ç¤º/éš±è—è¼‰å…¥ä¸­
// ========================================
function showLoading(show) {
  document.getElementById('loading').classList.toggle('show', show);
  document.getElementById('menuGrid').style.display = show ? 'none' : 'flex';
  document.getElementById('scrollIndicator').style.display = show ? 'none' : 'flex';

  if (!show) {
    setupScrollObserver();
  }
}

// ========================================
// æ»‘å‹•å¡ç‰‡åŠŸèƒ½ï¼ˆç„¡é™å¾ªç’°ï¼‰
// ========================================
let isInfiniteScrolling = false;

function scrollToCard(index) {
  const menuGrid = document.getElementById('menuGrid');
  const cards = menuGrid.querySelectorAll('.menu-item:not([data-clone="true"])');
  // +1 æ˜¯å› ç‚ºç¬¬ä¸€å€‹æ˜¯è¤‡è£½çš„æœ€å¾Œä¸€å¼µ
  const targetCard = menuGrid.querySelectorAll('.menu-item')[index + 1];
  if (targetCard) {
    targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  }
}

function setupScrollObserver() {
  const menuGrid = document.getElementById('menuGrid');
  const dots = document.querySelectorAll('.scroll-dot');

  // åˆå§‹åŒ–ä½ç½®ï¼šæ»¾å‹•åˆ°ç¬¬ä¸€å¼µçœŸå¯¦å¡ç‰‡ï¼ˆindex 1ï¼Œå› ç‚º index 0 æ˜¯è¤‡è£½çš„ï¼‰
  const cards = menuGrid.querySelectorAll('.menu-item');
  if (cards[1]) {
    cards[1].scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'center' });
  }

  // ç›£è½æ»¾å‹•äº‹ä»¶ä»¥æ›´æ–°æŒ‡ç¤ºå™¨ï¼ˆå³æ™‚æ›´æ–°ï¼‰
  menuGrid.addEventListener('scroll', () => {
    if (!isInfiniteScrolling) {
      updateScrollIndicator();
    }
  });

  // ç›£è½æ»¾å‹•çµæŸäº‹ä»¶ä»¥è™•ç†ç„¡é™å¾ªç’°ï¼ˆç­‰æ»‘å‹•å®Œå…¨åœæ­¢ï¼‰
  menuGrid.addEventListener('scrollend', () => {
    handleInfiniteScroll();
  });

  // åˆå§‹åŒ–æŒ‡ç¤ºå™¨ç‹€æ…‹
  updateScrollIndicator();
}

function handleInfiniteScroll() {
  if (isInfiniteScrolling) return;

  const menuGrid = document.getElementById('menuGrid');
  const cards = menuGrid.querySelectorAll('.menu-item');
  const cardWidth = cards[0].offsetWidth + 20;
  const scrollLeft = menuGrid.scrollLeft;
  const currentIndex = Math.round(scrollLeft / cardWidth);

  // ç¸½å…± 6 å¼µå¡ç‰‡ï¼šè¤‡è£½çš„æœ€å¾Œä¸€å¼µ(0) + 4å¼µçœŸå¯¦å¡ç‰‡(1-4) + è¤‡è£½çš„ç¬¬ä¸€å¼µ(5)

  // å¦‚æœåœåœ¨è¤‡è£½çš„ç¬¬ä¸€å¼µï¼ˆæœ€å³é‚Šï¼‰ï¼Œç¬é–“è·³å›çœŸå¯¦çš„ç¬¬ä¸€å¼µ
  if (currentIndex >= 5) {
    isInfiniteScrolling = true;
    menuGrid.style.scrollSnapType = 'none'; // æš«æ™‚é—œé–‰ snap
    menuGrid.scrollLeft = cardWidth * 1; // ç›´æ¥è¨­å®šä½ç½®ï¼ˆç¬é–“è·³è½‰ï¼‰
    setTimeout(() => {
      menuGrid.style.scrollSnapType = 'x mandatory'; // æ¢å¾© snap
      isInfiniteScrolling = false;
      updateScrollIndicator();
    }, 10);
  }

  // å¦‚æœåœåœ¨è¤‡è£½çš„æœ€å¾Œä¸€å¼µï¼ˆæœ€å·¦é‚Šï¼‰ï¼Œç¬é–“è·³å›çœŸå¯¦çš„æœ€å¾Œä¸€å¼µ
  else if (currentIndex <= 0) {
    isInfiniteScrolling = true;
    menuGrid.style.scrollSnapType = 'none'; // æš«æ™‚é—œé–‰ snap
    menuGrid.scrollLeft = cardWidth * 4; // ç›´æ¥è¨­å®šä½ç½®ï¼ˆç¬é–“è·³è½‰ï¼‰
    setTimeout(() => {
      menuGrid.style.scrollSnapType = 'x mandatory'; // æ¢å¾© snap
      isInfiniteScrolling = false;
      updateScrollIndicator();
    }, 10);
  }
}

function updateScrollIndicator() {
  const menuGrid = document.getElementById('menuGrid');
  const cards = menuGrid.querySelectorAll('.menu-item');
  const dots = document.querySelectorAll('.scroll-dot');

  // è¨ˆç®—ç•¶å‰é¡¯ç¤ºçš„å¡ç‰‡
  const scrollLeft = menuGrid.scrollLeft;
  const cardWidth = cards[0].offsetWidth + 20;
  let currentIndex = Math.round(scrollLeft / cardWidth);

  // å°‡ç´¢å¼•æ˜ å°„åˆ°çœŸå¯¦å¡ç‰‡ï¼ˆ0-3ï¼‰
  // index 0 (è¤‡è£½) -> 3, index 1-4 (çœŸå¯¦) -> 0-3, index 5 (è¤‡è£½) -> 0
  if (currentIndex === 0) currentIndex = 3; // è¤‡è£½çš„æœ€å¾Œä¸€å¼µå°æ‡‰çœŸå¯¦ index 3
  else if (currentIndex === 5) currentIndex = 0; // è¤‡è£½çš„ç¬¬ä¸€å¼µå°æ‡‰çœŸå¯¦ index 0
  else currentIndex = currentIndex - 1; // çœŸå¯¦å¡ç‰‡ index 1-4 å°æ‡‰ 0-3

  // æ›´æ–°æŒ‡ç¤ºå™¨
  dots.forEach((dot, index) => {
    dot.classList.toggle('active', index === currentIndex);
  });
}

// ========================================
// æš—é»‘æ¨¡å¼åˆ‡æ›
// ========================================
function toggleTheme() {
  const body = document.body;
  const themeToggle = document.getElementById('themeToggle');
  const modeLabel = document.getElementById('modeLabel');
  const isDark = body.classList.toggle('dark-mode');

  // æ›´æ–°æŒ‰éˆ•åœ–ç¤º
  themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';

  // æ›´æ–°æ¨¡å¼æ¨™ç±¤
  modeLabel.textContent = isDark ? 'æ·±æµ·æ½›è¡Œæ¨¡å¼' : 'ç ´æ›‰ä½œæˆ°æ¨¡å¼';

  // å„²å­˜ä¸»é¡Œè¨­å®š
  localStorage.setItem('index_theme', isDark ? 'dark' : 'light');
}

// è¼‰å…¥ä¸»é¡Œè¨­å®š
function loadTheme() {
  const savedTheme = localStorage.getItem('index_theme');
  const themeToggle = document.getElementById('themeToggle');
  const modeLabel = document.getElementById('modeLabel');

  // å„ªå…ˆä½¿ç”¨å„²å­˜çš„è¨­å®š,å¦å‰‡æª¢æŸ¥ç³»çµ±åå¥½
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const isDark = savedTheme === 'dark' || (savedTheme === null && prefersDark);

  if (isDark) {
    document.body.classList.add('dark-mode');
    if (themeToggle) themeToggle.textContent = 'â˜€ï¸';
    if (modeLabel) modeLabel.textContent = 'æ·±æµ·æ½›è¡Œæ¨¡å¼';
  }
}

// ========================================
// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
// ========================================
window.addEventListener('load', () => {
  loadTheme(); // è¼‰å…¥ä¸»é¡Œ
  init();       // åˆå§‹åŒ–ç³»çµ±
});

// æ‰‹å‹•åŒæ­¥æŒ‰éˆ•ï¼ˆå¯é¸ï¼‰
function manualSync() {
  syncFromCloud();
}
</script>

</body>
</html>
