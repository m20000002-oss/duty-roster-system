<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-visual">
<title>æ›´å¼¦æ˜“è½ v2.0</title>
<style>
:root {
  --primary-color: #ff6f00;
  --primary-light: #ffa040;
  --primary-dark: #c43e00;
  --primary-gradient: linear-gradient(135deg, #ff6f00 0%, #ff8f00 100%);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
  background: linear-gradient(135deg, #a3b8c7 0%, #8fa6b5 100%);
  min-height: 100vh;
  min-height: 100dvh; /* Dynamic viewport height for mobile browsers */
  padding-bottom: max(80px, env(safe-area-inset-bottom));
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
  transition: all 0.3s ease;
  /* Mobile optimizations */
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior-y: contain;
  touch-action: manipulation;
  position: relative;
  overflow: hidden;
}

/* é›²éœ§é£„ç§»æ•ˆæœ (åªåœ¨å¤œé–“é¡¯ç¤º) */
body::before,
body::after {
  display: none; /* ç™½å¤©éš±è— */
}

@keyframes cloudFloat1 {
  0%, 100% { transform: translate(0, 0); opacity: 0.4; }
  50% { transform: translate(120px, 60px); opacity: 0.7; }
}

@keyframes cloudFloat2 {
  0%, 100% { transform: translate(0, 0); opacity: 0.5; }
  50% { transform: translate(-100px, -80px); opacity: 0.8; }
}

/* === æš—é»‘æ¨¡å¼æ¨£å¼ === */
body.dark-mode {
  background: linear-gradient(135deg, #1e3a5f 0%, #152d4a 100%) !important;
  color: #e0e0e0;
  overflow: hidden;
}

body.dark-mode::before,
body.dark-mode::after {
  display: block; /* å¤œé–“é¡¯ç¤º */
  content: '';
  position: fixed;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(150, 200, 230, 0.15) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

body.dark-mode::before {
  width: 500px;
  height: 500px;
  top: -150px;
  left: -150px;
  animation: cloudFloat1 18s ease-in-out infinite;
}

body.dark-mode::after {
  width: 450px;
  height: 450px;
  bottom: -100px;
  right: -100px;
  animation: cloudFloat2 22s ease-in-out infinite;
}

body.dark-mode .header {
  background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%) !important;
}

body.dark-mode .section {
  background: #2c3e50 !important;
  border-color: rgba(25, 118, 210, 0.3) !important;
}

body.dark-mode .section-title {
  color: #64b5f6 !important;
}

body.dark-mode .leave-tag {
  background: linear-gradient(135deg, #c62828 0%, #e53935 100%) !important;
}

body.dark-mode .empty-hint {
  color: #90caf9 !important;
}

body.dark-mode .time-label {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%) !important;
}

body.dark-mode .duty-slot {
  background: #34495e !important;
  border-color: #546e7a !important;
  color: #90caf9 !important;
}

body.dark-mode .duty-slot.filled {
  background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%) !important;
  border-color: #42a5f5 !important;
  color: #90caf9 !important;
}

body.dark-mode .duty-slot:hover {
  border-color: #42a5f5 !important;
  background: #2d4a6f !important;
}

body.dark-mode .duty-name {
  color: #64b5f6 !important;
}

body.dark-mode .vehicle-item {
  background: #34495e !important;
  border-color: #546e7a !important;
}

body.dark-mode .vehicle-item.active {
  background: #2d4a6f !important;
  border-color: #42a5f5 !important;
}

body.dark-mode .vehicle-name {
  color: #64b5f6 !important;
}

body.dark-mode .field-label {
  color: #90caf9 !important;
}

body.dark-mode .field-input {
  background: #34495e !important;
  border-color: #546e7a !important;
  color: #90caf9 !important;
}

body.dark-mode .person-card {
  background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%) !important;
  border-color: #546e7a !important;
}

body.dark-mode .person-card.on-leave {
  background: linear-gradient(135deg, #4a2c2c 0%, #5d3535 100%) !important;
  border-color: #c62828 !important;
}

body.dark-mode .person-name {
  color: #90caf9 !important;
}

body.dark-mode .input-text {
  background: #34495e !important;
  border-color: #546e7a !important;
  color: #90caf9 !important;
}

body.dark-mode .input-text::placeholder {
  color: #7f8c8d !important;
}

body.dark-mode .btn-primary {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%) !important;
}

body.dark-mode .modal {
  background: rgba(0, 0, 0, 0.85) !important;
}

body.dark-mode .modal-box {
  background: #2c3e50 !important;
  border-color: #1976d2 !important;
}

body.dark-mode .modal-title {
  color: #64b5f6 !important;
}

body.dark-mode .modal-content pre {
  background: #34495e !important;
  color: #90caf9 !important;
}

body.dark-mode .selector-item {
  background: #34495e !important;
  border-color: #546e7a !important;
  color: #90caf9 !important;
}

body.dark-mode .selector-item.selected {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%) !important;
  color: white !important;
}

body.dark-mode .template-item {
  background: #34495e !important;
  border-color: #546e7a !important;
}

body.dark-mode .template-name {
  color: #64b5f6 !important;
}

body.dark-mode .template-desc {
  color: #90caf9 !important;
}

body.dark-mode .date-input {
  background: #34495e !important;
  border-color: #546e7a !important;
  color: #90caf9 !important;
}

body.dark-mode .manage-item {
  background: #34495e !important;
}

body.dark-mode .manage-item-name {
  color: #64b5f6 !important;
}

body.dark-mode .manage-item-count {
  color: #90caf9 !important;
}

body.dark-mode .vehicle-manage-item {
  background: #34495e !important;
  border-color: #546e7a !important;
}

body.dark-mode .vehicle-manage-name {
  color: #64b5f6 !important;
}

body.dark-mode .footer {
  background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%) !important;
}

body.dark-mode .btn-sm {
  background: #ff9800;
}

body.dark-mode .slot-clear {
  background: linear-gradient(135deg, #c62828 0%, #e53935 100%) !important;
}

body.dark-mode .person-action-btn.btn-leave {
  background: #f9a825;
}

body.dark-mode .person-action-btn.btn-remove {
  background: #c62828;
}

body.dark-mode .btn-icon.btn-edit {
  background: #ff9800;
}

body.dark-mode .btn-icon.btn-delete {
  background: #c62828;
}

body.dark-mode .template-btn.btn-apply {
  background: #2196f3;
}

body.dark-mode .template-btn.btn-delete {
  background: #c62828;
}

body.dark-mode .tab-btn {
  color: rgba(255, 255, 255, 0.7) !important;
}

body.dark-mode .tab-btn.active {
  color: #ffffff !important;
}

body.dark-mode .signature-item {
  background: #34495e !important;
  border-color: #546e7a !important;
}

body.dark-mode .signature-item-header {
  color: #64b5f6 !important;
}

body.dark-mode .signature-location {
  color: #90caf9 !important;
}

body.dark-mode .signature-people {
  background: rgba(25, 118, 210, 0.1) !important;
  border-color: #546e7a !important;
}

body.dark-mode .signature-tag {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%) !important;
}

/* === ä¸€èˆ¬æ¨£å¼ === */
.header {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
  padding: 16px 20px;
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-title {
  font-size: 22px;
  color: #ffffff;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 700;
}

/* åœ–ç¤ºæŒ‰éˆ•ï¼ˆæš—è‰²æ¨¡å¼ã€å¤šæ—¥è¦åŠƒï¼‰ */
.icon-btn {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.3);
  color: white;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.icon-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.icon-btn:active {
  transform: scale(0.95);
}

/* æš—è‰²æ¨¡å¼æŒ‰éˆ•æ—‹è½‰å‹•ç•« */
.theme-toggle {
  transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.theme-toggle:hover {
  transform: rotate(180deg) scale(1.1);
}

/* æ—¥æœŸé¡¯ç¤ºå€å¡Š */
.date-section {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-top: 12px;
}

.date-display {
  flex: 1;
  background: rgba(255, 255, 255, 0.95);
  padding: 10px 16px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.date-display:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-color: var(--primary-color);
}

.date-text {
  font-size: 15px;
  font-weight: 700;
  color: var(--primary-color);
  flex: 1;
}

.weekday-badge {
  background: var(--primary-gradient);
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.5px;
}

/* å¿«é€Ÿæ—¥æœŸå°èˆª */
.quick-date-nav {
  display: flex;
  gap: 6px;
}

.quick-date-nav button {
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.2);
  border: 2px solid rgba(255, 255, 255, 0.4);
  border-radius: 10px;
  color: white;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.quick-date-nav button:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-1px);
}

.quick-date-nav button:active {
  transform: translateY(0);
}

/* éš±è—åŸç”Ÿæ—¥æœŸè¼¸å…¥ */
.date-input {
  display: none;
}

.tab-nav {
  display: flex;
  gap: 5px;
  margin-top: 12px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.tab-btn {
  padding: 12px 20px;
  background: none;
  border: none;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.tab-btn.active {
  color: #ffffff;
  border-bottom-color: #ffc107;
}

.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.section {
  background: #ffffff;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  box-shadow: 0 4px 16px rgba(25, 118, 210, 0.1);
  border: 2px solid rgba(25, 118, 210, 0.1);
}

.section-title {
  font-size: 18px;
  font-weight: 700;
  color: #1976d2;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.section-title.collapsible {
  cursor: pointer;
  user-select: none;
  padding: 12px;
  margin: -20px -20px 16px -20px;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-radius: 12px 12px 0 0;
  transition: all 0.3s;
}

.section-title.collapsible:hover {
  background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
}

.section-arrow {
  font-size: 14px;
  transition: transform 0.3s;
  margin-left: 8px;
}

.section-arrow.collapsed {
  transform: rotate(-90deg);
}

.section-content {
  max-height: 5000px;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  opacity: 1;
}

.section-content.collapsed {
  max-height: 0;
  opacity: 0;
}

.leave-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  min-height: 40px;
  align-items: center;
}

.leave-tag {
  background: linear-gradient(135deg, #e53935 0%, #f44336 100%);
  color: white;
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 2px 6px rgba(229, 57, 53, 0.3);
}

.empty-hint {
  color: #64b5f6;
  font-size: 14px;
  font-weight: 600;
}

.duty-grid {
  display: grid;
  gap: 12px;
}

.duty-row {
  display: grid;
  grid-template-columns: 80px 1fr 1fr;
  gap: 10px;
  align-items: center;
}

.time-label {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
  color: white;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  font-weight: 700;
  font-size: 14px;
}

.duty-slot {
  background: #f5f5f5;
  border: 2px dashed #bbdefb;
  border-radius: 8px;
  padding: 10px;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
}

.duty-slot:hover {
  border-color: #2196f3;
  background: #e3f2fd;
}

.duty-slot.filled {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: 2px solid #2196f3;
  color: #1565c0;
  font-weight: 600;
}

.duty-slot.drag-over {
  border-color: #1976d2;
  background: #bbdefb;
}

.slot-clear {
  position: absolute;
  top: 2px;
  right: 2px;
  background: #f44336;
  color: white;
  border: none;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  font-size: 16px;
  cursor: pointer;
  opacity: 0;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.duty-slot.filled:hover .slot-clear {
  opacity: 1;
}

.btn-sm {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  background: #ff9800;
  color: white;
}

.special-duties {
  display: grid;
  gap: 10px;
}

.special-duty {
  display: grid;
  grid-template-columns: 120px 1fr;
  gap: 10px;
  align-items: center;
}

.duty-name {
  font-weight: 700;
  color: #1976d2;
  display: flex;
  align-items: center;
  gap: 8px;
}

.duty-slots-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.vehicle-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.vehicle-item {
  border: 2px solid #bbdefb;
  border-radius: 12px;
  padding: 14px;
  background: #f5f5f5;
}

.vehicle-item.active {
  border-color: #2196f3;
  background: #e3f2fd;
}

.vehicle-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.vehicle-checkbox {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.vehicle-name {
  flex: 1;
  font-weight: 700;
  color: #1976d2;
  font-size: 15px;
}

.vehicle-info {
  display: grid;
  gap: 8px;
  margin-bottom: 8px;
}

.vehicle-field {
  display: grid;
  grid-template-columns: 60px 1fr;
  gap: 8px;
  align-items: center;
}

.field-label {
  font-size: 13px;
  font-weight: 600;
  color: #666;
}

.field-input {
  padding: 8px;
  border: 2px solid #e0e0e0;
  border-radius: 6px;
  font-size: 14px;
}

.person-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 10px;
  margin-top: 12px;
}

.person-card {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: 2px solid #90caf9;
  border-radius: 12px;
  padding: 12px;
  text-align: center;
  cursor: grab;
  transition: all 0.3s;
  position: relative;
  user-select: none;
  -webkit-user-select: none;
  touch-action: none;
}

.person-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 6px 16px rgba(25, 118, 210, 0.2);
}

.person-card.dragging {
  opacity: 0.5;
  cursor: grabbing;
}

.person-card.on-leave {
  background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
  border-color: #ef5350;
  opacity: 0.6;
}

.person-name {
  font-size: 14px;
  font-weight: 700;
  color: #1976d2;
  margin-bottom: 8px;
}

.person-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  gap: 8px;
}

.person-card-header .person-name {
  margin-bottom: 0;
}

.person-toggle-arrow {
  background: rgba(25, 118, 210, 0.1);
  border: 2px solid #90caf9;
  border-radius: 6px;
  padding: 8px 12px;
  color: #1976d2;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 700;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.person-toggle-arrow:hover {
  background: rgba(25, 118, 210, 0.2);
  transform: scale(1.1);
}

.person-toggle-arrow.expanded {
  background: linear-gradient(135deg, #1976d2 0%, #1e88e5 100%);
  color: white;
}

.person-assignments {
  display: none;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 8px;
  padding: 8px;
  margin-bottom: 8px;
  border: 2px dashed #90caf9;
  animation: slideDown 0.3s ease;
  max-height: 150px;
  overflow-y: auto;
}

.person-assignments.show {
  display: block;
}

.assignment-item {
  background: white;
  border-radius: 4px;
  padding: 6px 8px;
  margin-bottom: 4px;
  font-size: 12px;
  color: #1976d2;
  font-weight: 600;
  border: 1px solid #bbdefb;
}

.assignment-item:last-child {
  margin-bottom: 0;
}

.person-actions {
  display: flex;
  gap: 4px;
  justify-content: center;
}

.person-action-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-leave {
  background: #ffc107;
  color: #3e2723;
}

.btn-remove {
  background: #dc3545;
  color: white;
}

.input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 16px;
}

.input-text {
  flex: 1;
  padding: 12px;
  border: 2px solid #bbdefb;
  border-radius: 10px;
  font-size: 14px;
  background: #ffffff;
  font-weight: 600;
  color: #1976d2;
}

.btn-primary {
  padding: 12px 20px;
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
}

.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
  padding: 12px 20px;
  box-shadow: 0 -4px 12px rgba(25, 118, 210, 0.3);
  z-index: 99;
  transition: all 0.3s;
  display: flex;
  gap: 10px;
}

.footer-mode-indicator {
  text-align: center;
  color: white;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 8px;
  opacity: 0.8;
}

.footer-buttons {
  display: flex;
  gap: 10px;
}

.mode-toggle-btn {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  border: none;
  background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
  color: white;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(156, 39, 176, 0.4);
  z-index: 100;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mode-toggle-btn:hover {
  transform: scale(1.1) rotate(10deg);
  box-shadow: 0 6px 20px rgba(156, 39, 176, 0.6);
}

.mode-toggle-btn:active {
  transform: scale(0.95);
}

body.dark-mode .mode-toggle-btn {
  background: linear-gradient(135deg, #7b1fa2 0%, #9c27b0 100%);
}

.footer-btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.footer-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.btn-preview {
  background: linear-gradient(135deg, #ffd54f 0%, #ffca28 100%);
  color: #3e2723;
}

.btn-copy {
  background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
  color: white;
}

.btn-line {
  background: linear-gradient(135deg, #06C755 0%, #00B900 100%);
  color: white;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(25, 118, 210, 0.7);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.show { display: flex; }

.modal-box {
  background: #ffffff;
  border-radius: 20px;
  padding: 24px;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  border: 3px solid #1976d2;
  box-shadow: 0 10px 40px rgba(25, 118, 210, 0.3);
}

.modal-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 20px;
  color: #1976d2;
}

.modal-content pre {
  background: #e3f2fd;
  padding: 16px;
  border-radius: 12px;
  white-space: pre-wrap;
  font-family: inherit;
  color: #1976d2;
  line-height: 1.8;
}

.person-selector {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 8px;
  margin-bottom: 16px;
}

.selector-item {
  padding: 10px;
  background: #e3f2fd;
  border: 2px solid #90caf9;
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  font-size: 13px;
  font-weight: 600;
  color: #1976d2;
  transition: all 0.3s;
}

.selector-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
}

.selector-item.selected {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
  color: white;
  border-color: #1976d2;
}

.template-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.template-item {
  background: #e3f2fd;
  border: 2px solid #90caf9;
  border-radius: 12px;
  padding: 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.template-info {
  flex: 1;
}

.template-name {
  font-size: 16px;
  font-weight: 700;
  color: #1976d2;
  margin-bottom: 4px;
}

.template-desc {
  font-size: 12px;
  color: #42a5f5;
}

.template-actions {
  display: flex;
  gap: 6px;
}

.template-btn {
  padding: 8px 14px;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-apply {
  background: #2196f3;
  color: white;
}

.btn-delete {
  background: #dc3545;
  color: white;
}

.manage-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.manage-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: #f5f5f5;
  border-radius: 8px;
}

.manage-item-name {
  flex: 1;
  font-weight: 600;
  color: #1976d2;
}

.manage-item-count {
  font-size: 13px;
  color: #666;
}

.btn-icon {
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  font-weight: 600;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.btn-edit {
  background: #ff9800;
  color: white;
}

.vehicle-manage-item {
  padding: 12px;
  background: #f5f5f5;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  margin-bottom: 8px;
}

.vehicle-manage-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.vehicle-manage-name {
  flex: 1;
  font-weight: 700;
  color: #1976d2;
}

.voice-btn {
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
  font-weight: 600;
  min-height: 44px;
  justify-content: center;
}

.voice-btn:hover {
  background: rgba(255, 255, 255, 0.3);
}

.voice-btn.listening {
  background: #f44336;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.signature-item {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border: 2px solid #90caf9;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
  transition: all 0.3s;
}

.signature-item:hover {
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
}

.signature-item-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.signature-item-title {
  font-size: 15px;
  font-weight: 700;
  color: #1976d2;
  display: flex;
  align-items: center;
  gap: 8px;
}

.signature-location {
  font-size: 12px;
  color: #42a5f5;
  font-weight: 600;
}

.signature-people {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  min-height: 36px;
  padding: 8px;
  background: rgba(25, 118, 210, 0.05);
  border-radius: 8px;
  border: 2px dashed #bbdefb;
  align-items: center;
}

.signature-tag {
  background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%);
  color: white;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 13px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.signature-tag .remove {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  cursor: pointer;
}

.signature-tag .remove:hover {
  background: rgba(255, 255, 255, 0.5);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 10px;
  background: #f5f5f5;
  border-radius: 8px;
  margin-bottom: 8px;
  transition: all 0.3s;
}

.checkbox-label:hover {
  background: #e3f2fd;
}

.checkbox-label input[type="checkbox"] {
  width: 24px;
  height: 24px;
  cursor: pointer;
}

/* å¤šæ—¥æ¨¡å¼æ¨™ç±¤ */
.multi-day-tabs {
  margin-top: 12px;
  padding: 10px 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.tabs-label {
  color: white;
  font-size: 13px;
  font-weight: 700;
  white-space: nowrap;
}

.date-tabs {
  flex: 1;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.date-tab {
  padding: 10px 16px;
  background: rgba(255, 255, 255, 0.15);
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 10px;
  color: white;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  min-height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.date-tab:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-1px);
}

.date-tab.active {
  background: rgba(255, 255, 255, 0.35);
  border-color: rgba(255, 255, 255, 0.8);
  font-weight: 700;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.exit-btn {
  padding: 6px 12px;
  background: rgba(255, 87, 87, 0.85);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}

.exit-btn:hover {
  background: rgba(255, 87, 87, 1);
  transform: scale(1.05);
}

.exit-btn:active {
  transform: scale(0.95);
}

@media (max-width: 768px) {
  .container {
    padding: 12px;
  }
  
  .duty-row {
    grid-template-columns: 60px 1fr;
    gap: 8px;
  }
  
  .duty-row .duty-slot:last-child {
    grid-column: 1 / -1;
  }
  
  .person-grid {
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 8px;
  }
  
  .footer {
    flex-direction: column;
    gap: 8px;
  }
  
  .footer-btn {
    padding: 16px;
    font-size: 16px;
  }
  
  .special-duty {
    grid-template-columns: 1fr;
  }
  
  .vehicle-field {
    grid-template-columns: 1fr;
  }
}

/* === iOS é¢¨æ ¼é è¦½å½ˆçª— === */
.ios-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  z-index: 10000;
  display: flex;
  align-items: flex-end;
  animation: iosFadeIn 0.3s ease;
}

.ios-modal {
  width: 100%;
  background: white;
  border-radius: 20px 20px 0 0;
  padding: 20px;
  padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  animation: iosSlideUp 0.3s ease;
}

.ios-modal-title {
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 16px;
  color: #333;
}

.ios-modal-content {
  background: #F5F5F5;
  padding: 16px;
  border-radius: 12px;
  max-height: 50vh;
  overflow-y: auto;
  margin-bottom: 16px;
  font-family: 'Courier New', 'Menlo', monospace;
  white-space: pre-wrap;
  line-height: 1.6;
  font-size: 14px;
  color: #333;
  -webkit-overflow-scrolling: touch;
}

.ios-btn-line {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #00B900 0%, #00E600 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  cursor: pointer;
  transition: transform 0.1s ease, opacity 0.2s ease;
  box-shadow: 0 2px 8px rgba(0, 185, 0, 0.3);
}

.ios-btn-copy {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #A1887F 0%, #BCAAA4 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 12px;
  cursor: pointer;
  transition: transform 0.1s ease, opacity 0.2s ease;
  box-shadow: 0 2px 8px rgba(161, 136, 127, 0.3);
}

.ios-btn-line:active,
.ios-btn-copy:active {
  transform: scale(0.98);
  opacity: 0.9;
}

.ios-btn-cancel {
  width: 100%;
  padding: 12px;
  background: transparent;
  color: #999;
  border: none;
  font-size: 14px;
  cursor: pointer;
  transition: opacity 0.2s ease;
}

.ios-btn-cancel:active {
  opacity: 0.6;
}

@keyframes iosFadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes iosSlideUp {
  from {
    transform: translateY(100%);
  }
  to {
    transform: translateY(0);
  }
}

@keyframes iosFadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

@keyframes iosSlideDown {
  from {
    transform: translateY(0);
  }
  to {
    transform: translateY(100%);
  }
}

/* æš—é»‘æ¨¡å¼ä¸‹çš„ iOS å½ˆçª— */
body.dark-mode .ios-modal {
  background: #2c3e50;
}

body.dark-mode .ios-modal-title {
  color: #e0e0e0;
}

body.dark-mode .ios-modal-content {
  background: #1a1f2e;
  color: #e0e0e0;
}

/* è¼‰å…¥ç•«é¢ */
#loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

#loading-screen.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(25, 118, 210, 0.2);
  border-top-color: #1976d2;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 20px;
  font-size: 16px;
  font-weight: 600;
  color: #1976d2;
}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">
    ğŸ“‹ å‹¤å‹™æ’ç­Pro
    <div style="display: flex; gap: 8px;">
      <button class="icon-btn theme-toggle" onclick="toggleTheme()" id="themeToggle" title="åˆ‡æ›ä¸»é¡Œ">
        <span id="themeIcon">ğŸŒ™</span>
      </button>
      <button class="icon-btn" onclick="openMultiDayPlanner()" title="å¤šæ—¥è¦åŠƒ">
        ğŸ“…
      </button>
      <button class="icon-btn" onclick="clearCache()" title="æ¸…é™¤æ’ç­è³‡æ–™">
        ğŸ—‘ï¸
      </button>
    </div>
  </div>

  <!-- éš±è—çš„åŸç”Ÿæ—¥æœŸè¼¸å…¥ -->
  <input type="date" class="date-input" id="dateInput">

  <!-- æ–°çš„æ—¥æœŸé¡¯ç¤ºUI -->
  <div class="date-section">
    <div class="date-display" id="dateDisplay" onclick="openDatePicker()">
      <span class="date-text" id="dateText">è¼‰å…¥ä¸­...</span>
      <span class="weekday-badge" id="weekdayBadge">-</span>
    </div>
    <div class="quick-date-nav">
      <button onclick="changeDate(-1)" title="å‰ä¸€å¤©">â—€</button>
      <button onclick="setToday()" title="å›åˆ°ä»Šå¤©">ä»Šå¤©</button>
      <button onclick="changeDate(1)" title="å¾Œä¸€å¤©">â–¶</button>
    </div>
  </div>

  <!-- å¤šæ—¥æ¨¡å¼æ¨™ç±¤ -->
  <div class="multi-day-tabs" id="dateTabsContainer" style="display: none;">
    <span class="tabs-label">ğŸ“… å¤šæ—¥æ¨¡å¼</span>
    <div class="date-tabs" id="dateTabs"></div>
    <button class="exit-btn" onclick="exitMultiDayMode()">âœ• é€€å‡º</button>
  </div>
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab(0)">ğŸ“… ä¸»é é¢</button>
    <button class="tab-btn" onclick="switchTab(1)">ğŸ‘¥ äººå“¡ç®¡ç†</button>
    <button class="tab-btn" onclick="switchTab(2)">ğŸ“ ç¯„æœ¬ç®¡ç†</button>
  </div>
</div>

<div class="container">
  <!-- Tab 1: ä¸»é é¢ -->
  <div class="tab-content active" id="tab0">
    <div class="section">
      <div class="section-title collapsible" onclick="toggleSection('leave')">
        <span>ğŸ–ï¸ ä¼‘å‡äººå“¡</span>
        <span class="section-arrow collapsed" id="arrow-leave">â–¼</span>
      </div>
      <div class="section-content collapsed" id="content-leave">
        <div class="leave-tags" id="leaveDisplay"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title collapsible" onclick="toggleSection('guard')">
        <span style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <span>â° è¼ªå€¼å‹¤å‹™</span>
          <button class="btn-sm" onclick="event.stopPropagation(); manageTimeSlots()">ç®¡ç†æ™‚æ®µ</button>
          <button class="btn-sm" onclick="event.stopPropagation(); adjustDutyTypes()">å‹¤å‹™é¡å‹</button>
        </span>
        <span class="section-arrow collapsed" id="arrow-guard">â–¼</span>
      </div>
      <div class="section-content collapsed" id="content-guard">
        <div class="duty-grid" id="guardDuties"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title collapsible" onclick="toggleSection('special')">
        <span style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <span>ğŸ“ ç‰¹æ®Šè·å‹™</span>
          <button class="btn-sm" onclick="event.stopPropagation(); manageSpecialDuties()">ç®¡ç†è·å‹™</button>
        </span>
        <span class="section-arrow collapsed" id="arrow-special">â–¼</span>
      </div>
      <div class="section-content collapsed" id="content-special">
        <div class="special-duties" id="specialDuties"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title collapsible" onclick="toggleSection('vehicle')">
        <span style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <span>ğŸš— è»Šè¼›èª¿åº¦</span>
          <button class="btn-sm" onclick="event.stopPropagation(); manageVehicles()">ç®¡ç†è»Šè¼›</button>
        </span>
        <span class="section-arrow collapsed" id="arrow-vehicle">â–¼</span>
      </div>
      <div class="section-content collapsed" id="content-vehicle">
        <div class="vehicle-list" id="vehicleList"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title collapsible" onclick="toggleSection('signature')">
        <span style="display: flex; align-items: center; gap: 8px; flex: 1;">
          <span>ğŸ“ å‹¤å‰ç°½åé …ç›®</span>
          <button class="btn-sm" onclick="event.stopPropagation(); manageSignatureItems()">ç®¡ç†é …ç›®</button>
        </span>
        <span class="section-arrow collapsed" id="arrow-signature">â–¼</span>
      </div>
      <div class="section-content collapsed" id="content-signature">
        <div style="font-size: 13px; color: #64b5f6; margin-bottom: 12px;">
          ï¼ˆæ­¤é …ç›®åƒ…ç”¨æ–¼ç”¢ç”Ÿç°½åæ¸…å–®ï¼Œä¸é¡¯ç¤ºåœ¨æ’ç­è¡¨ï¼‰
        </div>
        <div id="signatureItemsList"></div>
      </div>
    </div>
  </div>

  <!-- Tab 2: äººå“¡ç®¡ç† -->
  <div class="tab-content" id="tab1">
    <div class="section">
      <div class="section-title collapsible" onclick="toggleSection('addperson')">
        <span>æ–°å¢äººå“¡</span>
        <span class="section-arrow collapsed" id="arrow-addperson">â–¼</span>
      </div>
      <div class="section-content collapsed" id="content-addperson">
        <div class="input-group">
          <input type="text" class="input-text" id="newPersonName" placeholder="è¼¸å…¥å§“å">
          <button class="voice-btn" onclick="startVoiceInput('newPersonName')">ğŸ¤ èªéŸ³</button>
          <button class="btn-primary" onclick="addPerson()">â• æ–°å¢</button>
        </div>
        <div class="input-group">
          <input type="text" class="input-text" id="batchPersonNames" placeholder="æ‰¹æ¬¡æ–°å¢ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰">
          <button class="voice-btn" onclick="startVoiceInput('batchPersonNames')">ğŸ¤ èªéŸ³</button>
          <button class="btn-primary" onclick="batchAddPersons()">ğŸ“¥ æ‰¹æ¬¡æ–°å¢</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title collapsible" onclick="toggleSection('personlist')">
        <span>äººå“¡åˆ—è¡¨ï¼ˆå¯æ‹–æ›³åˆ°ä¸»é é¢ï¼‰</span>
        <span class="section-arrow" id="arrow-personlist">â–¼</span>
      </div>
      <div class="section-content" id="content-personlist">
        <div class="person-grid" id="personGrid"></div>
      </div>
    </div>
  </div>

  <!-- Tab 3: ç¯„æœ¬ç®¡ç† -->
  <div class="tab-content" id="tab2">
    <div class="section">
      <div class="section-title">å„²å­˜ç•¶å‰é…ç½®</div>
      <div class="input-group">
        <input type="text" class="input-text" id="templateName" placeholder="ç¯„æœ¬åç¨±ï¼ˆä¾‹å¦‚ï¼šæ¨™æº–é…ç½®ï¼‰">
        <button class="btn-primary" onclick="saveTemplate()">ğŸ’¾ å„²å­˜</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">æˆ‘çš„ç¯„æœ¬</div>
      <div class="template-list" id="templateList"></div>
    </div>
  </div>
</div>

<div class="footer">
  <button class="footer-btn btn-preview" onclick="preview()" style="flex: 1; background: linear-gradient(135deg, #FF9A56 0%, #FFD29D 100%);">
    ğŸ“‹ é è¦½æ’ç­è¡¨
  </button>
  <button class="footer-btn" onclick="previewSignature()" style="flex: 1; background: linear-gradient(135deg, #FF9A56 0%, #FFD29D 100%); color: white;">
    âœ… é è¦½ç°½åæ¸…å–®
  </button>
</div>

<div class="modal" id="modal" onclick="closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-title" id="modalTitle"></div>
    <div class="modal-content" id="modalContent"></div>
  </div>
</div>

<script>
// ========================================
// iOS é¢¨æ ¼é è¦½å½ˆçª—å‡½æ•¸
// ========================================

function showIOSPreview(title, content) {
  // ç§»é™¤èˆŠçš„å½ˆçª—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const existing = document.querySelector('.ios-modal-overlay');
  if (existing) existing.remove();

  // å‰µå»ºå½ˆçª—
  const overlay = document.createElement('div');
  overlay.className = 'ios-modal-overlay';

  const modal = document.createElement('div');
  modal.className = 'ios-modal';

  // è½‰ç¾©å…§å®¹ä¸­çš„ç‰¹æ®Šå­—ç¬¦
  const escapeContent = content.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$');

  modal.innerHTML = `
    <div class="ios-modal-title">${title}</div>
    <div class="ios-modal-content">${content}</div>
    <button class="ios-btn-line" onclick="shareToLINE(\`${escapeContent}\`)">
      ğŸ“¤ è½‰å‚³åˆ° LINE
    </button>
    <button class="ios-btn-copy" onclick="copyToClipboard(\`${escapeContent}\`); closeIOSModal();">
      ğŸ“‹ è¤‡è£½åˆ°å‰ªè²¼ç°¿
    </button>
    <button class="ios-btn-cancel" onclick="closeIOSModal()">å–æ¶ˆ</button>
  `;

  overlay.appendChild(modal);
  document.body.appendChild(overlay);

  // é»æ“ŠèƒŒæ™¯é—œé–‰
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      closeIOSModal();
    }
  });
}

function closeIOSModal() {
  const overlay = document.querySelector('.ios-modal-overlay');
  if (overlay) {
    overlay.style.animation = 'iosFadeOut 0.3s ease';
    const modal = overlay.querySelector('.ios-modal');
    if (modal) {
      modal.style.animation = 'iosSlideDown 0.3s ease';
    }
    setTimeout(() => overlay.remove(), 300);
  }
}

function shareToLINE(text) {
  const url = `line://msg/text/${encodeURIComponent(text)}`;
  window.location.href = url;
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
  }).catch(err => {
    console.error('è¤‡è£½å¤±æ•—:', err);
    alert('âŒ è¤‡è£½å¤±æ•—');
  });
}

// ========================================
// æ”¶åˆå€å¡Šæ§åˆ¶
// ========================================

function toggleSection(sectionId) {
  const content = document.getElementById(`content-${sectionId}`);
  const arrow = document.getElementById(`arrow-${sectionId}`);

  if (content && arrow) {
    const isCollapsed = content.classList.contains('collapsed');

    if (isCollapsed) {
      content.classList.remove('collapsed');
      arrow.classList.remove('collapsed');
    } else {
      content.classList.add('collapsed');
      arrow.classList.add('collapsed');
    }
  }
}

// ========================================
// åŸæœ‰ç¨‹å¼ç¢¼
// ========================================

let data = {
  personnel: [], // å°‡å¾ personnel_cache è¼‰å…¥
  onLeave: [], // æ ¼å¼ï¼š[{name: "ç‹å°æ˜", source: "auto"/"manual"}]
  guardSlots: ['22', '24', '02', '04', '06', '08', '10', '12', '14', '16', '18', '20'],
  dutyTypes: ['ğŸ›¡ï¸ å®‰å…¨å®ˆè­·ç¥', 'ğŸŒŠ æµ·æ´‹ä¹‹çœ¼'],  // ç•¶å‰ä½¿ç”¨çš„å‹¤å‹™é¡å‹
  dutyTypeTemplates: [
    { id: 'fun_default', name: 'è¶£å‘³æ¨™æº–é…ç½®', types: ['ğŸ›¡ï¸ å®‰å…¨å®ˆè­·ç¥', 'ğŸŒŠ æµ·æ´‹ä¹‹çœ¼'] }
  ],
  specialDuties: [
    { name: 'â­ æœ¬æ—¥æŒæ¬Šè€…', count: 1 },
    { name: 'ğŸŒŸ å‰¯æŒæ¬Šè€…', count: 1 },
    { name: 'ğŸ”« æ­¦å™¨ç®¡å®¶', count: 2 },
    { name: 'ğŸ“ è¬äº‹é€šå®¢æœ', count: 1 },
    { name: 'ğŸ³ ç¾é£Ÿé­”æ³•å¸«', count: 3 },
    { name: 'ğŸ§¹ æ¸…æ½”å¤§å¸«', count: 3 },
    { name: 'ğŸšª é–€ç¥', count: 2 },
    { name: 'ğŸš— ç–¾é¢¨è»ŠéšŠ', count: 2 }
  ],
  vehicles: [],
  assignments: {}, // ç•¶å‰æ—¥æœŸçš„æ’ç­ï¼ˆå‘ä¸‹å…¼å®¹ï¼‰
  signatureRequired: {},  // è¨˜éŒ„å“ªäº›å´—ä½éœ€è¦ç°½å
  templates: {},
  signatureItems: [
    { name: 'è¡›å“¨', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
    { name: 'è»Šå‹¤', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
    { name: 'æ´¾å·¥', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: false }
  ],
  signatureLocation: 'ä¸­å±±å®¤',  // ç°½ååœ°é»è‡ªè¨‚åç¨±
  // å¤šæ—¥æœŸæ”¯æ´
  assignmentsByDate: {}, // æ ¼å¼ï¼š{ '2024-10-24': { assignments, signatureRequired, signatureItems } }
  multiDayMode: false, // æ˜¯å¦ç‚ºå¤šæ—¥æ¨¡å¼
  selectedDates: [], // å¤šæ—¥æ¨¡å¼é¸ä¸­çš„æ—¥æœŸ
  currentDate: null // ç•¶å‰æŸ¥çœ‹çš„æ—¥æœŸ (YYYY-MM-DD)
};

let draggedPerson = null;
let draggedPersonIndex = null;
let draggedFromSlot = null; // è¨˜éŒ„æ‹–æ›³ä¾†æºæ ¼å­çš„ key
let draggedVehicleIndex = null; // è¨˜éŒ„è¢«æ‹–æ›³çš„è»Šè¼›ç´¢å¼•
let draggedSpecialDutyIndex = null; // è¨˜éŒ„è¢«æ‹–æ›³çš„ç‰¹æ®Šè·å‹™ç´¢å¼•
let currentSlot = null;
let recognition = null;
let currentVoiceInput = null;

// æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨ä¼‘å‡æœŸé–“å…§
function isDateInVacation(currentDate, vacationStart, vacationEnd) {
  if (!vacationStart || !vacationEnd) return false;

  // è§£æ MM/DD æ ¼å¼
  const parseDate = (dateStr) => {
    const [month, day] = dateStr.split('/').map(Number);
    return { month, day };
  };

  const current = {
    month: currentDate.getMonth() + 1,
    day: currentDate.getDate()
  };
  const start = parseDate(vacationStart);
  const end = parseDate(vacationEnd);

  // è™•ç†è·¨å¹´æƒ…æ³ï¼ˆä¾‹å¦‚ï¼š12/20 ~ 01/10ï¼‰
  if (start.month > end.month) {
    // è·¨å¹´ï¼šåœ¨é–‹å§‹æœˆä»½ä¹‹å¾Œï¼Œæˆ–åœ¨çµæŸæœˆä»½ä¹‹å‰
    return (current.month > start.month ||
            (current.month === start.month && current.day >= start.day) ||
            current.month < end.month ||
            (current.month === end.month && current.day <= end.day));
  } else {
    // åŒå¹´ï¼šåœ¨ç¯„åœå…§
    if (current.month < start.month || current.month > end.month) return false;
    if (current.month === start.month && current.day < start.day) return false;
    if (current.month === end.month && current.day > end.day) return false;
    return true;
  }
}

// è‡ªå‹•åŒæ­¥ä¼‘å‡ç‹€æ…‹
function autoSyncVacations() {
  const dateInput = document.getElementById('dateInput');
  const currentDate = dateInput.valueAsDate || new Date();

  // ç§»é™¤æ‰€æœ‰è‡ªå‹•åŒæ­¥çš„ä¼‘å‡æ¨™è¨˜
  data.onLeave = data.onLeave.filter(item => item.source === 'manual');

  // æª¢æŸ¥æ¯å€‹äººå“¡æ˜¯å¦åœ¨ä¼‘å‡æœŸé–“å…§
  data.personnel.forEach(person => {
    if (isDateInVacation(currentDate, person.vacationStart, person.vacationEnd)) {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ‰‹å‹•æ¨™è¨˜
      const existing = data.onLeave.find(item => item.name === person.name);
      if (!existing) {
        data.onLeave.push({ name: person.name, source: 'auto' });
      }
    }
  });

  save();
}

// Touch drag support for iOS using event delegation
let touchDragState = {
  element: null,
  startY: 0,
  currentY: 0,
  offsetY: 0,
  type: null,
  index: null
};

function initTouchDragDelegation() {
  // Single touchstart listener on document for all draggable elements
  document.addEventListener('touchstart', function(e) {
    const target = e.target.closest('.person-card, .signature-item');
    if (!target) return;

    touchDragState.element = target;
    touchDragState.startY = e.touches[0].clientY;
    touchDragState.index = parseInt(target.dataset.index);

    if (target.classList.contains('person-card')) {
      touchDragState.type = 'person';
    } else if (target.classList.contains('signature-item')) {
      touchDragState.type = 'signature';
    }

    target.style.opacity = '0.7';
    target.style.transform = 'scale(1.05)';
  }, { passive: false });

  // Single touchmove listener
  document.addEventListener('touchmove', function(e) {
    if (!touchDragState.element) return;

    e.preventDefault();
    const touch = e.touches[0];
    touchDragState.currentY = touch.clientY;
    touchDragState.offsetY = touchDragState.currentY - touchDragState.startY;

    touchDragState.element.style.transform = `translateY(${touchDragState.offsetY}px) scale(1.05)`;

    // Clear previous highlights
    document.querySelectorAll('.person-card, .signature-item').forEach(el => {
      if (el !== touchDragState.element) el.style.borderTop = '';
    });

    // Find and highlight drop target
    const elementsBelow = document.elementsFromPoint(touch.clientX, touch.clientY);
    const dropTarget = elementsBelow.find(el =>
      (el.classList.contains('person-card') || el.classList.contains('signature-item')) && el !== touchDragState.element
    );

    if (dropTarget) {
      dropTarget.style.borderTop = '3px solid #2196F3';
    }
  }, { passive: false });

  // Single touchend listener
  document.addEventListener('touchend', function(e) {
    if (!touchDragState.element) return;

    const touch = e.changedTouches[0];
    const elementsBelow = document.elementsFromPoint(touch.clientX, touch.clientY);
    const dropTarget = elementsBelow.find(el =>
      (el.classList.contains('person-card') || el.classList.contains('signature-item')) && el !== touchDragState.element
    );

    // Reset styles
    touchDragState.element.style.opacity = '';
    touchDragState.element.style.transform = '';
    document.querySelectorAll('.person-card, .signature-item').forEach(el => {
      el.style.borderTop = '';
    });

    if (dropTarget) {
      const dropIndex = parseInt(dropTarget.dataset.index);
      const dragIndex = touchDragState.index;

      if (dragIndex !== dropIndex && !isNaN(dragIndex) && !isNaN(dropIndex)) {
        if (touchDragState.type === 'person' && dragIndex >= 0 && dragIndex < data.personnel.length) {
          const person = data.personnel.splice(dragIndex, 1)[0];
          data.personnel.splice(dropIndex, 0, person);
          save();
          render();
        } else if (touchDragState.type === 'signature' && dragIndex >= 0 && dragIndex < data.signatureItems.length) {
          const item = data.signatureItems.splice(dragIndex, 1)[0];
          data.signatureItems.splice(dropIndex, 0, item);
          save();
          render();
        }
      }
    }

    touchDragState = { element: null, startY: 0, currentY: 0, offsetY: 0, type: null, index: null };
  }, { passive: false });

  // Handle touch cancel
  document.addEventListener('touchcancel', function(e) {
    if (touchDragState.element) {
      touchDragState.element.style.opacity = '';
      touchDragState.element.style.transform = '';
      document.querySelectorAll('.person-card, .signature-item').forEach(el => {
        el.style.borderTop = '';
      });
    }
    touchDragState = { element: null, startY: 0, currentY: 0, offsetY: 0, type: null, index: null };
  }, { passive: false });
}

// Storage fallback for iOS private mode
let memoryStorage = {};
let storageAvailable = true;

function testStorage() {
  try {
    const test = '__storage_test__';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch(e) {
    console.warn('localStorage not available, using memory storage fallback');
    return false;
  }
}

function getItem(key) {
  if (storageAvailable) {
    return localStorage.getItem(key);
  }
  return memoryStorage[key] || null;
}

function setItem(key, value) {
  if (storageAvailable) {
    localStorage.setItem(key, value);
  } else {
    memoryStorage[key] = value;
  }
}

function init() {
  // Check storage availability
  storageAvailable = testStorage();
  if (!storageAvailable) {
    alert('âš ï¸ åµæ¸¬åˆ°ç§å¯†ç€è¦½æ¨¡å¼ï¼Œè³‡æ–™å°‡æš«å­˜æ–¼è¨˜æ†¶é«”ä¸­ï¼Œé—œé–‰åˆ†é å¾Œå°‡æœƒéºå¤±');
  }

  // å¾ personnel_cache è¼‰å…¥å®Œæ•´äººå“¡ç‰©ä»¶ï¼Œä¸¦ç¯©é¸é©ç”¨æ–¼æœ¬ç³»çµ±çš„äººå“¡
  const personnelCache = getItem('personnel_cache');
  if (personnelCache) {
    const allPersonnel = JSON.parse(personnelCache);
    data.personnel = allPersonnel.filter(p => p.systems && p.systems.includes('service'));
  }

  const saved = getItem('duty_pro_v2_data');
  if (saved) {
    const savedData = JSON.parse(saved);
    // åªè¼‰å…¥æ¥­å‹™è³‡æ–™ï¼Œä¸è¼‰å…¥ personnelï¼ˆå·²å¾ cache è¼‰å…¥ï¼‰
    data.onLeave = savedData.onLeave || [];
    data.guardSlots = savedData.guardSlots || data.guardSlots;
    data.dutyTypes = savedData.dutyTypes || data.dutyTypes;
    data.specialDuties = savedData.specialDuties || data.specialDuties;
    data.vehicles = savedData.vehicles || data.vehicles;
    data.assignments = savedData.assignments || {};
    data.signatureRequired = savedData.signatureRequired || {};
    data.templates = savedData.templates || {};
    data.signatureItems = savedData.signatureItems || data.signatureItems;
    // å¤šæ—¥æ•¸æ“š
    data.assignmentsByDate = savedData.assignmentsByDate || {};
    data.multiDayMode = savedData.multiDayMode || false;
    data.selectedDates = savedData.selectedDates || [];
    data.currentDate = savedData.currentDate || null;
  }

  // æ¢å¾©å¤šæ—¥æ¨¡å¼ç‹€æ…‹
  if (data.multiDayMode && data.currentDate) {
    document.getElementById('dateTabsContainer').style.display = 'block';
    loadDateData(data.currentDate);
    setTimeout(() => renderDateTabs(), 100);
  }

  // è½‰æ›èˆŠæ ¼å¼çš„ onLeaveï¼ˆå­—ä¸²é™£åˆ—ï¼‰ç‚ºæ–°æ ¼å¼ï¼ˆç‰©ä»¶é™£åˆ—ï¼‰
  if (data.onLeave.length > 0 && typeof data.onLeave[0] === 'string') {
    data.onLeave = data.onLeave.map(name => ({ name, source: 'manual' }));
  }

  // é·ç§» signatureItems è‡³æ–°æ ¼å¼ï¼ˆåŠ å…¥è¡›å“¨ã€è»Šå‹¤è‡ªå‹•åŒæ­¥é …ç›®ï¼‰
  function migrateSignatureItems(items) {
    if (!items || items.length === 0) {
      // å¦‚æœæ²’æœ‰é …ç›®ï¼Œè¿”å›ä¸‰å€‹é è¨­é …ç›®
      return [
        { name: 'è¡›å“¨', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
        { name: 'è»Šå‹¤', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
        { name: 'æ´¾å·¥', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: false }
      ];
    }

    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ–°æ ¼å¼ï¼ˆæœ‰ isAuto å±¬æ€§ï¼‰
    const hasNewFormat = items.some(item => item.hasOwnProperty('isAuto'));
    if (hasNewFormat) {
      // å·²ç¶“æ˜¯æ–°æ ¼å¼ï¼Œä½†è¦ç¢ºä¿æœ‰è¡›å“¨å’Œè»Šå‹¤
      const hasGuard = items.some(item => item.name === 'è¡›å“¨');
      const hasVehicle = items.some(item => item.name === 'è»Šå‹¤');

      const newItems = [...items];
      if (!hasGuard) {
        newItems.unshift({ name: 'è¡›å“¨', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true });
      }
      if (!hasVehicle) {
        const guardIndex = newItems.findIndex(item => item.name === 'è¡›å“¨');
        newItems.splice(guardIndex + 1, 0, { name: 'è»Šå‹¤', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true });
      }
      return newItems;
    }

    // èˆŠæ ¼å¼ï¼Œéœ€è¦é·ç§»
    // ä¿ç•™èˆŠçš„æ´¾å·¥å’Œå…¶ä»–è‡ªè¨‚é …ç›®ï¼ŒåŠ ä¸Šè¡›å“¨å’Œè»Šå‹¤
    const migratedItems = [
      { name: 'è¡›å“¨', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
      { name: 'è»Šå‹¤', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true }
    ];

    // ä¿ç•™èˆŠçš„é …ç›®ï¼ŒåŠ ä¸Š isAuto: false
    items.forEach(item => {
      migratedItems.push({
        ...item,
        isAuto: false,
        isDefault: item.name === 'æ´¾å·¥'
      });
    });

    return migratedItems;
  }

  // é·ç§»ç•¶å‰çš„ signatureItems
  data.signatureItems = migrateSignatureItems(data.signatureItems);

  // é·ç§»æ‰€æœ‰æ—¥æœŸçš„ signatureItems
  Object.keys(data.assignmentsByDate).forEach(dateStr => {
    if (data.assignmentsByDate[dateStr].signatureItems) {
      data.assignmentsByDate[dateStr].signatureItems = migrateSignatureItems(data.assignmentsByDate[dateStr].signatureItems);
    }
  });

  document.getElementById('dateInput').valueAsDate = new Date();

  // åŸ·è¡Œè‡ªå‹•åŒæ­¥ (æš«æ™‚åœç”¨ä»¥ä¿®å¾©æ‰‹æ©Ÿè¼‰å…¥å•é¡Œ)
  // setTimeout(() => autoSyncVacations(), 1000);

  const savedTheme = getItem('duty_pro_theme');
  if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.body.classList.add('dark-mode');
    document.getElementById('themeIcon').textContent = 'â˜€ï¸';
    document.getElementById('themeText').textContent = 'äº®è‰²';
  }

  initVoiceRecognition();

  // æ—¥æœŸæ”¹è®Šæ™‚é‡æ–°åŒæ­¥ä¼‘å‡
  document.getElementById('dateInput').addEventListener('change', () => {
    // autoSyncVacations(); // æš«æ™‚åœç”¨
    updateDateDisplay();
    render();
  });

  // åˆå§‹åŒ–æ—¥æœŸé¡¯ç¤º
  updateDateDisplay();

  // å»¶é²æ¸²æŸ“,çµ¦æ‰‹æ©Ÿæ›´å¤šæ™‚é–“æº–å‚™
  setTimeout(() => render(), 500);

  // Soft keyboard handling - auto scroll to input on focus
  document.addEventListener('focusin', (e) => {
    if (e.target.matches('input, textarea, select')) {
      setTimeout(() => {
        e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 300); // Wait for keyboard animation
    }
  });

  // Initialize touch drag delegation for mobile (prevents memory leak)
  initTouchDragDelegation();
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  setItem('duty_pro_theme', isDark ? 'dark' : 'light');
}

function clearCache() {
  if (confirm('ğŸ—‘ï¸ æ¸…é™¤æ’ç­è³‡æ–™\n\nç¢ºå®šè¦æ¸…é™¤ç•¶å‰çš„å€¼ç­è¡¨è³‡æ–™å—?\n\nâš ï¸ æ­¤æ“ä½œæœƒæ¸…ç©ºæ‰€æœ‰æ’ç­å…§å®¹,ä½†äººå“¡åå–®æœƒä¿ç•™ã€‚')) {
    if (confirm('âš ï¸ å†æ¬¡ç¢ºèª\n\næ¸…é™¤å¾Œç„¡æ³•å¾©åŸ,ç¢ºå®šç¹¼çºŒå—?')) {
      localStorage.removeItem('duty_pro_v2_data');
      alert('âœ… å·²æ¸…é™¤æ’ç­è³‡æ–™!\n\né é¢å³å°‡é‡æ–°è¼‰å…¥');
      location.reload();
    }
  }
}

// === æ—¥æœŸUIç›¸é—œå‡½æ•¸ ===

function updateDateDisplay() {
  const dateInput = document.getElementById('dateInput');
  const date = dateInput.valueAsDate || new Date();
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const weekday = weekdays[date.getDay()];

  document.getElementById('dateText').textContent = `${month}æœˆ${day}æ—¥`;
  document.getElementById('weekdayBadge').textContent = `é€±${weekday}`;
}

function openDatePicker() {
  // è§¸ç™¼åŸç”Ÿæ—¥æœŸé¸æ“‡å™¨
  document.getElementById('dateInput').showPicker();
}

function changeDate(offset) {
  const dateInput = document.getElementById('dateInput');
  const currentDate = dateInput.valueAsDate || new Date();
  currentDate.setDate(currentDate.getDate() + offset);
  dateInput.valueAsDate = currentDate;

  // è§¸ç™¼ change äº‹ä»¶
  dateInput.dispatchEvent(new Event('change'));
  updateDateDisplay();
}

function setToday() {
  const dateInput = document.getElementById('dateInput');
  dateInput.valueAsDate = new Date();

  // è§¸ç™¼ change äº‹ä»¶
  dateInput.dispatchEvent(new Event('change'));
  updateDateDisplay();
}

// === å¤šæ—¥è¦åŠƒåŠŸèƒ½ ===

function openMultiDayPlanner() {
  const html = `
    <div style="margin-bottom: 16px;">
      <div style="font-size: 16px; font-weight: 700; color: #1976d2; margin-bottom: 12px;">é¸æ“‡æ—¥æœŸï¼ˆæœ€å¤š7å¤©ï¼‰</div>
      <div style="font-size: 13px; color: #666; margin-bottom: 12px;">ğŸ’¡ é»æ“Šæ—¥æœŸé¸æ“‡/å–æ¶ˆï¼Œå¯é¸æ“‡ä¸é€£çºŒçš„æ—¥æœŸ</div>
      <div id="dateSelector" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 16px;"></div>
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <button class="btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="quickSelectDates(3)">æœªä¾†3å¤©</button>
        <button class="btn-primary" style="padding: 8px 16px; font-size: 13px;" onclick="quickSelectDates(7)">æœªä¾†7å¤©</button>
      </div>
      <div style="font-size: 13px; color: #1976d2; font-weight: 600;">å·²é¸ï¼š<span id="selectedDatesDisplay">ç„¡</span></div>
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="startMultiDayMode()">âœ… é–‹å§‹å¤šæ—¥è¦åŠƒ</button>
  `;
  showModal('ğŸ“… å¤šæ—¥è¦åŠƒ', html);
  renderDateSelector();
}

function renderDateSelector() {
  const container = document.getElementById('dateSelector');
  if (!container) return;

  const today = new Date();
  const dates = [];
  for (let i = 0; i < 14; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    dates.push(date);
  }

  const tempSelected = window.tempSelectedDates || [];

  const html = dates.map(date => {
    const dateStr = date.toISOString().split('T')[0];
    const isSelected = tempSelected.includes(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekday = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];

    return `
      <div onclick="toggleDateSelection('${dateStr}')" style="
        padding: 8px;
        border: 2px solid ${isSelected ? '#1976d2' : '#ccc'};
        background: ${isSelected ? '#e3f2fd' : 'white'};
        border-radius: 8px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        ${isSelected ? 'box-shadow: 0 2px 8px rgba(25,118,210,0.3);' : ''}
      ">
        <div style="font-size: 11px; color: #666;">${month}/${day}</div>
        <div style="font-size: 10px; color: #999;">é€±${weekday}</div>
      </div>
    `;
  }).join('');

  container.innerHTML = html;
}

function toggleDateSelection(dateStr) {
  if (!window.tempSelectedDates) window.tempSelectedDates = [];

  const index = window.tempSelectedDates.indexOf(dateStr);
  if (index > -1) {
    window.tempSelectedDates.splice(index, 1);
  } else {
    if (window.tempSelectedDates.length >= 7) {
      alert('æœ€å¤šåªèƒ½é¸æ“‡7å¤©');
      return;
    }
    window.tempSelectedDates.push(dateStr);
  }

  // æ’åº
  window.tempSelectedDates.sort();

  renderDateSelector();
  updateSelectedDatesDisplay();
}

function quickSelectDates(days) {
  const today = new Date();
  window.tempSelectedDates = [];

  for (let i = 0; i < days; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() + i);
    window.tempSelectedDates.push(date.toISOString().split('T')[0]);
  }

  renderDateSelector();
  updateSelectedDatesDisplay();
}

function updateSelectedDatesDisplay() {
  const display = document.getElementById('selectedDatesDisplay');
  if (!display) return;

  if (!window.tempSelectedDates || window.tempSelectedDates.length === 0) {
    display.textContent = 'ç„¡';
    return;
  }

  const formatted = window.tempSelectedDates.map(d => {
    const date = new Date(d + 'T00:00:00');
    return `${date.getMonth() + 1}/${date.getDate()}`;
  }).join(', ');

  display.textContent = formatted;
}

function startMultiDayMode() {
  if (!window.tempSelectedDates || window.tempSelectedDates.length === 0) {
    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ');
    return;
  }

  data.selectedDates = [...window.tempSelectedDates];
  data.multiDayMode = true;
  data.currentDate = data.selectedDates[0];

  // åˆå§‹åŒ–æ¯å€‹æ—¥æœŸçš„æ•¸æ“š
  data.selectedDates.forEach(dateStr => {
    if (!data.assignmentsByDate[dateStr]) {
      data.assignmentsByDate[dateStr] = {
        assignments: {},
        signatureRequired: {},
        signatureItems: [
          { name: 'è¡›å“¨', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
          { name: 'è»Šå‹¤', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
          { name: 'æ´¾å·¥', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: false }
        ]
      };
    }
  });

  // è¼‰å…¥ç•¶å‰æ—¥æœŸçš„æ’ç­
  loadDateData(data.currentDate);

  // æ›´æ–°UI
  document.getElementById('dateTabsContainer').style.display = 'block';
  renderDateTabs();

  window.tempSelectedDates = [];
  closeModal();
  save();
  render();
}

function renderDateTabs() {
  const container = document.getElementById('dateTabs');
  if (!container || !data.multiDayMode) return;

  const html = data.selectedDates.map(dateStr => {
    const date = new Date(dateStr + 'T00:00:00');
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const weekday = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][date.getDay()];
    const isActive = dateStr === data.currentDate;

    return `
      <button class="date-tab ${isActive ? 'active' : ''}" onclick="switchToDate('${dateStr}')">
        ${month}/${day} é€±${weekday}
      </button>
    `;
  }).join('');

  container.innerHTML = html;
}

function switchToDate(dateStr) {
  if (!data.multiDayMode) return;

  // ä¿å­˜ç•¶å‰æ—¥æœŸçš„æ•¸æ“š
  saveDateData(data.currentDate);

  // åˆ‡æ›åˆ°æ–°æ—¥æœŸ
  data.currentDate = dateStr;

  // è¼‰å…¥æ–°æ—¥æœŸçš„æ•¸æ“š
  loadDateData(dateStr);

  // æ›´æ–°éš±è—çš„æ—¥æœŸè¼¸å…¥æ¡†
  document.getElementById('dateInput').value = dateStr;

  // æ›´æ–°æ—¥æœŸé¡¯ç¤º
  updateDateDisplay();

  // æ›´æ–°UI
  renderDateTabs();
  render();
}

function saveDateData(dateStr) {
  if (!dateStr) return;

  data.assignmentsByDate[dateStr] = {
    assignments: { ...data.assignments },
    signatureRequired: { ...data.signatureRequired },
    signatureItems: JSON.parse(JSON.stringify(data.signatureItems))
  };
}

function loadDateData(dateStr) {
  if (!dateStr || !data.assignmentsByDate[dateStr]) return;

  const dateData = data.assignmentsByDate[dateStr];
  data.assignments = { ...dateData.assignments };
  data.signatureRequired = { ...dateData.signatureRequired };
  data.signatureItems = JSON.parse(JSON.stringify(dateData.signatureItems));
}

function exitMultiDayMode() {
  if (!confirm('ç¢ºå®šè¦é€€å‡ºå¤šæ—¥æ¨¡å¼å—ï¼Ÿå·²è¦åŠƒçš„æ’ç­æœƒä¿ç•™ã€‚')) return;

  // ä¿å­˜ç•¶å‰æ•¸æ“š
  if (data.currentDate) {
    saveDateData(data.currentDate);
  }

  data.multiDayMode = false;
  data.currentDate = null;

  // æ¸…é™¤ç•¶å‰å–®æ—¥æ’ç­
  data.assignments = {};
  data.signatureRequired = {};
  data.signatureItems = [
    { name: 'è¡›å“¨', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
    { name: 'è»Šå‹¤', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: true },
    { name: 'æ´¾å·¥', location: 'ä¸­å±±å®¤', people: [], enabled: true, isDefault: true, isAuto: false }
  ];

  document.getElementById('dateTabsContainer').style.display = 'none';

  save();
  render();
}

function initVoiceRecognition() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'zh-TW';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      if (currentVoiceInput) {
        const input = document.getElementById(currentVoiceInput);
        if (input) {
          input.value = input.value ? input.value + ',' + transcript : transcript;
        }
      }
      stopVoiceInput();
    };
    
    recognition.onerror = (event) => {
      console.error('èªéŸ³è­˜åˆ¥éŒ¯èª¤:', event.error);
      stopVoiceInput();
      if (event.error === 'no-speech') {
        alert('æ²’æœ‰åµæ¸¬åˆ°èªéŸ³ï¼Œè«‹å†è©¦ä¸€æ¬¡');
      } else if (event.error === 'not-allowed') {
        alert('è«‹å…è¨±ä½¿ç”¨éº¥å…‹é¢¨æ¬Šé™');
      }
    };
    
    recognition.onend = () => {
      stopVoiceInput();
    };
  }
}

function startVoiceInput(inputId) {
  if (!recognition) {
    alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
    return;
  }
  
  currentVoiceInput = inputId;
  const btn = event.target;
  btn.classList.add('listening');
  btn.textContent = 'ğŸ¤ è†è½ä¸­...';
  
  try {
    recognition.start();
  } catch (e) {
    console.error('èªéŸ³è­˜åˆ¥å•Ÿå‹•å¤±æ•—:', e);
    stopVoiceInput();
  }
}

function stopVoiceInput() {
  if (recognition) {
    try {
      recognition.stop();
    } catch (e) {
      console.error('åœæ­¢èªéŸ³è­˜åˆ¥å¤±æ•—:', e);
    }
  }
  
  document.querySelectorAll('.voice-btn').forEach(btn => {
    btn.classList.remove('listening');
    btn.textContent = 'ğŸ¤ èªéŸ³';
  });
  
  currentVoiceInput = null;
}

// å–å¾—äººå“¡é¡¯ç¤ºåç¨±ï¼ˆå…¨åæˆ–æš±ç¨±ï¼‰
function getPersonDisplayName(person, systemName) {
  // systemName: 'service', 'task', 'vacation'
  if (!person) return '';

  // å¦‚æœæ²’æœ‰è¨­å®šé¡¯ç¤ºåå¥½ï¼Œé è¨­é¡¯ç¤ºå…¨å
  if (!person.displayPreference || !person.displayPreference[systemName]) {
    return person.name;
  }

  // å¦‚æœè¨­å®šç‚ºé¡¯ç¤ºæš±ç¨±ï¼Œä½†æš±ç¨±ç‚ºç©ºï¼Œå‰‡é¡¯ç¤ºå…¨å
  if (person.displayPreference[systemName] === 'nickname') {
    return person.nickname || person.name;
  }

  // é è¨­é¡¯ç¤ºå…¨å
  return person.name;
}

let saveTimer = null;

function save() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    try {
      setItem('duty_pro_v2_data', JSON.stringify(data));
    } catch (e) {
      if (e.name === 'QuotaExceededError') {
        alert('å„²å­˜ç©ºé–“ä¸è¶³ï¼Œè«‹æ¸…ç†èˆŠè³‡æ–™æˆ–åŒ¯å‡ºå‚™ä»½');
      }
      console.error('Save failed:', e);
    }
  }, 300);
}

function switchTab(index) {
  document.querySelectorAll('.tab-btn').forEach((btn, i) => {
    btn.classList.toggle('active', i === index);
  });
  document.querySelectorAll('.tab-content').forEach((content, i) => {
    content.classList.toggle('active', i === index);
  });
}

function render() {
  renderLeaveDisplay();
  renderGuardDuties();
  renderSpecialDuties();
  renderVehicles();
  renderPersonGrid();
  renderTemplates();
  renderSignatureItems();

  // Update data-index attributes for touch drag
  setTimeout(() => {
    document.querySelectorAll('.person-card').forEach((el, idx) => {
      el.dataset.index = idx;
    });
    document.querySelectorAll('.signature-item').forEach((el, idx) => {
      el.dataset.index = idx;
    });
  }, 50);
}

function renderLeaveDisplay() {
  const html = data.onLeave.length > 0
    ? data.onLeave.map(item => {
        const icon = item.source === 'auto' ? 'ğŸ”„' : 'âœ‹';
        const title = item.source === 'auto' ? 'è‡ªå‹•åŒæ­¥' : 'è‡¨æ™‚æ¨™è¨˜';
        return `<div class="leave-tag" title="${title}">${icon} ${item.name}</div>`;
      }).join('')
    : '<div class="empty-hint">ç„¡ä¼‘å‡äººå“¡</div>';
  document.getElementById('leaveDisplay').innerHTML = html;
}

function renderGuardDuties() {
  const html = data.guardSlots.map(time => {
    const dutySlots = data.dutyTypes.map((dutyType, idx) => {
      const key = `guard_${time}_${dutyType}_${idx}`;
      const personName = data.assignments[key] || '';
      const needsSignature = data.signatureRequired?.[key] || false;

      if (personName) {
        const personObj = data.personnel.find(p => p.name === personName);
        const displayName = personObj ? getPersonDisplayName(personObj, 'service') : personName;
        return `
          <div class="duty-slot filled" draggable="true" ondragstart="startDragSlot(event, '${key}', '${personName}')" ondragover="allowDrop(event)" ondrop="dropOnSlot(event, '${key}')" ondragend="endDragSlot(event)" style="display: flex; flex-direction: column; gap: 6px; padding: 10px; cursor: move;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span onclick="selectSlot('${key}')" style="cursor: pointer; flex: 1;">${displayName}</span>
              <button class="slot-clear" onclick="clearSlot('${key}', event)">âœ•</button>
            </div>
            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;" onclick="event.stopPropagation();">
              <input type="checkbox" ${needsSignature ? 'checked' : ''} onchange="toggleSignatureRequired('${key}')" style="cursor: pointer;">
              <span style="color: #64b5f6;">éœ€ç°½å</span>
            </label>
          </div>
        `;
      } else {
        return `
          <div class="duty-slot" onclick="selectSlot('${key}')" ondragover="allowDrop(event)" ondrop="dropOnSlot(event, '${key}')" ondragleave="dragLeave(event)">
            ${dutyType}
          </div>
        `;
      }
    }).join('');

    return `
      <div class="duty-row">
        <div class="time-label">${time}:00</div>
        ${dutySlots}
      </div>
    `;
  }).join('');

  document.getElementById('guardDuties').innerHTML = html;
}

function renderSpecialDuties() {
  const html = data.specialDuties.map((duty, dutyIdx) => {
    const slots = [];
    for (let i = 0; i < duty.count; i++) {
      const key = `special_${duty.name}_${i}`;
      const personName = data.assignments[key] || '';
      const needsSignature = data.signatureRequired?.[key] || false;

      if (personName) {
        const personObj = data.personnel.find(p => p.name === personName);
        const displayName = personObj ? getPersonDisplayName(personObj, 'service') : personName;
        slots.push(`
          <div class="duty-slot filled" draggable="true" ondragstart="startDragSlot(event, '${key}', '${personName}')" ondragover="allowDrop(event)" ondrop="dropOnSlot(event, '${key}')" ondragend="endDragSlot(event)" style="padding: 10px; cursor: move;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span onclick="selectSlot('${key}')" style="cursor: pointer; flex: 1;">${displayName}</span>
              <button class="slot-clear" onclick="clearSlot('${key}', event)">âœ•</button>
            </div>
          </div>
        `);
      } else {
        slots.push(`
          <div class="duty-slot" onclick="selectSlot('${key}')" ondragover="allowDrop(event)" ondrop="dropOnSlot(event, '${key}')" ondragleave="dragLeave(event)">
            é»æ“Šé¸äºº
          </div>
        `);
      }
    }

    return `
      <div class="special-duty" draggable="true"
           ondragstart="dragSpecialDutyStart(event, ${dutyIdx})"
           ondragend="dragSpecialDutyEnd(event)"
           ondragover="dragSpecialDutyOver(event)"
           ondragleave="dragSpecialDutyLeave(event)"
           ondrop="dropSpecialDutyReorder(event, ${dutyIdx})">
        <div class="duty-name">${duty.name}</div>
        <div class="duty-slots-row">${slots.join('')}</div>
      </div>
    `;
  }).join('');
  document.getElementById('specialDuties').innerHTML = html;
}

function renderVehicles() {
  const html = data.vehicles.filter(v => v.enabled).map((vehicle, idx) => {
    // å–å¾—åœ¨ data.vehicles ä¸­çš„åŸå§‹ç´¢å¼•
    const originalIndex = data.vehicles.findIndex(v => v.id === vehicle.id);

    const timeKey = `vehicle_${vehicle.id}_time`;
    const missionKey = `vehicle_${vehicle.id}_mission`;
    const vehicleTime = data.assignments[timeKey] || vehicle.time;
    const vehicleMission = data.assignments[missionKey] || vehicle.mission;

    const roleSlots = vehicle.roles.map(role => {
      const key = `vehicle_${vehicle.id}_${role}`;
      const personName = data.assignments[key] || '';
      const needsSignature = data.signatureRequired?.[key] || false;

      if (personName) {
        const personObj = data.personnel.find(p => p.name === personName);
        const displayName = personName; // è»Šè¼›æ´¾é£å›ºå®šé¡¯ç¤ºå…¨å
        return `
          <div class="vehicle-field">
            <div class="field-label">${role}ï¼š</div>
            <div class="duty-slot filled" draggable="true" ondragstart="startDragSlot(event, '${key}', '${personName}')" ondragover="allowDrop(event)" ondrop="dropOnSlot(event, '${key}')" ondragend="endDragSlot(event)" style="display: flex; flex-direction: column; gap: 6px; padding: 10px; cursor: move;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span onclick="selectSlot('${key}')" style="cursor: pointer; flex: 1;">${displayName}</span>
                <button class="slot-clear" onclick="clearSlot('${key}', event)">âœ•</button>
              </div>
              <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; cursor: pointer;" onclick="event.stopPropagation();">
                <input type="checkbox" ${needsSignature ? 'checked' : ''} onchange="toggleSignatureRequired('${key}')" style="cursor: pointer;">
                <span style="color: #64b5f6;">éœ€ç°½å</span>
              </label>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="vehicle-field">
            <div class="field-label">${role}ï¼š</div>
            <div class="duty-slot" onclick="selectSlot('${key}')" ondragover="allowDrop(event)" ondrop="dropOnSlot(event, '${key}')" ondragleave="dragLeave(event)">
              é»æ“Šé¸äºº
            </div>
          </div>
        `;
      }
    }).join('');
    
    return `
      <div class="vehicle-item active" draggable="true"
           ondragstart="dragVehicleStart(event, ${originalIndex})"
           ondragend="dragVehicleEnd(event)"
           ondragover="dragVehicleOver(event)"
           ondrop="dropVehicleReorder(event, ${originalIndex})"
           ondragleave="dragVehicleLeave(event)"
           style="cursor: move;">
        <div class="vehicle-header">
          <div class="vehicle-name">â—${vehicle.name}</div>
        </div>
        <div class="vehicle-info">
          <div class="vehicle-field">
            <div class="field-label">æ™‚é–“ï¼š</div>
            <input type="text" class="field-input" value="${vehicleTime}" onchange="updateVehicleInfo('${timeKey}', this.value)">
          </div>
          <div class="vehicle-field">
            <div class="field-label">ä»»å‹™ï¼š</div>
            <input type="text" class="field-input" value="${vehicleMission}" onchange="updateVehicleInfo('${missionKey}', this.value)">
          </div>
          ${roleSlots}
        </div>
      </div>
    `;
  }).join('');
  document.getElementById('vehicleList').innerHTML = html || '<div class="empty-hint">è«‹å…ˆå•Ÿç”¨è»Šè¼›</div>';
}

function renderPersonGrid() {
  const onLeaveNames = data.onLeave.map(item => item.name);
  const html = data.personnel.map((p, i) => {
    const displayName = getPersonDisplayName(p, 'service');
    return `
    <div class="person-card ${onLeaveNames.includes(p.name) ? 'on-leave' : ''}" draggable="true"
         ondragstart="dragPersonStart(event, '${p.name}'); dragPersonReorderStart(event, ${i})"
         ondragend="dragPersonEnd(event); dragPersonReorderEnd(event)"
         ondragover="dragPersonReorderOver(event)"
         ondrop="dropPersonReorder(event, ${i})"
         ondragleave="dragPersonReorderLeave(event)">
      <div class="person-name">${displayName}</div>
      <div class="person-actions">
        <button class="person-action-btn" style="background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%); width: 100%;" onclick="showPersonMenu(event, ${i})">âš™ï¸ ç®¡ç†</button>
      </div>
    </div>
  `;
  }).join('');
  document.getElementById('personGrid').innerHTML = html;
}

function showPersonMenu(event, index) {
  event.stopPropagation();
  const person = data.personnel[index];
  const onLeaveNames = data.onLeave.map(item => item.name);
  const isOnLeave = onLeaveNames.includes(person.name);
  const leaveItem = data.onLeave.find(item => item.name === person.name);

  // ç§»é™¤ç¾æœ‰é¸å–®
  const existingMenu = document.getElementById('personContextMenu');
  if (existingMenu) existingMenu.remove();

  // å‰µå»ºé¸å–®
  const menu = document.createElement('div');
  menu.id = 'personContextMenu';
  menu.style.cssText = `
    position: fixed;
    background: white;
    border: 2px solid #1976d2;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(25, 118, 210, 0.3);
    z-index: 10000;
    min-width: 150px;
    overflow: hidden;
  `;

  // æ ¹æ“šä¼‘å‡ç‹€æ…‹é¡¯ç¤ºä¸åŒçš„é¸é …æ–‡å­—
  let leaveText, leaveIcon;
  if (isOnLeave) {
    const source = leaveItem?.source || 'manual';
    leaveIcon = source === 'auto' ? 'ğŸ”„' : 'âœ‹';
    leaveText = `${leaveIcon} å–æ¶ˆä¼‘å‡`;
  } else {
    leaveText = 'âœ‹ è‡¨æ™‚æ¨™è¨˜ä¼‘å‡';
  }

  menu.innerHTML = `
    <div onclick="editPersonName(${index}); closePersonMenu();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: #1976d2; transition: background 0.2s;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='white'">
      âœï¸ ç·¨è¼¯å§“å
    </div>
    <div onclick="toggleLeave('${person.name}'); closePersonMenu();" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #e0e0e0; font-weight: 600; color: ${isOnLeave ? '#1976d2' : '#ff9800'}; transition: background 0.2s;" onmouseover="this.style.background='#e3f2fd'" onmouseout="this.style.background='white'">
      ${leaveText}
    </div>
    <div onclick="removePerson(${index}); closePersonMenu();" style="padding: 12px 16px; cursor: pointer; font-weight: 600; color: #dc3545; transition: background 0.2s;" onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='white'">
      ğŸ—‘ï¸ åˆªé™¤äººå“¡
    </div>
  `;

  // å®šä½é¸å–®
  const rect = event.target.getBoundingClientRect();
  menu.style.top = `${rect.bottom + 5}px`;
  menu.style.left = `${rect.left}px`;

  document.body.appendChild(menu);

  // é»æ“Šå¤–éƒ¨é—œé–‰
  setTimeout(() => {
    document.addEventListener('click', closePersonMenu);
  }, 100);
}

function closePersonMenu() {
  const menu = document.getElementById('personContextMenu');
  if (menu) menu.remove();
  document.removeEventListener('click', closePersonMenu);
}

function renderTemplates() {
  const keys = Object.keys(data.templates);
  const html = keys.length > 0 ? keys.map(key => {
    const t = data.templates[key];
    return `
      <div class="template-item">
        <div class="template-info">
          <div class="template-name">${t.name}</div>
          <div class="template-desc">${t.guardSlots?.length || 0}å€‹æ™‚æ®µã€${t.specialDuties?.length || 0}å€‹è·å‹™ã€${t.vehicles?.filter(v => v.enabled).length || 0}è¼›è»Š</div>
        </div>
        <div class="template-actions">
          <button class="template-btn btn-apply" onclick="applyTemplate('${key}')">å¥—ç”¨</button>
          <button class="template-btn btn-delete" onclick="deleteTemplate('${key}')">åˆªé™¤</button>
        </div>
      </div>
    `;
  }).join('') : '<div class="empty-hint">å°šç„¡å„²å­˜çš„ç¯„æœ¬</div>';
  document.getElementById('templateList').innerHTML = html;
}

function addPerson() {
  const input = document.getElementById('newPersonName');
  const name = input.value.trim();

  if (!name) return;

  // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
  if (data.personnel.find(p => p.name === name)) {
    alert('æ­¤äººå“¡å·²å­˜åœ¨ï¼');
    return;
  }

  // æ–°å¢åˆ° personnel_cache
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];

  const newPerson = {
    name,
    rank: '',
    specialties: [],
    systems: ['service', 'task', 'vacation'], // é è¨­åŠ å…¥æ‰€æœ‰ç³»çµ±
    enabled: true
  };

  allPersonnel.push(newPerson);
  localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));

  // æ›´æ–°æœ¬åœ°è³‡æ–™
  data.personnel.push(newPerson);

  input.value = '';
  save();
  render();
}

function batchAddPersons() {
  const input = document.getElementById('batchPersonNames');
  const names = input.value.split(/[,ï¼Œ]/).map(n => n.trim()).filter(n => n);

  // è¼‰å…¥ personnel_cache
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];

  names.forEach(name => {
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if (data.personnel.find(p => p.name === name)) return;
    if (allPersonnel.find(p => p.name === name)) return;

    const newPerson = {
      name,
      rank: '',
      specialties: [],
      systems: ['service', 'task', 'vacation'], // é è¨­åŠ å…¥æ‰€æœ‰ç³»çµ±
      enabled: true
    };

    allPersonnel.push(newPerson);
    data.personnel.push(newPerson);
  });

  localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));

  input.value = '';
  save();
  render();
}

function editPersonName(index) {
  const oldName = data.personnel[index].name;
  const html = `
    <div class="input-group" style="margin-bottom: 16px;">
      <input type="text" class="input-text" id="editPersonInput" value="${oldName}" style="flex: 1;">
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="confirmEditPerson(${index})">âœ… ç¢ºèªä¿®æ”¹</button>
  `;
  showModal(`ç·¨è¼¯äººå“¡ - ${oldName}`, html);

  // èšç„¦ä¸¦é¸ä¸­æ–‡å­—
  setTimeout(() => {
    const input = document.getElementById('editPersonInput');
    if (input) {
      input.focus();
      input.select();
    }
  }, 100);
}

function confirmEditPerson(index) {
  const person = data.personnel[index];
  const oldName = person.name;
  const newName = document.getElementById('editPersonInput').value.trim();

  if (!newName) {
    alert('å§“åä¸èƒ½ç‚ºç©ºï¼');
    return;
  }

  if (newName === oldName) {
    closeModal();
    return;
  }

  if (data.personnel.find(p => p.name === newName)) {
    alert('æ­¤å§“åå·²å­˜åœ¨ï¼');
    return;
  }

  // æ›´æ–° personnel_cache
  const personnelCache = localStorage.getItem('personnel_cache');
  const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];
  const cacheIndex = allPersonnel.findIndex(p => p.name === oldName);
  if (cacheIndex !== -1) {
    allPersonnel[cacheIndex].name = newName;
    localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));
  }

  // æ›´æ–°æœ¬åœ° personnel ç‰©ä»¶
  person.name = newName;

  // æ›´æ–° onLeave é™£åˆ—
  const leaveItem = data.onLeave.find(item => item.name === oldName);
  if (leaveItem) {
    leaveItem.name = newName;
  }

  // æ›´æ–°æ‰€æœ‰ assignments ä¸­çš„äººå“¡åç¨±
  for (let key in data.assignments) {
    if (data.assignments[key] === oldName) {
      data.assignments[key] = newName;
    }
  }

  // æ›´æ–° signatureItems ä¸­çš„äººå“¡åç¨±
  data.signatureItems.forEach(item => {
    const personIndex = item.people.indexOf(oldName);
    if (personIndex !== -1) {
      item.people[personIndex] = newName;
    }
  });

  save();
  render();
  closeModal();
}

function removePerson(index) {
  const person = data.personnel[index];
  const name = person.name;

  if (confirm(`ç¢ºå®šåˆªé™¤ ${name} å—ï¼Ÿ`)) {
    // å¾ personnel_cache ç§»é™¤
    const personnelCache = localStorage.getItem('personnel_cache');
    const allPersonnel = personnelCache ? JSON.parse(personnelCache) : [];
    const cacheIndex = allPersonnel.findIndex(p => p.name === name);
    if (cacheIndex !== -1) {
      allPersonnel.splice(cacheIndex, 1);
      localStorage.setItem('personnel_cache', JSON.stringify(allPersonnel));
    }

    // å¾æœ¬åœ°è³‡æ–™ç§»é™¤
    data.personnel.splice(index, 1);
    data.onLeave = data.onLeave.filter(item => item.name !== name);
    for (let key in data.assignments) {
      if (data.assignments[key] === name) {
        delete data.assignments[key];
      }
    }
    save();
    render();
  }
}

function toggleLeave(name) {
  const existingIndex = data.onLeave.findIndex(item => item.name === name);

  if (existingIndex !== -1) {
    // å·²åœ¨ä¼‘å‡åˆ—è¡¨ä¸­ï¼Œç§»é™¤
    data.onLeave.splice(existingIndex, 1);
  } else {
    // ä¸åœ¨ä¼‘å‡åˆ—è¡¨ä¸­ï¼Œæ·»åŠ ç‚ºæ‰‹å‹•è‡¨æ™‚æ¨™è¨˜
    data.onLeave.push({ name, source: 'manual' });
  }

  save();
  render();
}

function dragPersonStart(event, person) {
  draggedPerson = person;
  event.target.classList.add('dragging');
}

function dragPersonEnd(event) {
  event.target.classList.remove('dragging');
  draggedPerson = null;
}

// äººå“¡æ’åºæ‹–æ›³åŠŸèƒ½
function dragPersonReorderStart(event, index) {
  draggedPersonIndex = index;
}

function dragPersonReorderEnd(event) {
  draggedPersonIndex = null;
}

function dragPersonReorderOver(event) {
  event.preventDefault();
  event.stopPropagation();
  if (draggedPersonIndex !== null) {
    event.currentTarget.style.borderColor = '#1976d2';
    event.currentTarget.style.borderWidth = '3px';
  }
}

function dragPersonReorderLeave(event) {
  event.currentTarget.style.borderColor = '';
  event.currentTarget.style.borderWidth = '';
}

function dropPersonReorder(event, dropIndex) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.style.borderColor = '';
  event.currentTarget.style.borderWidth = '';

  if (draggedPersonIndex !== null && draggedPersonIndex !== dropIndex) {
    const person = data.personnel.splice(draggedPersonIndex, 1)[0];
    data.personnel.splice(dropIndex, 0, person);
    save();
    render();
  }
}

// è»Šè¼›æ’åºæ‹–æ›³åŠŸèƒ½
function dragVehicleStart(event, index) {
  draggedVehicleIndex = index;
  event.currentTarget.style.opacity = '0.5';
}

function dragVehicleEnd(event) {
  event.currentTarget.style.opacity = '1';
  draggedVehicleIndex = null;
}

function dragVehicleOver(event) {
  event.preventDefault();
  event.stopPropagation();
  if (draggedVehicleIndex !== null) {
    event.currentTarget.style.borderColor = '#ff9800';
    event.currentTarget.style.borderWidth = '3px';
  }
}

function dragVehicleLeave(event) {
  event.currentTarget.style.borderColor = '';
  event.currentTarget.style.borderWidth = '';
}

function dropVehicleReorder(event, dropIndex) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.style.borderColor = '';
  event.currentTarget.style.borderWidth = '';

  if (draggedVehicleIndex !== null && draggedVehicleIndex !== dropIndex) {
    const vehicle = data.vehicles.splice(draggedVehicleIndex, 1)[0];
    data.vehicles.splice(dropIndex, 0, vehicle);
    save();
    render();
  }
}

// ç‰¹æ®Šè·å‹™æ‹–æ›³æ’åºåŠŸèƒ½
function dragSpecialDutyStart(event, index) {
  draggedSpecialDutyIndex = index;
  event.currentTarget.style.opacity = '0.5';
}

function dragSpecialDutyEnd(event) {
  event.currentTarget.style.opacity = '';
  draggedSpecialDutyIndex = null;
}

function dragSpecialDutyOver(event) {
  event.preventDefault();
  if (draggedSpecialDutyIndex !== null) {
    event.currentTarget.style.borderColor = '#ff9800';
  }
}

function dragSpecialDutyLeave(event) {
  event.currentTarget.style.borderColor = '';
}

function dropSpecialDutyReorder(event, dropIndex) {
  event.preventDefault();
  event.currentTarget.style.borderColor = '';

  if (draggedSpecialDutyIndex !== null && draggedSpecialDutyIndex !== dropIndex) {
    const duty = data.specialDuties.splice(draggedSpecialDutyIndex, 1)[0];
    data.specialDuties.splice(dropIndex, 0, duty);
    save();
    render();
  }
}

function allowDrop(event) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.add('drag-over');
}

function dragLeave(event) {
  event.currentTarget.classList.remove('drag-over');
}

function dropPerson(event, slotKey) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  if (draggedPerson && !data.onLeave.includes(draggedPerson)) {
    data.assignments[slotKey] = draggedPerson;
    save();
    render();
  }
}

// æ ¼å­ä¹‹é–“æ‹–æ›³åŠŸèƒ½
function getBlockType(slotKey) {
  if (slotKey.startsWith('guard_')) return 'guard';
  if (slotKey.startsWith('special_')) return 'special';
  if (slotKey.startsWith('vehicle_')) return 'vehicle';
  return null;
}

function startDragSlot(event, fromKey, person) {
  draggedFromSlot = fromKey;
  draggedPerson = person;
  event.target.style.opacity = '0.4';
}

function endDragSlot(event) {
  event.target.style.opacity = '1';
  draggedFromSlot = null;
  draggedPerson = null;
}

function dropOnSlot(event, toKey) {
  event.preventDefault();
  event.stopPropagation();
  event.currentTarget.classList.remove('drag-over');

  // å¦‚æœæ˜¯å¾äººå“¡åˆ—è¡¨æ‹–æ›³ï¼ˆä¸æ˜¯å¾æ ¼å­æ‹–æ›³ï¼‰
  if (!draggedFromSlot && draggedPerson) {
    if (!data.onLeave.includes(draggedPerson)) {
      data.assignments[toKey] = draggedPerson;
      save();
      render();
    }
    return;
  }

  // å¾æ ¼å­æ‹–æ›³åˆ°æ ¼å­
  if (draggedFromSlot && draggedPerson) {
    // æª¢æŸ¥æ˜¯å¦åœ¨åŒä¸€å€‹å€å¡Š
    const fromBlock = getBlockType(draggedFromSlot);
    const toBlock = getBlockType(toKey);

    if (fromBlock !== toBlock) {
      alert('âš ï¸ åªèƒ½åœ¨åŒä¸€å€å¡Šå…§æ‹–æ›³\n\nå®ˆè¡›å‹¤å‹™ â†” å®ˆè¡›å‹¤å‹™\nç‰¹æ®Šå‹¤å‹™ â†” ç‰¹æ®Šå‹¤å‹™\nè»Šè¼› â†” è»Šè¼›ï¼ˆå¯è·¨è»Šï¼‰');
      return;
    }

    // æª¢æŸ¥æ˜¯å¦æ‹–æ›³åˆ°è‡ªå·±
    if (draggedFromSlot === toKey) {
      return;
    }

    const targetPerson = data.assignments[toKey];

    if (targetPerson) {
      // äº¤æ›æ¨¡å¼
      data.assignments[toKey] = draggedPerson;
      data.assignments[draggedFromSlot] = targetPerson;
    } else {
      // ç§»å‹•æ¨¡å¼
      data.assignments[toKey] = draggedPerson;
      delete data.assignments[draggedFromSlot];
    }

    save();
    render();
  }
}

// æª¢æŸ¥äººå“¡å·²åˆ†é…çš„æ‰€æœ‰å´—ä½
function getPersonAssignments(personName) {
  const assignments = [];

  // æª¢æŸ¥è¡›å“¨å‹¤å‹™
  data.guardSlots.forEach(time => {
    data.dutyTypes.forEach((dutyType, idx) => {
      const key = `guard_${time}_${dutyType}_${idx}`;
      if (data.assignments[key] === personName) {
        assignments.push(`${time} ${dutyType}`);
      }
    });
  });

  // æª¢æŸ¥ç‰¹æ®Šå‹¤å‹™
  data.specialDuties.forEach(duty => {
    for (let i = 0; i < duty.count; i++) {
      const key = `special_${duty.name}_${i}`;
      if (data.assignments[key] === personName) {
        assignments.push(duty.name);
      }
    }
  });

  // æª¢æŸ¥è»Šè¼›
  data.vehicles.forEach(vehicle => {
    vehicle.roles.forEach(role => {
      const key = `vehicle_${vehicle.id}_${role}`;
      if (data.assignments[key] === personName) {
        const vehicleName = vehicle.name.split('ï¼ˆ')[0];
        assignments.push(`${vehicleName} ${role}`);
      }
    });
  });

  return assignments;
}

function selectSlot(slotKey) {
  currentSlot = slotKey;
  const available = data.personnel.filter(p => !data.onLeave.includes(p.name));

  // å¾ slotKey æå–å‹¤å‹™é¡å‹ä»¥é€²è¡Œå°ˆé•·ç¯©é¸
  let specialty = null;
  if (slotKey.startsWith('guard_')) {
    // æ ¼å¼: guard_22_å®‰å®˜
    const parts = slotKey.split('_');
    if (parts.length >= 3) {
      specialty = parts[2]; // å®‰å®˜, æµ·å“¨, æˆ– è¡›å“¨
    }
  } else if (slotKey.startsWith('special_')) {
    // æ ¼å¼: special_è»æ¢°_0
    const parts = slotKey.split('_');
    if (parts.length >= 2) {
      specialty = parts[1]; // è»æ¢°ã€å½ˆè—¥ã€æ“šé»é•·ç­‰ç‰¹æ®Šè·å‹™
    }
  } else if (slotKey.includes('è»Šé•·') || slotKey.includes('é§•é§›')) {
    // è»Šè¼›è§’è‰²
    specialty = slotKey.includes('è»Šé•·') ? 'è»Šé•·' : 'é§•é§›';
  }

  let html = '';

  if (specialty) {
    // ä¾å°ˆé•·åˆ†å€é¡¯ç¤º
    const withSpecialty = available.filter(person =>
      person.specialties && person.specialties.includes(specialty)
    );

    const withoutSpecialty = available.filter(person =>
      !person.specialties || !person.specialties.includes(specialty)
    );

    if (withSpecialty.length > 0) {
      html += `<div style="font-size: 14px; font-weight: 700; color: #1976d2; margin-bottom: 8px; padding-left: 4px;">âœ… æœ‰ã€Œ${specialty}ã€å°ˆé•·</div>`;
      html += `<div class="person-selector" style="margin-bottom: 16px;">`;
      html += withSpecialty.map(p => {
        const displayName = getPersonDisplayName(p, 'service');
        const assignments = getPersonAssignments(p.name);
        const badge = assignments.length > 0
          ? `<div style="font-size: 11px; color: #ff9800; margin-top: 4px; cursor: help;" onclick="event.stopPropagation(); alert('å·²æŒ‡æ´¾ä»»å‹™ï¼š\\n\\n${assignments.join('\\n')}')">å·²é¸ ${assignments.length} ğŸ‘ï¸</div>`
          : '';
        return `<div class="selector-item" onclick="assignPerson('${p.name}')" style="display: flex; flex-direction: column; align-items: flex-start; padding: 12px 16px;">
          <div>${displayName}</div>
          ${badge}
        </div>`;
      }).join('');
      html += `</div>`;
    }

    if (withoutSpecialty.length > 0) {
      html += `<div style="font-size: 14px; font-weight: 700; color: #666; margin-bottom: 8px; padding-left: 4px;">âš ï¸ å…¶ä»–äººå“¡</div>`;
      html += `<div class="person-selector">`;
      html += withoutSpecialty.map(p => {
        const displayName = getPersonDisplayName(p, 'service');
        const assignments = getPersonAssignments(p.name);
        const badge = assignments.length > 0
          ? `<div style="font-size: 11px; color: #ff9800; margin-top: 4px; cursor: help;" onclick="event.stopPropagation(); alert('å·²æŒ‡æ´¾ä»»å‹™ï¼š\\n\\n${assignments.join('\\n')}')">å·²é¸ ${assignments.length} ğŸ‘ï¸</div>`
          : '';
        return `<div class="selector-item" onclick="assignPerson('${p.name}')" style="display: flex; flex-direction: column; align-items: flex-start; padding: 12px 16px; opacity: 0.7;">
          <div>${displayName}</div>
          ${badge}
        </div>`;
      }).join('');
      html += `</div>`;
    }

    if (withSpecialty.length === 0 && withoutSpecialty.length === 0) {
      html = '<div style="text-align: center; padding: 20px; color: #999;">ç„¡å¯ç”¨äººå“¡</div>';
    }
  } else {
    // ç„¡å°ˆé•·è¦æ±‚ï¼Œæ­£å¸¸é¡¯ç¤º
    html = `
      <div class="person-selector">
        ${available.map(p => {
          const displayName = getPersonDisplayName(p, 'service');
          const assignments = getPersonAssignments(p.name);
          const badge = assignments.length > 0
            ? `<div style="font-size: 11px; color: #ff9800; margin-top: 4px; cursor: help;" onclick="event.stopPropagation(); alert('å·²æŒ‡æ´¾ä»»å‹™ï¼š\\n\\n${assignments.join('\\n')}')">å·²é¸ ${assignments.length} ğŸ‘ï¸</div>`
            : '';
          return `<div class="selector-item" onclick="assignPerson('${p.name}')" style="display: flex; flex-direction: column; align-items: flex-start; padding: 12px 16px;">
            <div>${displayName}</div>
            ${badge}
          </div>`;
        }).join('')}
      </div>
    `;
  }

  html += `<button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="closeModal()">å–æ¶ˆ</button>`;

  const title = specialty ? `é¸æ“‡äººå“¡ï¼ˆ${specialty}ï¼‰` : 'é¸æ“‡äººå“¡';
  showModal(title, html);
}

function assignPerson(person) {
  if (currentSlot) {
    data.assignments[currentSlot] = person;
    save();
    render();
    closeModal();
  }
}

function clearSlot(key, event) {
  event.stopPropagation();
  delete data.assignments[key];
  delete data.signatureRequired[key];  // åŒæ™‚æ¸…é™¤ç°½åç‹€æ…‹
  save();
  render();
}

function toggleSignatureRequired(key) {
  if (!data.signatureRequired) {
    data.signatureRequired = {};
  }
  data.signatureRequired[key] = !data.signatureRequired[key];
  save();
  render();
}

function updateVehicleInfo(key, value) {
  data.assignments[key] = value;
  save();
  render();
}

function manageTimeSlots() {
  const html = `
    <div class="manage-list">
      ${data.guardSlots.map((time, idx) => `
        <div class="manage-item">
          <div class="manage-item-name">${time}:00</div>
          <button class="btn-icon btn-delete" onclick="removeTimeSlot(${idx})">åˆªé™¤</button>
        </div>
      `).join('')}
    </div>
    <div class="input-group" style="margin-top: 16px;">
      <input type="time" class="input-text" id="newTimeSlot">
      <button class="btn-primary" onclick="addTimeSlot()">â• æ–°å¢</button>
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 12px;" onclick="closeModal()">å®Œæˆ</button>
  `;
  showModal('ç®¡ç†è¡›å“¨æ™‚æ®µ', html);
}

function addTimeSlot() {
  const input = document.getElementById('newTimeSlot');
  const time = input.value;
  if (time) {
    const hour = time.split(':')[0];
    if (!data.guardSlots.includes(hour)) {
      data.guardSlots.push(hour);
      data.guardSlots.sort((a, b) => parseInt(a) - parseInt(b));
      save();
      render();
      manageTimeSlots();
    }
  }
}

function removeTimeSlot(index) {
  const time = data.guardSlots[index];
  if (confirm(`ç¢ºå®šåˆªé™¤ ${time}:00 æ™‚æ®µå—ï¼Ÿ`)) {
    data.guardSlots.splice(index, 1);
    // åˆªé™¤è©²æ™‚æ®µçš„æ‰€æœ‰å‹¤å‹™åˆ†é…
    Object.keys(data.assignments).forEach(key => {
      if (key.startsWith(`guard_${time}_`)) {
        delete data.assignments[key];
      }
    });
    save();
    render();
    manageTimeSlots();
  }
}

function adjustDutyTypes() {
  const html = `
    <div style="margin-bottom: 16px;">
      <h4 style="color: #1976d2; margin-bottom: 12px;">é¸æ“‡é è¨­æ¨¡æ¿ï¼š</h4>
      ${data.dutyTypeTemplates.map(template => `
        <button class="btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="applyDutyTemplate('${template.id}')">
          ${template.name}
        </button>
      `).join('')}
    </div>
    <div style="border-top: 2px solid #e0e0e0; padding-top: 16px; margin-top: 16px;">
      <h4 style="color: #1976d2; margin-bottom: 12px;">ç•¶å‰å‹¤å‹™é¡å‹ï¼š</h4>
      <div class="manage-list" style="margin-bottom: 12px;">
        ${data.dutyTypes.map((type, idx) => `
          <div class="manage-item">
            <div class="manage-item-name">${type}</div>
            <button class="btn-icon btn-delete" onclick="removeDutyType(${idx})">âœ•</button>
          </div>
        `).join('')}
      </div>
      <div class="input-group">
        <select class="input-text" id="newDutyType" style="flex: 1;">
          <option value="å®‰å®˜">å®‰å®˜</option>
          <option value="è¡›å“¨">è¡›å“¨</option>
          <option value="æµ·å“¨">æµ·å“¨</option>
          <option value="custom">è‡ªè¨‚...</option>
        </select>
        <button class="btn-primary" onclick="addDutyType()">â• æ–°å¢</button>
      </div>
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="closeModal()">âœ… å®Œæˆ</button>
  `;
  showModal('èª¿æ•´å‹¤å‹™é¡å‹', html);
}

function applyDutyTemplate(templateId) {
  const template = data.dutyTypeTemplates.find(t => t.id === templateId);
  if (template) {
    data.dutyTypes = [...template.types];
    save();
    render();
    adjustDutyTypes();
  }
}

function addDutyType() {
  const select = document.getElementById('newDutyType');
  let type = select.value;

  if (type === 'custom') {
    type = prompt('è«‹è¼¸å…¥è‡ªè¨‚å‹¤å‹™é¡å‹åç¨±ï¼š');
    if (!type || !type.trim()) return;
    type = type.trim();
  }

  if (type) {
    data.dutyTypes.push(type);
    save();
    render();
    adjustDutyTypes();
  }
}

function removeDutyType(index) {
  if (data.dutyTypes.length <= 1) {
    alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹å‹¤å‹™é¡å‹ï¼');
    return;
  }
  if (confirm(`ç¢ºå®šç§»é™¤ ${data.dutyTypes[index]} å—ï¼Ÿ`)) {
    data.dutyTypes.splice(index, 1);
    save();
    render();
    adjustDutyTypes();
  }
}

function manageSpecialDuties() {
  const html = `
    <div class="manage-list">
      ${data.specialDuties.map((duty, idx) => `
        <div class="manage-item">
          <div class="manage-item-name">${duty.name}</div>
          <div class="manage-item-count">${duty.count}äºº</div>
          <button class="btn-icon btn-edit" onclick="editSpecialDuty(${idx})">ç·¨è¼¯</button>
          <button class="btn-icon btn-delete" onclick="removeSpecialDuty(${idx})">åˆªé™¤</button>
        </div>
      `).join('')}
    </div>
    <div style="margin-top: 16px;">
      <div class="input-group">
        <input type="text" class="input-text" id="newDutyName" placeholder="è·å‹™åç¨±">
        <input type="number" class="input-text" id="newDutyCount" placeholder="äººæ•¸" value="1" min="1" style="max-width: 100px;">
        <button class="btn-primary" onclick="addSpecialDuty()">â• æ–°å¢</button>
      </div>
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 12px;" onclick="closeModal()">å®Œæˆ</button>
  `;
  showModal('ç®¡ç†ç‰¹æ®Šè·å‹™', html);
}

function addSpecialDuty() {
  const name = document.getElementById('newDutyName').value.trim();
  const count = parseInt(document.getElementById('newDutyCount').value) || 1;
  
  if (name) {
    data.specialDuties.push({ name, count });
    save();
    render();
    manageSpecialDuties();
  }
}

function editSpecialDuty(index) {
  const duty = data.specialDuties[index];
  const html = `
    <div class="input-group">
      <input type="text" class="input-text" id="editDutyName" value="${duty.name}">
      <input type="number" class="input-text" id="editDutyCount" value="${duty.count}" min="1" style="max-width: 100px;">
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="saveEditSpecialDuty(${index})">ç¢ºå®š</button>
  `;
  showModal('ç·¨è¼¯è·å‹™', html);
}

function saveEditSpecialDuty(index) {
  const name = document.getElementById('editDutyName').value.trim();
  const count = parseInt(document.getElementById('editDutyCount').value) || 1;
  
  if (name) {
    data.specialDuties[index] = { name, count };
    save();
    render();
    manageSpecialDuties();
  }
}

function removeSpecialDuty(index) {
  const duty = data.specialDuties[index];
  if (confirm(`ç¢ºå®šåˆªé™¤ ${duty.name} å—ï¼Ÿ`)) {
    for (let i = 0; i < duty.count; i++) {
      delete data.assignments[`special_${duty.name}_${i}`];
    }
    data.specialDuties.splice(index, 1);
    save();
    render();
    manageSpecialDuties();
  }
}

function manageVehicles() {
  const html = `
    <div style="display: flex; flex-direction: column; gap: 12px;">
      ${data.vehicles.map((vehicle, idx) => `
        <div class="vehicle-manage-item">
          <div class="vehicle-manage-header">
            <input type="checkbox" ${vehicle.enabled ? 'checked' : ''} onchange="toggleVehicle(${idx})">
            <div class="vehicle-manage-name">${vehicle.name}</div>
            <button class="btn-icon btn-edit" onclick="editVehicle(${idx})">ç·¨è¼¯</button>
            <button class="btn-icon btn-delete" onclick="removeVehicle(${idx})">åˆªé™¤</button>
          </div>
        </div>
      `).join('')}
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="addVehicle()">â• æ–°å¢è»Šè¼›</button>
    <button class="btn-primary" style="width: 100%; margin-top: 8px;" onclick="closeModal()">å®Œæˆ</button>
  `;
  showModal('ç®¡ç†è»Šè¼›', html);
}

function toggleVehicle(index) {
  data.vehicles[index].enabled = !data.vehicles[index].enabled;
  save();
  render();
  manageVehicles();
}

function addVehicle() {
  const html = `
    <div class="input-group" style="flex-direction: column; gap: 12px;">
      <input type="text" class="input-text" id="newVehicleName" placeholder="è»Šè¼›åç¨±ï¼ˆä¾‹å¦‚ï¼šè¼•æˆ°ï¼‰">
      <input type="text" class="input-text" id="newVehicleTime" placeholder="æ™‚é–“ï¼ˆä¾‹å¦‚ï¼š0600-2300ï¼‰" value="0600-2300">
      <input type="text" class="input-text" id="newVehicleMission" placeholder="ä»»å‹™èªªæ˜">
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 12px;" onclick="saveNewVehicle()">ç¢ºå®š</button>
  `;
  showModal('æ–°å¢è»Šè¼›', html);
}

function saveNewVehicle() {
  const name = document.getElementById('newVehicleName').value.trim();
  const time = document.getElementById('newVehicleTime').value.trim();
  const mission = document.getElementById('newVehicleMission').value.trim();
  
  if (name) {
    const newVehicle = {
      id: 'v' + Date.now(),
      name,
      time,
      mission,
      enabled: true,
      roles: ['è»Šé•·', 'é§•é§›']
    };
    data.vehicles.push(newVehicle);
    save();
    render();
    manageVehicles();
  }
}

function editVehicle(index) {
  const vehicle = data.vehicles[index];
  const html = `
    <div class="input-group" style="flex-direction: column; gap: 12px;">
      <input type="text" class="input-text" id="editVehicleName" value="${vehicle.name}">
      <input type="text" class="input-text" id="editVehicleTime" value="${vehicle.time}">
      <input type="text" class="input-text" id="editVehicleMission" value="${vehicle.mission}">
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 12px;" onclick="saveEditVehicle(${index})">ç¢ºå®š</button>
  `;
  showModal('ç·¨è¼¯è»Šè¼›', html);
}

function saveEditVehicle(index) {
  const name = document.getElementById('editVehicleName').value.trim();
  const time = document.getElementById('editVehicleTime').value.trim();
  const mission = document.getElementById('editVehicleMission').value.trim();
  
  if (name) {
    data.vehicles[index].name = name;
    data.vehicles[index].time = time;
    data.vehicles[index].mission = mission;
    save();
    render();
    manageVehicles();
  }
}

function removeVehicle(index) {
  if (confirm('ç¢ºå®šåˆªé™¤æ­¤è»Šè¼›å—ï¼Ÿ')) {
    const vehicle = data.vehicles[index];
    vehicle.roles.forEach(role => {
      delete data.assignments[`vehicle_${vehicle.id}_${role}`];
    });
    data.vehicles.splice(index, 1);
    save();
    render();
    manageVehicles();
  }
}

function saveTemplate() {
  const name = document.getElementById('templateName').value.trim();
  if (!name) {
    alert('è«‹è¼¸å…¥ç¯„æœ¬åç¨±');
    return;
  }
  
  const key = 'tpl_' + Date.now();
  data.templates[key] = {
    name,
    guardSlots: [...data.guardSlots],
    specialDuties: JSON.parse(JSON.stringify(data.specialDuties)),
    vehicles: JSON.parse(JSON.stringify(data.vehicles))
  };
  
  document.getElementById('templateName').value = '';
  save();
  render();
  alert('âœ… ç¯„æœ¬å·²å„²å­˜ï¼');
}

function applyTemplate(key) {
  if (confirm('å¥—ç”¨ç¯„æœ¬æœƒè¦†è“‹ç•¶å‰çš„é…ç½®ï¼ˆä¸åŒ…å«äººå“¡åˆ†é…ï¼‰ï¼Œç¢ºå®šå—ï¼Ÿ')) {
    const t = data.templates[key];
    data.guardSlots = [...t.guardSlots];
    data.specialDuties = JSON.parse(JSON.stringify(t.specialDuties));
    data.vehicles = JSON.parse(JSON.stringify(t.vehicles));
    save();
    render();
    switchTab(0);
    alert('âœ… ç¯„æœ¬å·²å¥—ç”¨ï¼');
  }
}

function deleteTemplate(key) {
  if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç¯„æœ¬å—ï¼Ÿ')) {
    delete data.templates[key];
    save();
    render();
  }
}

function renderSignatureItems() {
  const html = data.signatureItems.map((item, idx) => {
    // è‡ªå‹•åŒæ­¥äººå“¡ï¼ˆè¡›å“¨å’Œè»Šå‹¤ï¼‰
    let displayPeople = [];
    if (item.isAuto) {
      if (item.name === 'è¡›å“¨') {
        // æŠ“å–æ‰€æœ‰å‹¾é¸ã€Œéœ€ç°½åã€çš„è¡›å“¨äººå“¡
        const guardPeople = [];
        data.guardSlots.forEach(time => {
          data.dutyTypes.forEach((dutyType, dtIdx) => {
            const key = `guard_${time}_${dutyType}_${dtIdx}`;
            const person = data.assignments[key];
            const needsSignature = data.signatureRequired?.[key] || false;
            if (person && needsSignature && !guardPeople.includes(person)) {
              guardPeople.push(person);
            }
          });
        });
        displayPeople = guardPeople;
      } else if (item.name === 'è»Šå‹¤') {
        // æŠ“å–æ‰€æœ‰å‹¾é¸ã€Œéœ€ç°½åã€çš„è»Šå‹¤äººå“¡
        const vehiclePeople = [];
        const enabledVehicles = data.vehicles.filter(v => v.enabled);
        enabledVehicles.forEach(vehicle => {
          vehicle.roles.forEach(role => {
            const key = `vehicle_${vehicle.id}_${role}`;
            const person = data.assignments[key];
            const needsSignature = data.signatureRequired?.[key] || false;
            if (person && needsSignature && !vehiclePeople.includes(person)) {
              vehiclePeople.push(person);
            }
          });
        });
        displayPeople = vehiclePeople;
      }
    } else {
      // æ‰‹å‹•é¸äººçš„é …ç›®
      displayPeople = item.people;
    }

    const peopleHtml = displayPeople.length > 0
      ? displayPeople.map((p, pIdx) => `
          <div class="signature-tag">
            ${getDisplayNameForOutput(p)}
            ${!item.isAuto ? `<span class="remove" onclick="removeSignaturePerson(${idx}, ${pIdx})">âœ•</span>` : ''}
          </div>
        `).join('')
      : '';

    const addBtn = item.isAuto
      ? ''
      : `<span class="add-person-btn" style="background: rgba(25, 118, 210, 0.2); color: #1976d2; border-color: #42a5f5; padding: 6px 12px; border-radius: 15px; font-size: 13px; font-weight: 600; cursor: pointer; border: 2px dashed #42a5f5;" onclick="addSignaturePerson(${idx})">â• é¸äºº</span>`;

    return `
      <div class="signature-item" draggable="true"
           ondragstart="dragSignatureItemStart(event, ${idx})"
           ondragover="dragSignatureItemOver(event)"
           ondrop="dropSignatureItem(event, ${idx})"
           ondragend="dragSignatureItemEnd(event)">
        <div class="signature-item-header">
          <div>
            <div class="signature-item-title">
              <span style="cursor: move; margin-right: 8px;">â˜°</span>
              <input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleSignatureItem(${idx})" style="width: 18px; height: 18px; cursor: pointer;">
              ${item.name}${item.isAuto ? ' <span style="font-size: 11px; color: #666;">(è‡ªå‹•åŒæ­¥)</span>' : ''}
            </div>
            <div class="signature-location" onclick="editSignatureLocation(${idx})" style="cursor: pointer;">
              ğŸ“ ${item.location} <span style="font-size: 11px; color: #999;">âœ</span>
            </div>
          </div>
          ${!item.isDefault ? `<button class="btn-icon btn-delete" onclick="deleteSignatureItem(${idx})">åˆªé™¤</button>` : ''}
        </div>
        <div class="signature-people">
          ${peopleHtml}
          ${addBtn}
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('signatureItemsList').innerHTML = html || '<div class="empty-hint">å°šç„¡ç°½åé …ç›®</div>';
}

function toggleSignatureItem(idx) {
  data.signatureItems[idx].enabled = !data.signatureItems[idx].enabled;
  save();
  render();
}

function addSignaturePerson(idx) {
  const onLeaveNames = data.onLeave.map(item => typeof item === 'object' ? item.name : item);
  const available = data.personnel.filter(p => !onLeaveNames.includes(p.name));
  const html = `
    <style>
      .person-sign-selector {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 16px;
      }
      .person-sign-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f5f5f5;
        padding: 12px 16px;
        border-radius: 10px;
        gap: 12px;
      }
      .person-sign-name {
        flex: 1;
        font-size: 15px;
        color: #333;
      }
      .person-sign-checkbox-wrapper {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .person-sign-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }
      .person-sign-label {
        font-size: 13px;
        color: #666;
        user-select: none;
      }
      .sign-select-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
      }
    </style>
    <div class="sign-select-buttons">
      <button class="btn-primary" style="flex: 1; font-size: 13px;" onclick="toggleAllSignatures(true)">âœ… å…¨é¸ç°½å</button>
      <button class="btn-primary" style="flex: 1; font-size: 13px; background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);" onclick="toggleAllSignatures(false)">âŒ å…¨ä¸é¸</button>
    </div>
    <div class="person-sign-selector">
      ${available.map(p => `
        <div class="person-sign-item">
          <span class="person-sign-name">${p.name}</span>
          <div class="person-sign-checkbox-wrapper">
            <span class="person-sign-label">éœ€ç°½å</span>
            <input type="checkbox" class="person-sign-checkbox" data-person="${p.name}">
          </div>
        </div>
      `).join('')}
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="confirmSignaturePeople(${idx})">âœ… ç¢ºèª</button>
  `;
  showModal('é¸æ“‡äººå“¡èˆ‡ç°½åè¨­å®š', html);
}

function toggleAllSignatures(checked) {
  document.querySelectorAll('.person-sign-checkbox').forEach(cb => {
    cb.checked = checked;
  });
}

function confirmSignaturePeople(idx) {
  const checkboxes = document.querySelectorAll('.person-sign-checkbox');
  checkboxes.forEach(cb => {
    const person = cb.dataset.person;
    const needsSignature = cb.checked;

    // å¦‚æœäººå“¡è¢«é¸ä¸­ä¸”éœ€è¦ç°½åï¼ŒåŠ å…¥ç°½åæ¸…å–®
    if (needsSignature && !data.signatureItems[idx].people.includes(person)) {
      data.signatureItems[idx].people.push(person);
    }
  });

  save();
  render();
  closeModal();
}

function selectSignaturePerson(idx, person) {
  // æ­¤å‡½æ•¸å·²è¢« confirmSignaturePeople å–ä»£ï¼Œä¿ç•™ä»¥å…ç ´å£å…¶ä»–å¼•ç”¨
  if (!data.signatureItems[idx].people.includes(person)) {
    data.signatureItems[idx].people.push(person);
    save();
    render();
  }
}

function removeSignaturePerson(itemIdx, personIdx) {
  data.signatureItems[itemIdx].people.splice(personIdx, 1);
  save();
  render();
}

function deleteSignatureItem(idx) {
  if (confirm('ç¢ºå®šåˆªé™¤æ­¤ç°½åé …ç›®å—ï¼Ÿ')) {
    data.signatureItems.splice(idx, 1);
    save();
    render();
  }
}

// æ‹–æ›³æ’åºåŠŸèƒ½
let draggedSignatureItemIndex = null;

function dragSignatureItemStart(event, index) {
  draggedSignatureItemIndex = index;
  event.currentTarget.style.opacity = '0.4';
}

function dragSignatureItemEnd(event) {
  event.currentTarget.style.opacity = '1';
  draggedSignatureItemIndex = null;
}

function dragSignatureItemOver(event) {
  event.preventDefault();
}

function dropSignatureItem(event, dropIndex) {
  event.preventDefault();
  if (draggedSignatureItemIndex !== null && draggedSignatureItemIndex !== dropIndex) {
    const item = data.signatureItems.splice(draggedSignatureItemIndex, 1)[0];
    data.signatureItems.splice(dropIndex, 0, item);
    save();
    render();
  }
}

// ç·¨è¼¯ç°½ååœ°é»
function editSignatureLocation(idx) {
  const item = data.signatureItems[idx];
  const html = `
    <div style="margin-bottom: 16px;">
      <h4 style="color: #1976d2; margin-bottom: 12px;">ä¿®æ”¹ã€Œ${item.name}ã€çš„ç°½ååœ°é»</h4>
      <select class="input-text" id="editLocationSelect" style="width: 100%; margin-bottom: 8px;">
        <option value="å®‰å®˜æ¡Œ" ${item.location === 'å®‰å®˜æ¡Œ' ? 'selected' : ''}>å®‰å®˜æ¡Œ</option>
        <option value="ä¸­å±±å®¤" ${item.location === 'ä¸­å±±å®¤' ? 'selected' : ''}>ä¸­å±±å®¤</option>
        <option value="å…¶ä»–" ${item.location !== 'å®‰å®˜æ¡Œ' && item.location !== 'ä¸­å±±å®¤' ? 'selected' : ''}>å…¶ä»–</option>
      </select>
      <input type="text" class="input-text" id="customLocationInput" placeholder="è¼¸å…¥è‡ªè¨‚åœ°é»" value="${item.location !== 'å®‰å®˜æ¡Œ' && item.location !== 'ä¸­å±±å®¤' ? item.location : ''}" style="width: 100%; display: ${item.location !== 'å®‰å®˜æ¡Œ' && item.location !== 'ä¸­å±±å®¤' ? 'block' : 'none'};">
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="btn-primary" style="flex: 1;" onclick="saveSignatureLocation(${idx})">âœ… ç¢ºå®š</button>
      <button class="btn-primary" style="flex: 1; background: linear-gradient(135deg, #757575 0%, #9e9e9e 100%);" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
  `;
  showModal('ç·¨è¼¯ç°½ååœ°é»', html);

  document.getElementById('editLocationSelect').addEventListener('change', function() {
    const customInput = document.getElementById('customLocationInput');
    if (this.value === 'å…¶ä»–') {
      customInput.style.display = 'block';
    } else {
      customInput.style.display = 'none';
    }
  });
}

function saveSignatureLocation(idx) {
  let location = document.getElementById('editLocationSelect').value;
  if (location === 'å…¶ä»–') {
    const custom = document.getElementById('customLocationInput').value.trim();
    location = custom || 'å…¶ä»–';
  }
  data.signatureItems[idx].location = location;
  save();
  render();
  closeModal();
}

function manageSignatureItems() {
  const itemsList = data.signatureItems.map((item, idx) => {
    const deleteBtn = item.isDefault
      ? ''
      : `<button class="btn-sm" style="background: linear-gradient(135deg, #ef5350 0%, #e53935 100%); color: white;" onclick="deleteSignatureItem(${idx})">åˆªé™¤</button>`;

    return `
      <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <div style="font-weight: 600; color: #1976d2;">${item.name}</div>
          <div style="font-size: 12px; color: #666; margin-top: 4px;">åœ°é»ï¼š${item.location}</div>
        </div>
        ${deleteBtn}
      </div>
    `;
  }).join('');

  const html = `
    <div style="margin-bottom: 16px;">
      <h4 style="color: #1976d2; margin-bottom: 12px;">ç¾æœ‰ç°½åé …ç›®</h4>
      ${itemsList || '<div style="text-align: center; color: #999; padding: 20px;">å°šç„¡é …ç›®</div>'}
    </div>
    <div style="margin-bottom: 16px; border-top: 2px solid #e0e0e0; padding-top: 16px;">
      <h4 style="color: #1976d2; margin-bottom: 12px;">æ–°å¢ç°½åé …ç›®</h4>
      <div class="input-group">
        <input type="text" class="input-text" id="newSignatureItemName" placeholder="é …ç›®åç¨±ï¼ˆä¾‹å¦‚ï¼šæ•´ç†è£å‚™ï¼‰">
      </div>
      <div class="input-group">
        <select class="input-text" id="newSignatureLocation" style="flex: none; width: 150px;">
          <option value="å®‰å®˜æ¡Œ">å®‰å®˜æ¡Œ</option>
          <option value="ä¸­å±±å®¤" selected>ä¸­å±±å®¤</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
        <input type="text" class="input-text" id="customLocation" placeholder="è‡ªè¨‚åœ°é»" style="display: none;">
        <button class="btn-primary" onclick="addSignatureItem()">â• æ–°å¢</button>
      </div>
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="closeModal()">å®Œæˆ</button>
  `;
  showModal('ç®¡ç†ç°½åé …ç›®', html);

  document.getElementById('newSignatureLocation').addEventListener('change', function() {
    const customInput = document.getElementById('customLocation');
    if (this.value === 'å…¶ä»–') {
      customInput.style.display = 'block';
    } else {
      customInput.style.display = 'none';
    }
  });
}

function addSignatureItem() {
  const name = document.getElementById('newSignatureItemName').value.trim();
  let location = document.getElementById('newSignatureLocation').value;

  if (location === 'å…¶ä»–') {
    const custom = document.getElementById('customLocation').value.trim();
    location = custom || 'å…¶ä»–';
  }

  if (name) {
    data.signatureItems.push({
      name,
      location,
      people: [],
      enabled: true,
      isDefault: false
    });
    save();
    render();
    manageSignatureItems();
  }
}

function updateSignatureLocation(value) {
  data.signatureLocation = value || 'ä¸­å±±å®¤';
  save();
  const label = document.getElementById('roomLabel');
  if (label) {
    label.textContent = `${data.signatureLocation}ï¼ˆè»Šå‹¤+å…¶ä»–ï¼‰`;
  }
}

function previewSignature() {
  const result = generateSignatureResult();
  showIOSPreview('ğŸ“‹ å‹¤å‰ç°½åæ¸…å–®', result);
}

function generateSignatureResult() {
  const date = document.getElementById('dateInput').value;
  const [year, month, day] = date.split('-');

  let result = `${month}/${day}å‹¤å‰ç°½åï¼ˆå®Œæˆæ‰“âœ…ï¼‰\n\n`;

  // Get all enabled signature items with their people
  const itemsWithPeople = data.signatureItems
    .filter(item => item.enabled)
    .map(item => {
      let people = [];

      // Auto-sync for è¡›å“¨ and è»Šå‹¤
      if (item.isAuto) {
        if (item.name === 'è¡›å“¨') {
          // Get all guard personnel with éœ€ç°½å checked
          const guardPeople = [];
          data.guardSlots.forEach(time => {
            data.dutyTypes.forEach((dutyType, dtIdx) => {
              const key = `guard_${time}_${dutyType}_${dtIdx}`;
              const person = data.assignments[key];
              const needsSignature = data.signatureRequired?.[key] || false;
              if (person && needsSignature) {
                const displayName = getDisplayNameForOutput(person);
                if (!guardPeople.includes(displayName)) {
                  guardPeople.push(displayName);
                }
              }
            });
          });
          people = guardPeople;
        } else if (item.name === 'è»Šå‹¤') {
          // Get all vehicle personnel with éœ€ç°½å checked
          const vehiclePeople = [];
          const enabledVehicles = data.vehicles.filter(v => v.enabled);
          enabledVehicles.forEach(vehicle => {
            vehicle.roles.forEach(role => {
              const key = `vehicle_${vehicle.id}_${role}`;
              const person = data.assignments[key];
              const needsSignature = data.signatureRequired?.[key] || false;
              if (person && needsSignature) {
                const displayName = getDisplayNameForOutput(person);
                if (!vehiclePeople.includes(displayName)) {
                  vehiclePeople.push(displayName);
                }
              }
            });
          });
          people = vehiclePeople;
        }
      } else {
        // Manual items - use the stored people list
        people = item.people.map(p => getDisplayNameForOutput(p));
      }

      return {
        name: item.name,
        location: item.location,
        people: people
      };
    })
    .filter(item => item.people.length > 0); // Only include items with people

  // Group by location while preserving item order
  const locationGroups = {};
  const locationOrder = [];

  itemsWithPeople.forEach(item => {
    if (!locationGroups[item.location]) {
      locationGroups[item.location] = [];
      locationOrder.push(item.location);
    }
    locationGroups[item.location].push(item);
  });

  // Generate output grouped by location
  locationOrder.forEach(location => {
    result += `ã€${location}ã€‘\n`;
    locationGroups[location].forEach(item => {
      result += `â—† ${item.name}ï¼š\n`;
      item.people.forEach(person => {
        result += `${person}\n`;
      });
      result += '\n';
    });
  });

  return result.trim();
}

// è¼”åŠ©å‡½æ•¸ï¼šå°‡å­˜å„²çš„å…¨åè½‰æ›ç‚ºé¡¯ç¤ºåç¨±ï¼ˆæ ¹æ“šæš±ç¨±è¨­å®šï¼‰
function getDisplayNameForOutput(personName) {
  if (!personName) return '';
  const personObj = data.personnel.find(p => p.name === personName);
  return personObj ? getPersonDisplayName(personObj, 'service') : personName;
}

function generateResult() {
  const date = document.getElementById('dateInput').value;
  const dateObj = new Date(date + 'T00:00:00');
  const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  const [year, month, day] = date.split('-');
  const weekday = weekdays[dateObj.getDay()];

  // ç”Ÿæˆè¡¨é ­ï¼ˆé¡¯ç¤ºå‹¤å‹™é¡å‹ï¼‰
  const headerTypes = data.dutyTypes.map(t => t).join('ã€‚');
  let result = `${month}/${day}ï¼ˆé€±${weekday}ï¼‰è¡›å“¨å‹¤å‹™\n        ${headerTypes}\n`;

  data.guardSlots.forEach(time => {
    const people = [];

    // æŒ‰ç…§ dutyTypes é †åºè®€å–æ¯å€‹å‹¤å‹™é¡å‹çš„äººå“¡
    data.dutyTypes.forEach((dutyType, idx) => {
      const key = `guard_${time}_${dutyType}_${idx}`;
      const personName = data.assignments[key];
      const displayName = personName ? getDisplayNameForOutput(personName) : '    ';
      people.push(displayName);
    });

    result += `${time}ï¼š${people.join('ã€‚')}\n`;
  });
  
  result += '\n';
  
  data.specialDuties.forEach(duty => {
    const people = [];
    for (let i = 0; i < duty.count; i++) {
      const personName = data.assignments[`special_${duty.name}_${i}`];
      if (personName) people.push(getDisplayNameForOutput(personName));
    }
    result += `${duty.name}ï¼š${people.join('/') || ''}\n`;
  });
  
  const enabledVehicles = data.vehicles.filter(v => v.enabled);
  if (enabledVehicles.length > 0) {
    result += '\n';
    enabledVehicles.forEach(vehicle => {
      const timeKey = `vehicle_${vehicle.id}_time`;
      const missionKey = `vehicle_${vehicle.id}_mission`;
      const vehicleTime = data.assignments[timeKey] || vehicle.time;
      const vehicleMission = data.assignments[missionKey] || vehicle.mission;

      result += `${vehicle.name}\næ™‚é–“ï¼š${vehicleTime}\nä»»å‹™ï¼š${vehicleMission}\n`;

      vehicle.roles.forEach(role => {
        const key = `vehicle_${vehicle.id}_${role}`;
        const person = data.assignments[key];
        if (person) {
          result += `${role}ï¼š${person}\n`;
        }
      });

      result += '\n';
    });
  }

  return result;
}

function preview() {
  const result = generateResult();
  showIOSPreview('ğŸ“‹ æ’ç­è¡¨', result);
}

function shareToLine() {
  const result = generateResult();
  const url = `https://line.me/R/share?text=${encodeURIComponent(result)}`;
  window.open(url, '_blank');
}

function showModal(title, content) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalContent').innerHTML = content;
  document.getElementById('modal').classList.add('show');
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
}

window.addEventListener('load', () => {
  init();
});
</script>
</body>
</html>